<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>SLIME: WF</title>
	<link href="..//loader/api/api.css" rel="stylesheet" type="text/css" />
	<script src="..//loader/api/api.js"></script>
	<script>
		//	TODO	CORS
		document.domain = document.domain;
	</script>
</head>
<body>
	<div>
		<h1><code>tools/wf</code></h1>
		<div>
			Scripts may use the <code>wf</code> script to execute commands related to their project lifecycle. The script relies
			on the project directory containing a <code>wf.js</code> file, which is used to implement the commands.
		</div>
		<div>
			The project directory may be specified using the <code>PROJECT</code> environment variable; if this variable is not
			set, the working directory will be used.
		</div>
	</div>
	<div>
		<h1><code>wf.js</code></h1>
		<div>
			The <code>wf.js</code> script provided by the project is an ordinary SLIME module (see the definition of
			<code>module()</code> in the <a href="../loader/api.html">Loader</a> documentation). Each function it exports
			is a command which can be executed by name.
		</div>
		<div>
			If an <code>initialize</code> command is provided, it is executed prior to every command (and should thus be
			idempotent).
		</div>
		<div>
			The module is loaded with the following <code>$context</code>:
			<div class="label">has properties:</div>
			<ul>
				<li class="value">
					<div class="name">base</div>
					<span class="type">directory</span>
					<span>The project directory.</span>
				</li>
			</ul>
		</div>
		<div>
			Commands receive the following argument:
			<div class="label">has properties:</div>
			<ul>
				<li class="object">
					<div class="name">options</div>
					<span>Global options passed to <code>wf</code>. Currently, none are defined.</span>
					<div class="label">has properties:</div>
					<ul>
					</ul>
				</li>
				<li class="value">
					<div class="name">arguments</div>
					<span class="type">string[]</span>
					<span>The set of arguments to the <code>wf</code> command, not including global options.</span>
				</li>
			</ul>
		</div>
	</div>
	<div>
		<h1><code>jsh.wf</code></h1>
		<div>A set of APIs that can be helpful in implementing tasks related to software development.</div>
		<ul>
			<li class="function experimental">
				<div class="name">requireGitIdentity</div>
				<div>
					Errs if the given repository does not supply Git <code>user.name</code> and <code>user.email</code>
					values. Callers may provide an implementation that obtains the configuration values, including a provided
					implementation that prompts the user in a GUI dialog.
				</div>
				<div>
					See <a href="plugin.jsh.d.ts">TypeScript definition</a>.
				</div>
				<script type="application/x.jsapi#tests">
					var directory = jsh.shell.TMPDIR.createTemporary({ directory: true });
					jsh.tools.git.init({ pathname: directory.pathname });
					var unconfigured = jsh.tools.git.Repository({ directory: directory });
					//jsh.wf.requireGitIdentity({ repository: unconfigured });
					//	TODO	could we get this working?:
					//	verify(jsh.wf).requireGitIdentity( ... ).threw.type(Error)
					verify(jsh.wf).evaluate(function() {
						this.requireGitIdentity({ repository: unconfigured });
					}).threw.type(Error);
				</script>
				<script type="application/x.jsapi#tests">
					//	TODO	test callbacks
					var directory = jsh.shell.TMPDIR.createTemporary({ directory: true });
					jsh.tools.git.init({ pathname: directory.pathname });
					var toConfigure = jsh.tools.git.Repository({ directory: directory });
					verify(jsh.wf).evaluate(function() {
						this.requireGitIdentity({
							repository: toConfigure,
							get: {
								name: function(p) {
									return "Marcus Aurelius";
								},
								email: function(p) {
									return "test@example.com";
								}
							}
						});
					}).threw.nothing();
					var config = toConfigure.config({
						arguments: ["--list"]
					});
					jsh.shell.console(JSON.stringify(config));
					verify(config)["user.name"].is("Marcus Aurelius");
					verify(config)["user.email"].is("test@example.com");
				</script>
				<script type="application/x.jsapi#tests">
					var directory = jsh.shell.TMPDIR.createTemporary({ directory: true });
					jsh.tools.git.init({ pathname: directory.pathname });
					var configured = jsh.tools.git.Repository({ directory: directory });
					configured.config({
						arguments: ["user.name", "foo"]
					});
					configured.config({
						arguments: ["user.email", "bar"]
					});
					verify(jsh.wf).evaluate(function() {
						this.requireGitIdentity({ repository: configured });
					}).threw.nothing();
				</script>
			</li>
			<li class="function experimental">
				<div class="name">prohibitUntrackedFiles</div>
				<span>Errs if files untracked by Git are found in the given repository.
					See <a href="plugin.jsh.d.ts">TypeScript definition</a>.
				</span>
			</li>
		</ul>
	</div>
</body>
</html>