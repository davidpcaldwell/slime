<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>SLIME Runtime</title>
	<link rel="stylesheet" type="text/css" href="api/api.css" />
	<script type="text/javascript" src="../loader/api/api.js"></script>
	<style>
	</style>
</head>
<body>
	<h1>Overview</h1>
	<div>
		<h1>Embedding</h1>
		<div>
			<h2>Properties</h2>
			<script type="application/x.jsapi#initialize">
				scope.api = $jsapi.loader.eval("expression.js", {
					$slime: {
						getRuntimeScript: function(path) {
							return {
								name: path,
								js: $jsapi.loader.string(path)
							}
						},
						getCoffeeScript: function() {
							return null;
						}
					},
					$engine: void(0)
				});
				scope.loadTestModule = function(path,context) {
					return $jsapi.loader.module(path,context);
				}
			</script>
			<div class="label">has properties:</div>
			<ul>
				<li class="constructor" jsapi:id="Loader">
					<div class="name"><a name="exports.Loader">Loader</a></div>
					<div class="instances" jsapi:id="type">
						<div class="label">Instances</div>
						<div class="label">has properties:</div>
						<ul>
							<li class="value">
								<div class="name">source</div>
								<span class="type"><a href="#types.Loader.source">source</a></span>
								<span>__DESCRIPTION__</span>
							</li>
							<li class="function">
								<div class="name">get</div>
								<span>Returns the resource associated with a given path, by invoking the <code>get</code> method of this
									loader's <code>source</code>.
								</span>
								<div class="arguments">
									<div class="label">Arguments</div>
									<ol>
										<li class="value">
											<span class="type">string</span>
											<span>A path.</span>
										</li>
									</ol>
								</div>
								<div class="returns">
									<div class="label">Returns</div>
									<span class="type"><a href="#types.Loader.resource">resource</a></span>
									<span>__DESCRIPTION__</span>
								</div>
							</li>
							<li class="function" jsapi:id="run">
								<div class="name"><a name="Loader.run">run</a></div>
								<span jsapi:id="description">
									Executes code in a particular scope with a particular <code>this</code> value. The code will automatically
									contain the <code>$platform</code> and <code>$api</code> objects described above in its scope.
								</span>
								<div class="arguments" jsapi:id="arguments">
									<div class="label">Arguments</div>
									<ol>
										<li class="value">
											<span class="type">string</span>
											<span>The path of the code to execute.</span>
										</li>
										<li class="value" jsapi:id="arguments[1]">
											<span class="type">object</span>
											<span>The scope in which to execute the code.</span>
										</li>
										<li class="value" jsapi:id="arguments[2]">
											<span class="type">object</span>
											<span>The object to use as the <code>this</code> value when executing the code.</span>
										</li>
									</ol>
								</div>
							</li>
							<li class="function" jsapi:id="file">
								<div class="name"><a name="Loader.file">file</a></div>
								<span jsapi:id="description">
									Executes a script in a separate scope. The scope will contain the <code>$platform</code> and <code>$api</code>
									objects described above. In addition, the script will be provided with special objects named
									<code>$context</code> and <code>$exports</code>. The <code>$context</code> object represents an
									application-specific context to provide to the script; the <code>$exports</code> object represents an object to
									which the script can assign properties that will be visible outside the script.
								</span>
								<div class="arguments" jsapi:id="arguments">
									<div class="label">Arguments</div>
									<ol>
										<li class="value">
											<span class="type">string</span>
											<span>The path of the code to execute.</span>
										</li>
										<li class="value" jsapi:id="arguments[1]">
											<span class="type">object</span>
											<span>
												An object to use as the <code>$context</code> object when executing the given code. If absent, an
												empty object will be supplied.
												<!--	TODO	What about if it is a number, string, or boolean?	-->
											</span>
										</li>
										<li class="value" jsapi:id="arguments[2]">
											<span class="type">object</span>
											<span>The object to use as the <code>this</code> value when executing the code.</span>
										</li>
									</ol>
								</div>
								<div class="returns" jsapi:id="returns">
									<div class="label">Returns</div>
									<span class="type">object</span>
									<span>An object which contains the properties the script assigned to the <code>$exports</code> object.</span>
								</div>
							</li>
							<li class="function" jsapi:id="module">
								<div class="name">module</div>
								<div jsapi:id="description">
									<span jsapi:id="summary">
										Loads a module. The module's code is specified by the first argument, and the second argument specifies
										objects to be supplied to the module when loading it.
									</span>
									The module's main file will be executed with the following variables in scope:
									<ul>
										<li>the <code>$platform</code> and <code>$api</code> objects specified above,</li>
										<li>the <code>$context</code> object specified by the second argument,</li>
										<li>an <code>$exports</code> object,</li>
										<li>
											a <code>$loader</code> object of type <a href="#types.Loader">Loader</a> allowing other source
											files and submodules to be loaded.
										</li>
									</ul>
								</div>
								<div class="arguments" jsapi:id="arguments">
									<div class="label">Arguments</div>
									<ol>
										<li class="value">
											<span class="type">string</span>
											<span>The path of the code to execute.</span>
										</li>
										<li class="value" jsapi:id="arguments[1]">
											<span class="type">object</span>
											<span>
												An object to use as the <code>$context</code> object when executing the given code. If absent, an
												empty object will be supplied.
												<!--	TODO	What about if it is a number, string, or boolean?	-->
											</span>
										</li>
										<li class="value" jsapi:id="arguments[2]">
											<span class="type">object</span>
											<span>The object to use as the <code>this</code> value when executing the code.</span>
										</li>
									</ol>
								</div>
								<div class="returns" jsapi:id="returns">
									<div class="label">Returns</div>
									<span class="type">object</span>
									<span>An object containing this module's exports.</span>
								</div>
							</li>
							<li class="function" jsapi:id="value">
								<div class="name"><a id="types.Loader.value">value</a></div>
								<div jsapi:id="description">
									Identical to <code>run</code>, except that the code to execute is supplied with a <code>$set</code>
									function in its scope that allows it to set a value to be returned to the caller:
									<div class="label">has properties:</div>
									<ul>
										<li class="function">
											<div class="name">$set</div>
											<span>Allows the code to return a single value to the caller.</span>
											<div class="arguments">
												<div class="label">Arguments</div>
												<ol>
													<li class="value">
														<span class="type">(any)</span>
														<span>The value to return.</span>
													</li>
												</ol>
											</div>
										</li>
									</ul>
								</div>
								<div class="arguments" jsapi:id="arguments">
									<div class="label">Arguments</div>
									See <a href="#Loader.run">run</a>.
								</div>
								<div class="returns" jsapi:id="returns">
									<div class="label">Returns</div>
									<span class="type">(any)</span>
									<span>
										The value the code to execute passed to <code>$set</code>, or <code>undefined</code> if
										<code>$set</code> was not invoked.
									</span>
								</div>
							</li>
							<li class="function">
								<div class="name">list</div>
								<span>
									(conditional; not present if <code>source.list()</code> not present)
								</span>
								<div class="type">
									<a class="type" name="types.Loader.entry">entry</a>
									<span>__DESCRIPTION__</span>
									<div class="label">has properties:</div>
									<ul>
										<li class="value">
											<div class="name">path</div>
											<span class="type">__TYPE__</span>
											<span>__DESCRIPTION__</span>
										</li>
										<li class="value">
											<div class="name">resource</div>
											<span class="type">__TYPE__</span>
											<span>
												(optional; if the item at <code>path</code> is a resource)
											</span>
										</li>
										<li class="value">
											<div class="name">loader</div>
											<span class="type">__TYPE__</span>
											<span>
												(optional; if the item at <code>path</code> is a loader)
											</span>
										</li>
									</ul>
								</div>
								<div class="arguments">
									<div class="label">Arguments</div>
									<ol>
										<li class="object">
											<div class="label">has properties:</div>
											<ul>
												<li class="function">
													<div class="name">filter</div>
													<span>__DESCRIPTION__</span>
													<div class="arguments">
														<div class="label">Arguments</div>
														<ol>
														</ol>
													</div>
													<div class="returns">
														<div class="label">Returns</div>
														<span class="type">__TYPE__</span>
														<span>__DESCRIPTION__</span>
													</div>
												</li>
												<li class="function">
													<div class="name">descendants</div>
													<span>__DESCRIPTION__</span>
													<div class="arguments">
														<div class="label">Arguments</div>
														<ol>
														</ol>
													</div>
													<div class="returns">
														<div class="label">Returns</div>
														<span class="type">__TYPE__</span>
														<span>__DESCRIPTION__</span>
													</div>
												</li>
											</ul>
										</li>
									</ol>
								</div>
								<div class="returns">
									<div class="label">Returns</div>
									<span class="type">__TYPE__</span>
									<span>__DESCRIPTION__</span>
								</div>
							</li>
						</ul>
					</div>
					<div class="label">has properties:</div>
					<ul>
						<li class="experimental function">
							<div class="name">series</div>
							<span>
								A loader that uses a series of loaders to resolve resources. For a given path, each loader is searched
								in turn until a resource is found.
							</span>
							<div>
								The created loaders currently have the following limitations:
								<!--	TODO	address them	-->
								<ul>
									<li>They are not enumerable</li>
									<li>They do not respect the <code>.child</code> implementations of their elements</li>
									<li>They do not provide a sensible <code>.toString</code> implementation.</li>
								</ul>
							</div>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="value">
										<span class="type">Array</span>
										<span>A list of <code>Loader</code>s</span>
									</li>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">Loader</span>
								<span>A loader that looks up resources in the given list of underlying loaders.</span>
							</div>
						</li>
					</ul>
					<div jsapi:id="tests">
						<script type="application/x.jsapi#initialize"><![CDATA[
							scope.Mock = function recurse() {
								var contents = {};

								this.add = function(path,value) {
									var tokens = path.split("/");
									if (tokens.length == 1) {
										if (typeof(value) == "string") {
											value = (function(string) {
												return {
													read: {
														string: function() { return string; }
													}
												}
											})(value);
										}
										contents[path] = { resource: value };
									} else {
										if (!contents[tokens[0]]) {
											contents[tokens[0]] = { child: new recurse() };
										}
										contents[tokens[0]].child.add(tokens.slice(1).join("/"), value);
									}
								}

								this.loader = new api.Loader({
									get: function(path) {
										var tokens = path.split("/");
										if (tokens.length == 1) {
											debugger;
											return (contents[path]) ? contents[path].resource : null;
										} else {
											if (contents[tokens[0]]) {
												var loader = contents[tokens[0]].child.loader.source;
												if (!loader) {
													throw new Error("No loader at " + tokens[0] + " for " + path);
												}
												if (!loader.get) throw new Error("No loader.get in " + Object.keys(loader));
												return loader.get(tokens.slice(1).join("/"));
											}
											return null;
										}
									},
									list: function(prefix) {
										if (prefix) {
											var tokens = prefix.split("/");
											return contents[tokens[0]].child.loader.source.list(tokens.slice(1).join("/"));
										} else {
											var rv = [];
											for (var x in contents) {
												var item = { path: x, resource: Boolean(contents[x].resource), loader: Boolean(contents[x].child) };
												rv.push(item);
											}
										}
									}
								});
							}
						]]></script>
						<script type="application/x.jsapi#tests">
							var loader = new api.Loader({
								get: function(path) {
									if (path == "a") {
										return {
											string: "a"
										}
									} else if (path == "b/c") {
										return {
											string: "c"
										}
									}
								},
								list: function(prefix) {
									if (prefix == "b/") return [ { path: "c", resource: true } ];
									return [ { path: "a", resource: true }, { path: "b", loader: true } ]
								}
							});
							var listing = loader.list({ descendants: function() { return true; } } );
							verify(listing).length.is(3);
							verify(listing)[0].path.length.is(1);
							verify(listing)[0].path.is("a");
							verify(listing)[1].path.is("b");
							verify(listing)[2].path.is("b/c");
						</script>
						<script type="application/x.jsapi#tests">
							var mock1 = new Mock();
							mock1.add("a", "sa");
							var mock2 = new Mock();
							mock2.add("b/c", "sb/c");
							var series = api.Loader.series([mock1.loader,mock2.loader]);
							verify(series).get("foo").is(null);
							verify(series).get("a").read(String).is("sa");
							verify(series).get("b/c").read(String).is("sb/c");
						</script>
					</div>
				</li>
				<li class="function" jsapi:id="namespace">
					<div class="name"><a id="exports.namespace">namespace</a></div>
					<!--
					TODO	this documentation copied from older version; merge with below

					Creates a <i>namespace</i>, a scope object that has a given position in the global scope. For example, a
					namespace named "inonit.foo.bar" is the <code>bar</code> property of an object which is the <code>foo</code>
					property of another object which is in turn the <code>inonit</code> property of the global object.
					<div>
						If some or all of the named properties exist, the existing ones will be used; they will not be created. Thus, if
						the global object already has an <code>inonit</code> property, and that object has a <code>foo</code> property,
						but the <code>inonit.foo</code> object does not have a <code>bar</code> property, a single object will be
						created and assigned to the <code>bar</code> property of the existing <code>inonit.foo</code> object.
					</div>
					<div class="arguments">
						<div class="label">Arguments</div>
						<ol>
							<li><span class="type">string</span> The name of the namespace to create (or return if it exists).</li>
						</ol>
					</div>
					<div class="returns">
						<div class="label">Returns</div>
						<span class="type">object</span> A namespace located at the given name.
					</div>
					-->
					<span>
						Creates a <i>namespace</i>. A namespace is an object which is globally visible because it is rooted to the
						global object (e.g., <code>window</code> in the browser). So, in the browser, the namespace
						<code>inonit.foo.bar</code> would be an object that is the <code>bar</code> property of an object that is the
						<code>foo</code> property of an object that is the <code>inonit</code> property of <code>window</code>. It could
						be referenced as <code>inonit.foo.bar</code> in JavaScript code, or alternatively as
						<code>window.inonit.foo.bar</code> in the browser.
					</span>
					<p>
						In the event portions of the sequence of rooting objects do not exist, they will be created. So, for example, in
						the browser-based example above, if the <code>window.inonit</code> object exists, but the
						<code>window.inonit</code> object does not have a property named <code>foo</code>, an object will be created
						and assigned to the <code>foo</code> property of <code>window.inonit</code>, and then an object will be created
						and assigned to that object's <code>bar</code> property.
					</p>
					<p>
						If the full sequence of rooting objects exists, the object at the given location will be returned.
					</p>
					<div class="arguments">
						<div class="label">Arguments</div>
						<ol>
							<li class="value">
								<span class="type">string</span>
								<span>The name/location of the namespace to create.</span>
							</li>
						</ol>
					</div>
					<div class="returns">
						<div class="label">Returns</div>
						<span class="type">object</span>
						<span>
							The object at the specified location. The object (and its parents) will be created if it does not
							exist.
						</span>
					</div>
				</li>
				<li class="object">
					<div class="name">java</div>
					<span>The same object as <code>$platform.java</code>.</span>
				</li>
				<li class="object">
					<div class="name">$platform</div>
					<span>The same object as <code>$platform</code>.</span>
				</li>
				<li class="object">
					<div class="name">$api</div>
					<span>An additional way for embedding environments to access the <a href="$api.api.html">$api</a> object.</span>
					<span jsapi:id="$api">See <a href="$api.api.html">detailed documentation</a>.</span>
				</li>
			</ul>
		</div>
	</div>
	<div>
		<h1>Objects provided to loaded code</h1>
		<div>
			The following objects are automatically present in the scope by all code loaded by the SLIME loader.
		</div>
		<div>
			<h2><code>$api</code></h2>
			<p>
				Provides a set of basic JavaScript utilities. See <a href="$api.api.html">detailed documentation</a>.
			</p>
		</div>
		<div jsapi:id="$platform">
			<h2><code>$platform</code></h2>
			<div>
				When code is loaded by the loader, the loader provides the <code>$platform</code> object to that code in the scope.
				The <code>$platform</code> object provides information about
				the underlying JavaScript platform; the loaded code can use this information in its implementation.
			</div>
			<ul>
				<li class="object">
					<div class="name">Object</div>
					<span>An object containing properties describing the platform's capabilities for objects.</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="object">
							<div class="name">defineProperty</div>
							<span>(optional) An object containing properties describing the platform's meta-object capabilities.</span>
							<div class="label">has properties:</div>
							<ul>
								<li class="value">
									<div class="name">ecma</div>
									<span class="type">boolean</span>
									<span>
										(conditional) If <code>true</code>, the platform supports the ECMA-262 version 5
										<code>Object.defineProperty</code> method.
									</span>
								</li>
								<li class="value">
									<div class="name">accessor</div>
									<span class="type">boolean</span>
									<span>
										(conditional) If <code>true</code>, the platform supports <code>__defineGetter__</code> and
										<code>__defineSetter__</code> as defined by Mozilla.
									</span>
								</li>
								<li class="function" jsapi:id="$platform.Object.defineProperty.setReadOnly">
									<div class="name"><a name="$platform.Object.defineProperty.setReadOnly">setReadOnly</a></div>
									<span>(conditional; depends on platform support) Sets whether a named property on an object is read-only.</span>
									<div class="arguments">
										<div class="label">Arguments</div>
										<ol>
											<li class="value">
												<span class="type">object</span>
												<span>An object.</span>
											</li>
											<li class="value">
												<span class="type">string</span>
												<span>The name of a property.</span>
											</li>
											<li class="value">
												<span class="type">boolean</span>
												<span>
													Whether the property should be read-only (<code>true</code>) or writable
													(<code>false</code>).
												</span>
											</li>
										</ol>
									</div>
									<script type="application/x.jsapi#tests"><![CDATA[
										var o = {};
										o.x = 3;
										verify(o).x.is(3);
										o.x = 4;
										verify(o).x.is(4);
										var setReadOnly = (function() {
											if ($platform.Object.defineProperty && $platform.Object.defineProperty.setReadOnly) {
												return $platform.Object.defineProperty.setReadOnly;
											}
										})();
										if (setReadOnly) {
											setReadOnly(o,"x",true);
											o.x = 5;
											verify(o).x.is(4);
											setReadOnly(o,"x",false);
											o.x = 5;
											verify(o).x.is(5);
										}
									]]></script>
								</li>
							</ul>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">java</div>
					<span>(conditional) An object with properties describing the platform's Java/LiveConnect capabilities.</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">getClass</div>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="value">
										<span class="type">string</span>
										<span>A Java class name.</span>
									</li>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">JavaClass</span>
								<span>
									A <code>JavaClass</code> object representing the class with the given name, or <code>null</code>
									if no class by that name can be loaded.
								</span>
							</div>
						</li>
					</ul>
				</li>
				<li class="constructor">
					<div class="name"><a name="$platform.MetaObject">MetaObject</a></div>
					<span>(conditional; depends on platform support) A metaobject implementation.</span>
					<div class="arguments">
						<div class="label">Arguments</div>
						<ol>
							<li class="object">
								<div class="label">has properties:</div>
								<ul>
									<li class="value">
										<div class="name">delegate</div>
										<span class="type">object</span>
										<span>
											A delegate object that will be used to supply implementations for properties in
											preference to using the meta-object implementations.
										</span>
									</li>
									<li class="function">
										<div class="name">get</div>
										<span>
											A function that will be called when one of this object's properties that is not defined
											by the delegate object is accessed. This object will be provided as the <code>this</code>
											argument.
										</span>
										<div class="arguments">
											<div class="label">Arguments</div>
											<ol>
												<li class="value">
													<span class="type">string</span>
													<span>A property name</span>
												</li>
											</ol>
										</div>
										<div class="returns">
											<div class="label">Returns</div>
											<span>A value for the named property.</span>
										</div>
									</li>
									<li class="function">
										<div class="name">set</div>
										<span>
											A function that will be called when one of this object's properties that is not defined by
											the delegate object is set. This object will be provided as the <code>this</code> argument.
										</span>
										<div class="arguments">
											<div class="label">Arguments</div>
											<ol>
												<li class="value">
													<span class="type">string</span>
													<span>A property name.</span>
												</li>
												<li class="value">
													<span>The value assigned to the named property.</span>
												</li>
											</ol>
										</div>
									</li>
								</ul>
							</li>
						</ol>
					</div>
					<div class="instances">
						<div class="label">Instances</div>
						<span class="type">object</span>
						<span>
							Returns an object that uses the given delegate object to supply properties, but uses the given
							getter and setter if the delegate is <code>null</code> or the delegate lacks the named property.
						</span>
					</div>
					<script type="application/x.jsapi#initialize">
						scope.MetaObject = $platform.MetaObject;
					</script>
					<script type="application/x.jsapi#tests" jsapi:id="$platform.MetaObject">
						if ($platform.MetaObject) {
							var doubler = function(name) {
								if (isNaN(Number(name))) {
									return name + name;
								} else {
									return Number(name) * 2;
								}
							}

							var a = new $platform.MetaObject({ get: doubler });
							test( a[1] == 2 );
							test( a.name == "namename" );

							var logger = new function() {
								var log = [];

								this.log = log;

								this.setter = function(name,value) {
									log.push({ target: this, name: name, value: value });

									this[name] = value;
								}
							}

							var $b = {};
							var b = new $platform.MetaObject({ delegate: $b, get: null, set: logger.setter });
							b.foo = "bar";
							test( logger.log[0].target == $b );
							test( logger.log[0].name == "foo" );
							test( logger.log[0].value == "bar" );
						}
					</script>
				</li>
			</ul>
		</div>
	</div>
</body>
</html>
