<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the SLIME loader for web browsers.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2010-2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<html>
<!--
	TODO	does not work when loaded from file system (tested in Google Chrome) because of XMLHttpRequest restrictions; need
			little server running to serve these pages
-->
<head>
	<title>Module Unit Tester</title>
	<style type="text/css">
		div#tree div div { margin: 0em 1em }
		div#log { padding: 1em 0em; background: #c0c0c0 }
	</style>
	<script type="text/javascript" src="../../../coffee-script.js"></script>
	<script type="text/javascript">
		document.domain = document.domain;
		var request = new function() {
			this.query = function(mode) {
				var rv = null;
				if (window.location.search && window.location.search.length > 1) {
					rv = {};
					if (mode && mode.types) {
						for (var x in mode.types) {
							if (mode.types[x] == Array) {
								rv[x] = [];
							}
						}
					}
					var query = window.location.search.substring(1).split("&");
					for (var i=0; i<query.length; i++) {
						var tokens = query[i].split("=");
						var name = tokens[0];
						var value = tokens[1];
						//	Should we always unescape the value?
						var type = (mode && mode.types && mode.types[name]) ? mode.types[name] : String;
						if (type == String) {
							if (!rv[name]) rv[name] = "";
							rv[name] += value;
						} else if (type == Array) {
							rv[name].push(value);
						}
					}
				}
				return rv;
			}
		}
	</script>
	<script type="text/javascript">
		var parameters = request.query({
			types: {
				module: Array
			}
		});
		if (parameters) {
			if (parameters.platform) parameters.platform = unescape(parameters.platform);
			if (parameters.jsapi) parameters.jsapi = unescape(parameters.jsapi);
			for (var i=0; i<parameters.module.length; i++) {
				parameters.module[i] = unescape(parameters.module[i]);
			}
		}
	</script>
	<script type="text/javascript">
		var debug = function(s) {
			if (document.getElementById("debug")) {
				var div = document.createElement("div"); document.getElementById("debug").appendChild(div);
				var pre = document.createElement("pre"); div.appendChild(pre);
				pre.appendChild(document.createTextNode(s));
			} else {
				arguments.callee.buffer.push(s);
			}
		}
		debug.buffer = [];
		debug.flush = function() {
			for (var i=0; i<this.buffer.length; i++) {
				this(this.buffer[i]);
			}
		}
		var inonit = {
			loader: {
				debug: debug,
				modes: {
					module: (parameters) ? parameters["modes.module"] : null,
					execute: (parameters) ? parameters["modes.execute"] : null
				},
				url: (parameters && parameters.platform) ? parameters.platform : "../../../loader/"
			}
		};
		var log = debug;
	</script>
	<script type="text/javascript">
		var callbacks = [];
		var loaded = {
			client: false,
			page: false,
			go: function() {
				if (this.client && this.page) {
					for (var i=0; i<callbacks.length; i++) {
						callbacks[i].call(null);
					}
				}
			}
		};
	</script>
	<script type="text/javascript">
		(function() {
			inonit.loader.callback = function() {
				loaded.client = true;
				loaded.go();
			}
			window.addEventListener("load", function() {
				if (!loaded.page) {
					loaded.page = true;
					loaded.go();
				}
			});
			var script = document.createElement("script");
			script.src = (function() {
				if (parameters && parameters.platform) return parameters.platform + "browser/client.js";
				return "../client.js";
			})();
			if (document.head) {
				document.head.appendChild(script);
			} else {
				//	IE
				document.getElementsByTagName("head")[0].appendChild(script);
			}
		})()
	</script>
	<script type="text/javascript">
		callbacks.push(function() {
			dom = new function() {
				var addChildrenTo = function(rv,e,filter,recurse) {
					for (var i=0; i<e.childNodes.length; i++) {
						if (filter(e.childNodes[i])) {
							rv.push(e.childNodes[i]);
						}
						if (recurse && e.childNodes[i]) {
							addChildrenTo(rv,e.childNodes[i],filter,recurse);
						}
					}
				}

				this.getChild = function(e,filter,recurse) {
					var rv = [];
					addChildrenTo(rv,e,filter,recurse);
					if (rv.length == 0) return null;
					if (rv.length > 1) throw "Multiple elements match filter";
					return rv[0];
				}

				this.getChildren = function(e,filter,recurse) {
					var rv = [];
					addChildrenTo(rv,e,filter,recurse);
					return rv;
				}
			};
		});
	</script>
	<script type="text/javascript">
		callbacks.push(function() {
			html.initialize();
			if (parameters) {
				if (!parameters.jsapi) {
					parameters.jsapi = document.getElementById("jsapi").value;
				}
				if (!parameters.platform) {
					parameters.platform = document.getElementById("platform").value;
				}
				html.setModules(parameters.module);
				document.getElementById("jsapi").value = parameters.jsapi;
				document.getElementById("platform").value = parameters.platform;
				document.getElementById("modes.module").value = parameters["modes.module"];
				document.getElementById("modes.execute").value = parameters["modes.execute"];
				if (parameters.nocatch) {
					document.getElementById("nocatch").checked = true;
				} else {
					document.getElementById("nocatch").checked = false;
				}
				if (parameters.asynchronous) {
					document.getElementById("asynchronous").checked = true;
				} else {
					document.getElementById("asynchronous").checked = false;
				}
			} else {
				document.getElementById("results").style.display = "none";
				document.getElementById("debug").style.display = "none";
			}
			if (parameters) {
				log.flush();
				var jsapi = inonit.loader.file(parameters.jsapi+"unit.before.js", {
					//	TODO	use parameters to create these functions, in the event there are long-running tests
					asynchronous: {
						scenario: function(next) {
							window.setTimeout(next,1);
						}
						,test: function(next) {
							window.setTimeout(next,1);
						}
					}
				});
				var apiHtmlScript = inonit.loader.file(parameters.jsapi+"api.html.js");
				jsapi.Scenario.HALT_ON_EXCEPTION = Boolean(parameters.nocatch);

				var toErrorMessage = function(e) {
					if (e.message) return e.message + " at line " + e.lineNumber + " in " + e.fileName;
					if (typeof(e) == "string") return e;
					return "Unknown error type: " + e;
				}

				var dumpError = function(error,log) {
					if (!log) log = function(){};
					log("Error: " + error);
					if (error.stack) {
						if (error.code) {
							var lines = error.stack.split("\n");
							if (lines[1].substring(0,"    at ".length) == "    at ") {
								var evalFormat = /\(eval at (?:.*), (\S+)\:(\d+)\:(\d+)\)/;
								var match = evalFormat.exec(lines[1]);
								if (match) {
									var lineNumber = match[2];
									var columnNumber = match[3];
									var script = error.code.split("\n");
									var prefix = "";
									for (var i=0; i<columnNumber-1; i++) {
										if (script[lineNumber-1].substring(i,i+1) == "\t") {
											prefix += "\t";
										} else {
											prefix += " ";
										}
									}
									script.splice(Number(match[2]),0,prefix + "^",prefix + error.name + ": " + error.message);
									if (window.console && window.console.log) {
										window.console.log(script.join("\n"));
									}
									return;
								}
							}
							if (window.console && window.console.log) {
								window.console.log(error.code);
							}
							log(error.code);
						}
						if (window.console && window.console.log) {
							window.console.log(error.stack);
						}
						log(error.stack);
					}
					if (error.cause) {
						error.cause.code = error.code;
						arguments.callee(error.cause,log);
					}
				}

				var scenarios = [];
				for (var i=0; i<parameters.module.length; i++) {
					var test = (function() {
						var string = parameters.module[i];
						if (string.indexOf(":") == -1) {
							return { module: string };
						} else {
							var tokens = string.split(":");
							return { module: tokens[0], path: tokens[1] };
						}
					})();
					var module = test.module;
					var location = (function() {
						if (module.substring(module.length-1) == "/") {
							return {
								base: module,
								path: module
							};
						} else {
							return {
								base: module.split("/").slice(0,-1).join("/") + "/",
								main: module.split("/").slice(-1),
								path: module
							};
						}
					})();
					var documentation = (function() {
						if (!location.main) return location.base + "api.html";
						var jsName = /(.*)\.js$/.exec(location.main);
						if (jsName) {
							return location.base + jsName[1] + ".api.html";
						} else {
							//	untested
							return location.base + location.main + ".api.html";
						}
					})();

					(function() {
						var Scope = function(base) {
							var self = this;
							var Self = arguments.callee;

							//	TODO	obsolete?
							this.top = "";

							this.$relative = function(getRelativePath) {
								//	TODO	since this ignores getRelativePath, it almost certainly does not work
								return new Self(base + this.top);
							};

							this.$jsapi = new function() {
								this.loader = new function() {
									this.module = function(path,context) {
										//	TODO	probable bug here; probably works when module path ends in /, but for module path
										//			that has a terminal file name, probably needs to strip that file name to find the
										//			base from which to load the module at 'path'
										return inonit.loader.module(
											base + self.top + path,
											context
										);
									};
									this.file = function(path,context) {
										return inonit.loader.file(
											base + self.top + path,
											context
										);
									};
									this.eval = function(path,scope) {
										if (!scope) scope = {};
										with(scope) {
											return eval(inonit.loader.Loader.getCode(base + self.top + path));
										}
									};
									this.coffee = window.CoffeeScript;

									//	TODO	add this.scenario; see jsh/unit/jsapi.js
								};

								this.disableBreakOnExceptions = function(f) {
									return f;
								}
							};

							this.$platform = inonit.loader.$sdk.platform;
							this.$api = inonit.loader.$sdk.api;
						}

						var getCode = function(e) {
							var rv = "";
							//	IE
							var nodes = (e.childNodes.length) ? e.childNodes : [ { data: e.text } ];
							for (var i=0; i<nodes.length; i++) {
								var data = nodes[i].data;
								if (!data) {
									data = nodes[i].innerHTML;
								}
								if (data) {
									data = data.replace(/\&amp\;/g, "&").replace(/\&lt\;/g, "<");
								}
								rv += data;
							}
							if (/^\<\!\[CDATA\[/.test(rv)) {
								rv = rv.substring("<[!CDATA[".length,rv.length-"]]>".length);
							}
							return rv;
						}

						var DOM = function(base,root) {
							var Element = function(node,parent) {
								this.localName = node.tagName.toLowerCase();

								this.getAttribute = function(name) {
									return node.getAttribute(name);
								}

								this.getJsapiAttribute = function(name) {
									//	Would not work in IE
									return node.getAttribute("jsapi:" + name);
								}

								this.getContentString = function() {
									return getCode(node);
								}

								var wrap = function(node,parent) {
									return new Element(node,parent);
								}

								this.getChildren = function() {
									var rv = [];
									var children = dom.getChildren(node,function(node) {
										return node.nodeType == node.ELEMENT_NODE || node.nodeType == 1;
									});
									for (var i=0; i<children.length; i++) {
										rv[i] = wrap(children[i],this);
									}
									return rv;
								}

								if (parent) {
									this.parent = parent;
								}

								this.$dom = node;

								this.replaceContentWithContentOf = function(other) {
									//	There would be DOM-based ways to do this, but they would require importNode, adoptNode,
									//	something like that; this seems more supported
									this.$dom.innerHTML = other.$dom.innerHTML;
								};

								this.removeJsapiAttribute = function(name) {
									//	TODO	does this work in IE?
									node.removeAttribute("jsapi:" + name);
								};

								//	TODO	Clearly there is no test case that exercises this method. It was added as part of
								//			resolving issues with including one file's content in another: the included file, if
								//			it contains relative path references, needs to somehow know where it came from so that
								//			it can resolve the relative paths relative to itself rather than relative to the file
								//			in which it was included. So probably need a test case on browser side that does that
								//			and then we can implement and fix this. Don't recall specifically, but dimly recall
								//			the object returned by this is supposed to be opaque to generic layers and somehow is
								//			used as a marker somewhere where it is passed back to an implementation-specific method
								//			for use.
								this.getRelativePath = function() {
									throw new Error("Unimplemented: getRelativePath");
								};

								//	Below unverified as to use

								this.toString = function() {
									return node.toString();
								}
							};
							var topElement = (root.documentElement) ? root.documentElement : root;

							this.top = new Element(topElement);
							this.$dom = {
								root: root
							};
							this.load = function(path) {
								return getLoaderApiDom(base+path);
							};
						}

						var getLoaderApiDom = function(location) {
							var unparsed = inonit.loader.$sdk.fetch(location);
							if (false) {
								var div = document.createElement("div");
								//	TODO	there may be a more complex, robust, standards-compliant way of doing this
								//			maybe with DocumentObjectModel or whatever
								div.innerHTML = unparsed;
								var root = (function() {
									for (var i=0; i<div.childNodes.length; i++) {
										if (div.childNodes[i].tagName == "html") {
											return div.childNodes[i];
										}
									}
									//	browser does not preserve html element under div, at least in Chrome, rather putting title
									//	and other body content under div
									return div;
								})();
							} else {
								var doc = document.implementation.createHTMLDocument("");
								//	Added this check for Firefox, for which document.write was not doing the trick
								var didDocWriteWork = (function(doc) {
									var before = new XMLSerializer().serializeToString(doc);
									doc.open();
									doc.write(unparsed);
									//	doc.close() apparently implies window.close() in IE, which causes crash
									//	both Chrome and Firefox seem to work without it
									if (false) doc.close();
									var after = new XMLSerializer().serializeToString(doc);
									return Boolean(before == after);
								})(doc);
								if (!didDocWriteWork) {
									doc.documentElement.innerHTML = unparsed;
								}
								var root = doc;
//								var root = doc.documentElement;
							}
							var base = (function() {
								if (location.substring(location.length-1) == "/") return location;
								return location.split("/").slice(0,-1).join("/") + "/";
							})();
							return new DOM(base,root);
						};

						var loaderApiDom = getLoaderApiDom(documentation);
						var apiHtml = new apiHtmlScript.ApiHtmlTests(loaderApiDom,module);
						var base = (function() {
							var tokens = module.split("/");
							if (tokens[tokens.length-1].length == 0) return module;
							return tokens.slice(0,tokens.length-1).join("/") + "/";
						})();
						var scope = new Scope(base);
						scope.top = (function() {
							//	TODO	it could be that this jsapi:top capability is obsolete, and therefore the $dom member
							//			of DOM is obsolete; possibly this was used before relative paths were used to find
							//			modules being loaded. This would also obsolete the 'top' attribute of scope, which means
							//			Scope would be modified above.
							var find = function(element) {
								var recurse = arguments.callee;
								if (element.tagName && element.tagName.toLowerCase() == "jsapi:top") return element;
								//	IE
								if (element.tagName && element.tagName.toLowerCase() == "top" && element.tagUrn == "http://www.inonit.com/jsapi") return element;
								for (var i=0; i<element.childNodes.length; i++) {
									if (recurse(element.childNodes[i])) {
										return element.childNodes[i];
									}
								}
							};

							var declaration = find(loaderApiDom.$dom.root);
							if (declaration) return declaration.getAttribute("path");
							return "";
						})();
						try {
							var contexts = apiHtml.getContexts(scope);
						} catch (e) {
							if (e.cause) {
								e.cause.code = e.code;
								dumpError(e.cause);
							} else {
								dumpError(e);
							}
							throw e;
						}
						for (var i=0; i<contexts.length; i++) {
							try {
								var object = inonit.loader.module(
									location.path,
									contexts[i]
								);
								scope.module = object;
							} catch (e) {
								//	error loading module, which is OK: sometimes tests do not pertain directly to a module
							}
							scope.context = contexts[i];
							var moduleScenario = apiHtml.getScenario(scope,test.path);
							moduleScenario.name = (test.path) ? (module + ":" + test.path) : module;
							scenarios.push(moduleScenario);
						}
					})();
				}

				var _scenario = {};
				_scenario.name = "Unit Tests";
				_scenario.execute = function(scope) {
					for (var i=0; i<scenarios.length; i++) {
						scope.scenario(scenarios[i]);
					}
				}
				var scenario = new jsapi.Scenario(_scenario);
				var console = new function() {
					var log = function(message) {
						var child = document.createElement("div");
						child.appendChild(document.createTextNode(message));
						document.getElementById("log").appendChild( child );
					}

					var current = document.getElementById("tree");

					this.start = function(scenario) {
						log("Running: " + scenario.name);
						var now = document.createElement("div");
						now.scenario = scenario;
						now.appendChild(document.createTextNode("Running: " + scenario.name));
						current.appendChild(now);
						current = now;
					}

					this.end = function(scenario, success) {
						var result = (success) ? "Passed" : "Failed";
						current.appendChild(document.createTextNode(result + " " + scenario.name))
						current = current.parentNode;
						log("END Scenario: " + scenario.name);
					};

					this.test = function(test) {
						if (test.success) {
							log("Success: " + test + "; " + test.message);
						} else {
							log("Failure: " + test);
							log("Reason: " + test.message);
						}
						if (test.error) {
							dumpError(test.error,log);
						}
						var div = document.createElement("div");
						div.appendChild(document.createTextNode(test.message));
						current.appendChild(div);
					}
				};
				var ASYNCHRONOUS = Boolean(parameters.asynchronous);

				var onResult = (function() {
					if (window.opener
						&& window.opener.inonit
						&& window.opener.inonit.dom
						&& window.opener.inonit.dom.window
						&& window.opener.inonit.dom.window.open
						&& window.opener.inonit.dom.window.open.context
						&& window.opener.inonit.dom.window.open.context.get(window)
						&& window.opener.inonit.dom.window.open.context.get(window).onTestResult
					) {
						return function(success) {
							window.opener.inonit.dom.window.open.context.get(window).onTestResult(success);
						};
					} else if (parameters.callback == "server") {
						return function(success) {
							var req = new inonit.loader.nugget.XMLHttpRequest();
							req.open("POST", "success", false);
							req.send(success);
							//	We do not really care about response code
						};
					} else {
						return function(success) {
							if (!success) {
								alert("Failed!");
							} else {
								alert("PASS");
							}
						};
					}
				})();
				if (ASYNCHRONOUS) {
					scenario.start(console,{
						success: function(success) {
							onResult(success);
						}
					});
				} else {
					var result = scenario.run(console);
					onResult(result);
				}
			}
		});
	</script>
	<script type="text/javascript">
		var html = new function() {
			var isInputNamed = function(name) {
				return function(node) {
					return node.tagName && node.tagName.toLowerCase() == "input" && node.name == name;
				}
			}

			var makeRemovable = function(moduleDiv) {
				var button = dom.getChild(moduleDiv,isInputNamed("remove"));
				button.disabled = false;
				button.onclick = function() {
					button.parentNode.parentNode.removeChild(button.parentNode);
				}
			}

			var addButton;

			var addModule = function(path) {
				var copy = document.getElementById("module").cloneNode(true);
				copy.setAttribute("id", "");
				dom.getChild(copy, isInputNamed("module")).value = (path) ? path : "";
				copy.value = (path) ? path : "";
				makeRemovable(copy);
				document.getElementById("modules").insertBefore(copy,addButton);
			}

			this.initialize = function() {
				addButton = dom.getChild(document.getElementById("modules"), isInputNamed("add"));
				addButton.onclick = function() {
					addModule("");
				}
			}

			this.setModules = function(modules) {
				if (modules.length > 0) {
					var pathInput = dom.getChild(document.getElementById("module"), isInputNamed("module"));
					pathInput.value = modules[0];

					for (var i=1; i<modules.length; i++) {
						addModule(modules[i]);
					}
				}
			}
		}
	</script>
</head>
<body>
	<div id="form">
		<h1>Modules</h1>
		<form action="">
			<div id="modules">
				<h2>Targets</h2>
				<div id="module">
					<input name="module" size="50" type="text" />
					<input type="button" name="remove" value="Remove" disabled="disabled" />
				</div>
				<input type="button" name="add" value="Add" />
			</div>
			<div>
				JSAPI module location: <input id="jsapi" name="jsapi" type="text" size="50" value="../../../loader/api/" />
			</div>
			<div>
				Loader module location: <input id="platform" name="platform" type="text" size="50" value="../../../loader/" />
			</div>
			<div>
				<h2>Modes</h2>
				<select id="modes.module" name="modes.module">
					<option value="evalScope">evalScope</option>
					<option value="evalString">evalString</option>
					<option value="scriptElement">scriptElement</option>
				</select>
				<select id="modes.execute" name="modes.execute">
					<option value="call">call</option>
					<option value="into">into</option>
					<option value="with">with</option>
				</select>
			</div>
			<input id="nocatch" type="checkbox" name="nocatch"/> Halt on Exceptions
			<input id="asynchronous" type="checkbox" name="asynchronous"/> Asynchronous
			<input type="submit" name="submit" value="Run" />
		</form>
	</div>
	<div id="results">
		<h1>Test Results</h1>
		<div id="tree">
		</div>
		<div id="log">
			<h2>Raw log</h2>
		</div>
	</div>
	<div id="debug">
		<h1>Debug Console</h1>
	</div>
</body>
</html>