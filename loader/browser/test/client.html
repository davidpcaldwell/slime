<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the SLIME loader for web browsers.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2010-2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<html>
<!--
	TODO	does not work when loaded from file system (tested in Google Chrome) because of XMLHttpRequest restrictions; need
			little server running to serve these pages
-->
<head>
	<title>Module Unit Tester</title>
	<style type="text/css">
		div#tree div div { margin: 0em 1em }
		div#log { padding: 1em 0em; background: #c0c0c0 }
	</style>
	<script type="text/javascript" src="../../../coffee-script.js"></script>
	<script type="text/javascript">
		document.domain = document.domain;
		var request = new function() {
			this.query = function(mode) {
				var rv = null;
				if (window.location.search && window.location.search.length > 1) {
					rv = {};
					if (mode && mode.types) {
						for (var x in mode.types) {
							if (mode.types[x] == Array) {
								rv[x] = [];
							}
						}
					}
					var query = window.location.search.substring(1).split("&");
					for (var i=0; i<query.length; i++) {
						var tokens = query[i].split("=");
						var name = tokens[0];
						var value = tokens[1];
						//	Should we always unescape the value?
						var type = (mode && mode.types && mode.types[name]) ? mode.types[name] : String;
						if (type == String) {
							if (!rv[name]) rv[name] = "";
							rv[name] += value;
						} else if (type == Array) {
							rv[name].push(value);
						}
					}
				}
				return rv;
			}
		}
	</script>
	<script type="text/javascript">
		var parameters = request.query({
			types: {
				module: Array
			}
		});
		if (parameters) {
			if (parameters.platform) parameters.platform = unescape(parameters.platform);
			if (parameters.jsapi) parameters.jsapi = unescape(parameters.jsapi);
			for (var i=0; i<parameters.module.length; i++) {
				parameters.module[i] = unescape(parameters.module[i]);
			}
			if (!window.inonit) window.inonit = {};
			if (!inonit.loader) inonit.loader = {};
			if (!inonit.loader.$slime) inonit.loader.$slime = {};
			if (!inonit.loader.$slime.flags) inonit.loader.$slime.flags = {};
			var flagPattern = /^SLIME_(.*)$/;
			for (var x in parameters) {
				var match = flagPattern.exec(x);
				if (match) {
					var name = match[1];
					var value = parameters[x];
					inonit.loader.$slime.flags[name] = value;
				}
			}
		}
	</script>
	<script type="text/javascript">
		var debug = function(s) {
			if (document.getElementById("debug")) {
				var div = document.createElement("div"); document.getElementById("debug").appendChild(div);
				var pre = document.createElement("pre"); div.appendChild(pre);
				pre.appendChild(document.createTextNode(s));
			} else {
				arguments.callee.buffer.push(s);
			}
		}
		debug.buffer = [];
		debug.flush = function() {
			for (var i=0; i<this.buffer.length; i++) {
				this(this.buffer[i]);
			}
		}
		if (!window.inonit) window.inonit = {};
		if (!inonit.loader) inonit.loader = {};
		inonit.loader.debug = debug;
		inonit.loader.modes = {
			module: (parameters) ? parameters["modes.module"] : null,
			execute: (parameters) ? parameters["modes.execute"] : null			
		};
		inonit.loader.url = (parameters && parameters.platform) ? parameters.platform : window.location.protocol + "//" + window.location.host + window.location.pathname + "/../../../../loader/";
		var log = debug;
	</script>
	<script type="text/javascript">
		var callbacks = [];
		var loaded = {
			client: false,
			page: false,
			go: function() {
				if (this.client && this.page) {
					for (var i=0; i<callbacks.length; i++) {
						callbacks[i].call(null);
					}
				}
			}
		};
	</script>
	<script type="text/javascript">
		(function getLoader() {
			inonit.loader.callback = function() {
				//	TODO	make the below a boolean parameter
				if (parameters.allowDeprecated) {
					inonit.loader.$api.deprecate.warning = function(){}();
				}
				loaded.client = true;
				loaded.go();
			}
			window.addEventListener("load", function() {
				if (!loaded.page) {
					loaded.page = true;
					loaded.go();
				}
			});
			var script = document.createElement("script");
			script.src = (function() {
				if (parameters && parameters.platform) return parameters.platform + "browser/client.js";
				return "../client.js";
			})();
			if (document.head) {
				document.head.appendChild(script);
			} else {
				//	IE
				document.getElementsByTagName("head")[0].appendChild(script);
			}
		})()
	</script>
	<script type="text/javascript">
		callbacks.push(function() {
			dom = new function() {
				var addChildrenTo = function(rv,e,filter,recurse) {
					for (var i=0; i<e.childNodes.length; i++) {
						if (filter(e.childNodes[i])) {
							rv.push(e.childNodes[i]);
						}
						if (recurse && e.childNodes[i]) {
							addChildrenTo(rv,e.childNodes[i],filter,recurse);
						}
					}
				}

				this.getChild = function(e,filter,recurse) {
					var rv = [];
					addChildrenTo(rv,e,filter,recurse);
					if (rv.length == 0) return null;
					if (rv.length > 1) throw "Multiple elements match filter";
					return rv[0];
				}

				this.getChildren = function(e,filter,recurse) {
					var rv = [];
					addChildrenTo(rv,e,filter,recurse);
					return rv;
				}
			};
		});
	</script>
	<script type="text/javascript" src="client.js"></script>
	<script type="text/javascript">
		var html = new function() {
			var isInputNamed = function(name) {
				return function(node) {
					return node.tagName && node.tagName.toLowerCase() == "input" && node.name == name;
				}
			}

			var makeRemovable = function(moduleDiv) {
				var button = dom.getChild(moduleDiv,isInputNamed("remove"));
				button.disabled = false;
				button.onclick = function() {
					button.parentNode.parentNode.removeChild(button.parentNode);
				}
			}

			var addButton;

			var addModule = function(path) {
				var copy = document.getElementById("module").cloneNode(true);
				copy.setAttribute("id", "");
				dom.getChild(copy, isInputNamed("module")).value = (path) ? path : "";
				copy.value = (path) ? path : "";
				makeRemovable(copy);
				document.getElementById("modules").insertBefore(copy,addButton);
			}

			this.initialize = function() {
				addButton = dom.getChild(document.getElementById("modules"), isInputNamed("add"));
				addButton.onclick = function() {
					addModule("");
				}
			}

			this.setModules = function(modules) {
				if (modules.length > 0) {
					var pathInput = dom.getChild(document.getElementById("module"), isInputNamed("module"));
					pathInput.value = modules[0];

					for (var i=1; i<modules.length; i++) {
						addModule(modules[i]);
					}
				}
			}
		}
	</script>
</head>
<body>
	<div id="form">
		<h1>Modules</h1>
		<form action="">
			<div id="modules">
				<h2>Targets</h2>
				<div id="module">
					<input name="module" size="50" type="text" />
					<input type="button" name="remove" value="Remove" disabled="disabled" />
				</div>
				<input type="button" name="add" value="Add" />
			</div>
			<div>
				JSAPI module location: <input id="jsapi" name="jsapi" type="text" size="50" value="../../../loader/api/" />
			</div>
			<div>
				Loader module location: <input id="platform" name="platform" type="text" size="50" value="../../../loader/" />
			</div>
			<div>
				<h2>Modes</h2>
				<select id="modes.module" name="modes.module">
					<option value="evalScope">evalScope</option>
					<option value="evalString">evalString</option>
					<option value="scriptElement">scriptElement</option>
				</select>
				<select id="modes.execute" name="modes.execute">
					<option value="call">call</option>
					<option value="into">into</option>
					<option value="with">with</option>
				</select>
			</div>
			<input id="nocatch" type="checkbox" name="nocatch"/> Halt on Exceptions
			<input id="asynchronous" type="checkbox" name="asynchronous"/> Asynchronous
			<input type="submit" name="submit" value="Run" />
		</form>
	</div>
	<div id="results">
		<h1>Test Results</h1>
		<div id="tree">
		</div>
		<div id="log">
			<h2>Raw log</h2>
		</div>
	</div>
	<div id="debug">
		<h1>Debug Console</h1>
	</div>
</body>
</html>