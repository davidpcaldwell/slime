<!--
LICENSE
The contents of this file are subject to the Mozilla Public License Version 1.1 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the License at http://www.mozilla.org/MPL/

Software distributed under the License is distributed on an "AS IS" basis, WITHOUT WARRANTY OF ANY KIND, either
express or implied. See the License for the specific language governing rights and limitations under the License.

The Original Code is the SLIME loader for web browsers.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2010 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<html>
<head>
	<title>Module Unit Tester</title>
	<style type="text/css">
		div#tree div div { margin: 0em 1em }
		div#log { padding: 1em 0em; background: #c0c0c0 }
	</style>
	<script type="text/javascript">
		var request = new function() {
			this.query = function(mode) {
				var rv = null;
				if (window.location.search && window.location.search.length > 1) {
					rv = {};
					if (mode && mode.types) {
						for (var x in mode.types) {
							if (mode.types[x] == Array) {
								rv[x] = [];
							}
						}
					}
					var query = window.location.search.substring(1).split("&");
					for (var i=0; i<query.length; i++) {
						var tokens = query[i].split("=");
						var name = tokens[0];
						var value = tokens[1];
						//	Should we always unescape the value?
						var type = (mode && mode.types && mode.types[name]) ? mode.types[name] : String;
						if (type == String) {
							if (!rv[name]) rv[name] = "";
							rv[name] += value;
						} else if (type == Array) {
							rv[name].push(value);
						}
					}
				}
				return rv;
			}
		}
	</script>
	<script type="text/javascript">
		var parameters = request.query({
			types: {
				module: Array
			}
		})
		if (parameters.platform) parameters.platform = unescape(parameters.platform);
		if (parameters.jsapi) parameters.jsapi = unescape(parameters.jsapi);
		for (var i=0; i<parameters.module.length; i++) {
			parameters.module[i] = unescape(parameters.module[i]);
		}
	</script>
	<script type="text/javascript">
		var debug = function(s) {
			if (document.getElementById("debug")) {
				var div = document.createElement("div"); document.getElementById("debug").appendChild(div);
				var pre = document.createElement("pre"); div.appendChild(pre);
				pre.appendChild(document.createTextNode(s));
			} else {
				arguments.callee.buffer.push(s);
			}
		}
		debug.buffer = [];
		debug.flush = function() {
			for (var i=0; i<this.buffer.length; i++) {
				this(this.buffer[i]);
			}
		}
		var inonit = {
			loader: {
				debug: debug,
				modes: {
					module: parameters["modes.module"],
					execute: parameters["modes.execute"]
				},
				url: (parameters && parameters.platform) ? parameters.platform : "../../../loader/"
			}
		};
		var log = debug;
	</script>
	<script type="text/javascript" src="../client.js"></script>
	<script type="text/javascript">
		var dom = new function() {
			var addChildrenTo = function(rv,e,filter,recurse) {
				for (var i=0; i<e.childNodes.length; i++) {
					if (filter(e.childNodes[i])) {
						rv.push(e.childNodes[i]);
					}
					if (recurse && e.childNodes[i]) {
						addChildrenTo(rv,e.childNodes[i],filter,recurse);
					}
				}
			}

			this.getChild = function(e,filter,recurse) {
				var rv = [];
				addChildrenTo(rv,e,filter,recurse);
				if (rv.length == 0) return null;
				if (rv.length > 1) throw "Multiple elements match filter";
				return rv[0];
			}

			this.getChildren = function(e,filter,recurse) {
				var rv = [];
				addChildrenTo(rv,e,filter,recurse);
				return rv;
			}
		}
	</script>
	<script type="text/javascript">
		window.onload = function() {
			html.initialize();
			if (parameters) {
				if (!parameters.jsapi) {
					parameters.jsapi = document.getElementById("jsapi").value;
				}
				if (!parameters.platform) {
					parameters.platform = document.getElementById("platform").value;
				}
				html.setModules(parameters.module);
				document.getElementById("jsapi").value = parameters.jsapi;
				document.getElementById("platform").value = parameters.platform;
				document.getElementById("modes.module").value = parameters["modes.module"];
				document.getElementById("modes.execute").value = parameters["modes.execute"];
				if (parameters.nocatch) {
					document.getElementById("nocatch").checked = true;
				} else {
					document.getElementById("nocatch").checked = false;
				}
				if (parameters.asynchronous) {
					document.getElementById("asynchronous").checked = true;
				} else {
					document.getElementById("asynchronous").checked = false;
				}
			} else {
				document.getElementById("results").style.display = "none";
				document.getElementById("debug").style.display = "none";
			}
			if (parameters) {
				log.flush();
				var jsapi = inonit.loader.file(parameters.jsapi+"unit.before.js", {
					//	TODO	use parameters to create these functions, in the event there are long-running tests
					asynchronous: {
						scenario: function(next) {
							window.setTimeout(next,1);
						}
						,test: function(next) {
							window.setTimeout(next,1);
						}
					}
				});
				var apiHtmlScript = inonit.loader.file(parameters.jsapi+"api.html.js");
				jsapi.Scenario.HALT_ON_EXCEPTION = Boolean(parameters.nocatch);
	
				var toErrorMessage = function(e) {
					if (e.message) return e.message + " at line " + e.lineNumber + " in " + e.fileName;
					if (typeof(e) == "string") return e;
					return "Unknown error type: " + e;
				}
	
				var scenarios = [];
				for (var i=0; i<parameters.module.length; i++) {
					var test = (function() {
						var string = parameters.module[i];
						if (string.indexOf(":") == -1) {
							return { module: string };
						} else {
							var tokens = string.split(":");
							return { module: tokens[0], path: tokens[1] };
						}
					})();
					var module = test.module;
					var location = (function() {
						if (module.substring(module.length-1) == "/") {
							return {
								base: module
							};
						} else {
							return {
								base: module.split("/").slice(0,-1).join("/") + "/",
								main: module.split("/").slice(-1)
							};
						}
					})();
					var documentation = (function() {
						if (!location.main) return location.base + "api.html";
						var jsName = /(.*)\.js$/.exec(location.main);
						if (jsName) {
							return location.base + jsName[1] + ".api.html";
						} else {
							//	untested
							return location.base + location.main + ".api.html";
						}
					})();
					var unparsed = inonit.loader.$sdk.fetch(documentation);
					var div = document.createElement("div");
					//	TODO	there may be a more complex, robust, standards-compliant way of doing this
					//			maybe with DocumentObjectModel or whatever
					div.innerHTML = unparsed;

					(function() {
						var Scope = function() {
							var self = this;
				
							this.$jsapi = new function() {
								this.module = function(path,context) {
									return inonit.loader.module(
										{ base: module + self.top + path },
										context
									);
								}
							};

							this.$platform = inonit.loader.$sdk.platform;
							this.$api = inonit.loader.$sdk.api;
						}

						var getCode = function(e) {
							var rv = "";
							//	IE
							var nodes = (e.childNodes.length) ? e.childNodes : [ { data: e.text } ];
							for (var i=0; i<nodes.length; i++) {
								var data = nodes[i].data;
								data = data.replace(/\&amp\;/g, "&").replace(/\&lt\;/g, "<");
								rv += data;
							}
							if (/^\<\!\[CDATA\[/.test(rv)) {
								rv = rv.substring("<[!CDATA[".length,rv.length-"]]>".length);
							}
							return rv;
						}

						var DOM = function(html) {
							var Element = function(node) {
								this.localName = node.tagName.toLowerCase();
					
								if (node != html) {
									this.parent = new arguments.callee(node.parentNode);
								}
					
								this.toString = function() {
									return node.toString();
								}

								this.getContentString = function() {
									return getCode(node);
								}

								var getScriptFilter = function(type) {
									if (!type) {
										return function(node) {
											return node.tagName && node.tagName.toLowerCase() == "script";
										};
									} else {
										return function(node) {
											return node.tagName && node.tagName.toLowerCase() == "script" && node.type == (apiHtmlScript.MEDIA_TYPE + "#" + type);
										};
									}							
								}

								var wrap = function(node) {
									return new Element(node);
								}
					
								this.getScripts = function(type) {
									var rv = [];
									var children = dom.getChildren(node,getScriptFilter(type));
									for (var i=0; i<children.length; i++) {
										rv[i] = wrap(children[i]);
									}
									return rv;
								}

								this.getDescendantScripts = function(type) {
									var rv = [];
									var children = dom.getChildren(node,getScriptFilter(type),true);
									for (var i=0; i<children.length; i++) {
										rv[i] = wrap(children[i]);
									}
									return rv;
								}

								this.getChildElements = function() {
									var rv = [];
									var children = dom.getChildren(node,function(node) {
										return node.nodeType == node.ELEMENT_NODE || node.nodeType == 1;
									});
									for (var i=0; i<children.length; i++) {
										rv[i] = wrap(children[i]);
									}
									return rv;
								}
					
								var wrapArray = function(array) {
									var rv = [];
									for (var i=0; i<array.length; i++) {
										rv[i] = wrap(array[i]);
									}
									return rv;
								}

								this.getScriptType = function() {
									return node.type;
								}

								this.isTop = function() {
									return node == html;
								}

								this.getJsapiId = function() {
									//	Would not work in IE
									return node.getAttribute("jsapi:id");
								}

								this.getNameDiv = function() {
									var children = dom.getChildren(node,function(node) {
										return node.tagName && node.tagName.toLowerCase() == "div" && node.getAttribute("class") == "name";
									});
									var target = wrapArray(children);
									if (target.length == 0) return null;
									return target[0].innerHTML;
								}
							}

							this.top = new Element(html);
						}

						var root = (function() {
							for (var i=0; i<div.childNodes.length; i++) {
								if (div.childNodes[i].tagName == "html") {
									return div.childNodes[i];
								}
							}
							//	browser does not preserve html element under div, at least in Chrome, rather putting title
							//	and other body content under div
							return div;
						})();
						var apiHtml = new apiHtmlScript.ApiHtmlTests(new DOM(root),module);
						var scope = new Scope();
						scope.top = (function() {
							var find = function(element) {
								var recurse = arguments.callee;
								if (element.tagName && element.tagName.toLowerCase() == "jsapi:top") return element;
								//	IE
								if (element.tagName && element.tagName.toLowerCase() == "top" && element.tagUrn == "http://www.inonit.com/jsapi") return element;
								for (var i=0; i<element.childNodes.length; i++) {
									if (recurse(element.childNodes[i])) {
										return element.childNodes[i];
									}
								}
							};
				
							var declaration = find(root);
							if (declaration) return declaration.getAttribute("path");
							return "";
						})();
						var contexts = apiHtml.getContexts(scope);
						for (var i=0; i<contexts.length; i++) {
							try {
								var object = inonit.loader.module(
									location,
									contexts[i]
								);
								scope.module = object;
							} catch (e) {
								//	error loading module, which is OK: sometimes tests do not pertain directly to a module
								debugger;
							}
							scope.context = contexts[i];
							var moduleScenario = apiHtml.getScenario(scope,test.path);
							moduleScenario.name = (test.path) ? (module + ":" + test.path) : module;
							scenarios.push(moduleScenario);
						}
					})();
				}

				var _scenario = {};
				_scenario.name = "Unit Tests";
				_scenario.execute = function(scope) {
					for (var i=0; i<scenarios.length; i++) {
						scope.scenario(scenarios[i]);
					}
				}
				var scenario = new jsapi.Scenario(_scenario);
				var console = new function() {
					var log = function(message) {
						var child = document.createElement("div");
						child.appendChild(document.createTextNode(message));
						document.getElementById("log").appendChild( child );
					}

					var current = document.getElementById("tree");

					this.start = function(scenario) {
						log("Running: " + scenario.name);
						var now = document.createElement("div");
						now.scenario = scenario;
						now.appendChild(document.createTextNode("Running: " + scenario.name));
						current.appendChild(now);
						current = now;
					}

					this.end = function(scenario, success) {
						var result = (success) ? "Passed" : "Failed";
						current.appendChild(document.createTextNode(result + " " + scenario.name))
						current = current.parentNode;
						log("END Scenario: " + scenario.name);
					}

					this.test = function(test) {
						if (test.success) {
							log("Success: " + test + "; " + test.messages.success);
						} else {
							log("Failure: " + test);
							log("Reason: " + test.messages.failure);
						}
						var div = document.createElement("div");
						if (test.success) {
							div.appendChild(document.createTextNode(test.messages.success));
						} else {
							div.appendChild(document.createTextNode(test.messages.failure));
						}
						current.appendChild(div);
					}
				};
				var ASYNCHRONOUS = Boolean(parameters.asynchronous);
	
				var onResult = function(success) {
					if (!success) {
						alert("Failed!");
					} else {
						alert("PASS");
					}
				}
				if (ASYNCHRONOUS) {
					scenario.start(console,{
						success: function(success) {
							onResult(success);
						}
					});
				} else {
					var result = scenario.run(console);
					onResult(result);
				}
			}
		}
	</script>
	<script type="text/javascript">
		var html = new function() {
			var isInputNamed = function(name) {
				return function(node) {
					return node.tagName && node.tagName.toLowerCase() == "input" && node.name == name;
				}
			}

			var makeRemovable = function(moduleDiv) {
				var button = dom.getChild(moduleDiv,isInputNamed("remove"));
				button.disabled = false;
				button.onclick = function() {
					button.parentNode.parentNode.removeChild(button.parentNode);
				}
			}

			var addButton;

			var addModule = function(path) {
				var copy = document.getElementById("module").cloneNode(true);
				copy.setAttribute("id", "");
				dom.getChild(copy, isInputNamed("module")).value = (path) ? path : "";
				copy.value = (path) ? path : "";
				makeRemovable(copy);
				document.getElementById("modules").insertBefore(copy,addButton);
			}

			this.initialize = function() {
				addButton = dom.getChild(document.getElementById("modules"), isInputNamed("add"));
				addButton.onclick = function() {
					addModule("");
				}
			}

			this.setModules = function(modules) {
				if (modules.length > 0) {
					var pathInput = dom.getChild(document.getElementById("module"), isInputNamed("module"));
					pathInput.value = modules[0];

					for (var i=1; i<modules.length; i++) {
						addModule(modules[i]);
					}
				}
			}
		}
	</script>
</head>
<body>
	<div id="form">
		<h1>Modules</h1>
		<form action="">
			<div id="modules">
				<h2>Targets</h2>
				<div id="module">
					<input name="module" size="50" type="text" />
					<input type="button" name="remove" value="Remove" disabled="disabled" />
				</div>
				<input type="button" name="add" value="Add" />
			</div>
			<div>
				JSAPI module location: <input id="jsapi" name="jsapi" type="text" size="50" value="../../../loader/api/" />
			</div>
			<div>
				Loader module location: <input id="platform" name="platform" type="text" size="50" value="../../../loader/" />
			</div>
			<div>
				<h2>Modes</h2>
				<select id="modes.module" name="modes.module">
					<option value="evalScope">evalScope</option>
					<option value="evalString">evalString</option>
					<option value="scriptElement">scriptElement</option>
				</select>
				<select id="modes.execute" name="modes.execute">
					<option value="call">call</option>
					<option value="into">into</option>
					<option value="with">with</option>
				</select>
			</div>
			<input id="nocatch" type="checkbox" name="nocatch"/> Halt on Exceptions
			<input id="asynchronous" type="checkbox" name="asynchronous"/> Asynchronous
			<input type="submit" name="submit" value="Run" />
		</form>
	</div>
	<div id="results">
		<h1>Test Results</h1>
		<div id="tree">
		</div>
		<div id="log">
			<h2>Raw log</h2>
		</div>
	</div>
	<div id="debug">
		<h1>Debug Console</h1>
	</div>
</body>
</html>