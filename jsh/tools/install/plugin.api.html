<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the SLIME loader infrastructure.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
	<head>
		<title>jsh.tools.install</title>
		<link href="../../../loader/api/api.css" rel="stylesheet" type="text/css" />
		<script src="../../../loader/api/api.js"></script>
	</head>
	<body>
		<div><code>jsh</code> plugin for installing software.</div>
		<div jsapi:reference="getApi('api.html').getElement('exports')">
			<h1>Exports</h1>
			<ul>
			</ul>
		</div>
		<div>
			<h1>jsh plugin</h1>
			<ul>
				<li class="object">
					<div class="name">rhino</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>Installs Rhino as a JavaScript engine for the currently executing shell.</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span>
											(optional; defaults to empty object)
										</span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<!--	TODO	no tests for this property	-->
												<div class="name">local</div>
												<span class="type"><a href="../../../rhino/file/api.html#types.file">file</a></span>
												<span>The Rhino JAR file.</span>
											</li>
											<li class="value">
												<div class="name">replace</div>
												<span class="type">boolean</span>
												<span>Whether to proceed if Rhino is already part of the shell.</span>
											</li>
										</ul>
									</li>
									<li class="value">
										<span class="type">on</span>
										<span>An event listener.</span>
									</li>
								</ol>
							</div>
							<script type="application/x.jsapi#tests">
								var Captor = function() {
									var events = [];
									
									this.console = function(e) {
										events.push(e);
									}
									
									this.installed = function(e) {
										events.push(e);
									}
									
									this.captured = events;
									
									this.captured.type = function(type) {
										return events.filter(function(e) { return e.type == type; });
									}
								}
								
								var lib = jsh.shell.TMPDIR.createTemporary({ directory: true });
								
								var mock = { lib: lib };
								
								var readFile = function() {
									return this.read(String);
								};
								
								(function alreadyInstalled() {
									lib.getRelativePath("js.jar").write("already", { append: false });
									var captor = new Captor();
									jsh.tools.install.rhino.install({ mock: mock }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Rhino already installed at " + lib.getFile("js.jar"));
									verify(lib).getFile("js.jar").evaluate(readFile).is("already");
									verify(captor.captured.type("installed")).length.is(0);
									lib.getFile("js.jar").remove();
								})();
								
								(function replace() {
									lib.getRelativePath("js.jar").write("original", { append: false });
									lib.getRelativePath("download").write("downloaded", { append: false });
									mock.rhino = lib.getFile("download");
									var captor = new Captor();
									jsh.tools.install.rhino.install({ mock: mock, replace: true }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Installing Rhino ...");
									verify(lib).getFile("js.jar").evaluate(readFile).is("downloaded");
									verify(captor.captured.type("installed")).length.is(1);
									lib.getFile("js.jar").remove();
								})();
								
								(function install() {
									lib.getRelativePath("download").write("downloaded", { append: false });
									mock.rhino = lib.getFile("download");
									var captor = new Captor();
									jsh.tools.install.rhino.install({ mock: mock }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Installing Rhino ...");
									verify(lib).getFile("js.jar").evaluate(readFile).is("downloaded");
									verify(captor.captured.type("installed")).length.is(1);
									lib.getFile("js.jar").remove();
								})();
							</script>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">tomcat</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>Installs Tomcat to a given directory (or to the shell).</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span></span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<div class="name">to</div>
												<span class="type">Pathname</span>
												<span>
													(optional; defaults to <code>jsh.shell.jsh.lib.getRelativePath("tomcat")</code>)
												</span>
											</li>
											<li class="value">
												<div class="name">replace</div>
												<span class="type">boolean</span>
												<span>
													Whether to replace an installation found at the given <code>to</code>.
												</span>
											</li>
											<li class="value">
												<div class="name">version</div>
												<span class="type">string</span>
												<span>
													(optional; defaults to latest version of Tomcat 7 if no <code>local</code>,
													otherwise attempts to parse filename of <code>local</code>)
												</span>
											</li>
											<li class="value">
												<div class="name">local</div>
												<span class="type"><a href="../../../rhino/file/api.html#types.file">file</a></span>
												<span>A local Tomcat distribution to install.</span>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<script type="application/x.jsapi#tests">
								var Captor = function(array,types) {
									types.forEach(function(type) {
										this[type] = function(e) {
											array.push(e);
										}
									},this);
								};
								
								var isType = function(name) {
									return function(e) {
										return e.type == name;
									}
								};
								
								var mock = {
									lib: jsh.shell.TMPDIR.createTemporary({ directory: true })
								};
								
								verify("pre").is("pre");
								var distributions = {
									"7.0.99": (function() {
										var tmpdir = jsh.shell.TMPDIR.createTemporary({ directory: true });
										var dist = tmpdir.getRelativePath("apache-tomcat-7.0.99").createDirectory();
										dist.getRelativePath("a").write("a", { append: false });
										var rv = jsh.shell.TMPDIR.createTemporary({ suffix: ".zip" }).pathname;
										jsh.io.archive.zip.encode({
											stream: rv.write(jsh.io.Streams.binary, { append: false }),
											entries: [
												{ path: "apache-tomcat-7.0.99/a", resource: dist.getFile("a") }
											]
										});
										return rv.file;
									})()
								};
								verify("post").is("post");
								
								(function alreadyInstalled() {
									var events = [];
									mock.lib.getRelativePath("tomcat").createDirectory();
									jsh.tools.install.tomcat.install({ mock: mock }, new Captor(events,["console","installed"]));
									verify(events)[0].type.is("console");
									verify(events)[0].detail.is("Tomcat already installed at " + mock.lib.getSubdirectory("tomcat"));
									mock.lib.getSubdirectory("tomcat").remove();
								})();
								
								(function install() {
									var events = [];
									mock.getLatestVersion = function() { return "7.0.99"; };
									mock.findApache = function(o) { return distributions["7.0.99"] };
									verify(distributions["7.0.99"]).is(distributions["7.0.99"]);
									jsh.tools.install.tomcat.install({ mock: mock }, new Captor(events,["console","installed"]));
									verify(events)[0].type.is("console");
									verify(events)[0].evaluate(function() { return /^Unzipping to\:(.*)$/.test(this.detail); }).is(true);
									verify(mock.lib).getSubdirectory("tomcat").getFile("a").is.type("object");
									verify(mock.lib).getSubdirectory("tomcat").getFile("b").is.type("null");
									mock.lib.getSubdirectory("tomcat").remove();									
								})();
							</script>
						</li>
					</ul>
				</li>
			</ul>
		</div>
	</body>
</html>
