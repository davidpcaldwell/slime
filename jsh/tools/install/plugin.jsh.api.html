<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the SLIME loader infrastructure.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
	<head>
		<title>jsh.tools.install, jsh.shell.tools.*</title>
		<link href="../../../loader/api/api.css" rel="stylesheet" type="text/css" />
		<script src="../../../loader/api/api.js"></script>
	</head>
	<body>
		<div>Plugin which adds APIs to multiple namespaces:
			<ul>
				<li><code>jsh.tools.install</code>: APIs for installing software generally.</li>
				<li>
					<code>jsh.shell.tools.*</code>: APIs for a specific set of externally-provided tools (Rhino, Tomcat,
					<code>ncdbg</code>), including installation APIs.
				</li>
			</ul>
		</div>
		<div>
			<h1><code><a id="exports.jsh.tools.install">jsh.tools.install</a></code></h1>
			<div><code>jsh</code> plugin for installing external software.</div>
			<div jsapi:reference="getApi('api.html').getElement('exports')">
			</div>
		</div>
		<div>
			<script tyoe="application/x.jsapi#initialize">
				jsh.loader.plugins($jsapi.loader);
			</script>
			<h1><code><a id="exports.jsh.shell.tools">jsh.shell.tools</a></code></h1>
			<ul>
				<li class="object">
					<div class="name">rhino</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>Installs Rhino as a JavaScript engine for the currently executing shell.</span>
							<!--	Uses jrunscript API	-->
							<!--	TODO	document: does it use local copy if present?	-->
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span>
											(optional; defaults to empty object)
										</span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<!--	TODO	no tests for this property	-->
												<div class="name">local</div>
												<span class="type"><a href="../../../rhino/file/api.html#types.file">file</a></span>
												<span>The Rhino JAR file.</span>
											</li>
											<li class="value">
												<div class="name">replace</div>
												<span class="type">boolean</span>
												<span>Whether to proceed if Rhino is already part of the shell.</span>
											</li>
										</ul>
									</li>
									<li class="value">
										<span class="type">on</span>
										<span>An event listener.</span>
									</li>
								</ol>
							</div>
							<script type="application/x.jsapi#tests">
								var Captor = function() {
									var events = [];

									this.console = function(e) {
										events.push(e);
									}

									this.installed = function(e) {
										events.push(e);
									}

									this.captured = events;

									this.captured.type = function(type) {
										return events.filter(function(e) { return e.type == type; });
									}
								}

								var lib = jsh.shell.TMPDIR.createTemporary({ directory: true });

								var mock = { lib: lib };

								var readFile = function() {
									return this.read(String);
								};

								(function alreadyInstalled() {
									lib.getRelativePath("js.jar").write("already", { append: false });
									var captor = new Captor();
									jsh.shell.tools.rhino.install({ mock: mock }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Rhino already installed at " + lib.getFile("js.jar"));
									verify(lib).getFile("js.jar").evaluate(readFile).is("already");
									verify(captor.captured.type("installed")).length.is(0);
									lib.getFile("js.jar").remove();
								})();

								(function replace() {
									lib.getRelativePath("js.jar").write("original", { append: false });
									lib.getRelativePath("download").write("downloaded", { append: false });
									mock.rhino = lib.getFile("download");
									var captor = new Captor();
									jsh.shell.tools.rhino.install({ mock: mock, replace: true }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Installing Rhino ...");
									verify(lib).getFile("js.jar").evaluate(readFile).is("downloaded");
									verify(captor.captured.type("installed")).length.is(1);
									lib.getFile("js.jar").remove();
								})();

								(function install() {
									lib.getRelativePath("download").write("downloaded", { append: false });
									mock.rhino = lib.getFile("download");
									var captor = new Captor();
									jsh.shell.tools.rhino.install({ mock: mock }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Installing Rhino ...");
									verify(lib).getFile("js.jar").evaluate(readFile).is("downloaded");
									verify(captor.captured.type("installed")).length.is(1);
									lib.getFile("js.jar").remove();
								})();
							</script>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">tomcat</div>
					<span>__DESCRIPTION__</span>
					<div class="type">
						<a class="type" name="types.tomcat.installation">installation</a>
						<span>A Tomcat installation.</span>
						<div class="label">has properties:</div>
						<ul>
							<li class="value">
								<div class="name">version</div>
								<div class="label">has properties:</div>
								<ul>
									<li class="function">
										<div class="name">toString</div>
										<span></span>
										<div class="returns">
											<div class="label">Returns</div>
											<span class="type">string</span>
											<span>The version string for this Tomcat; e.g., <code>"7.0.70"</code>.</span>
										</div>
									</li>
								</ul>
								<span>An object representing the installed version of Tomcat.</span>
							</li>
						</ul>
					</div>

					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">installed</div>
							<span>Returns information about a currently installed Tomcat.</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span>(optional; if omitted, an empty object is used)</span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<div class="name">home</div>
												<span class="type">directory</span>
												<span>
													(optional; if omitted, returns information about the version installed with
													<code>jsh</code>)
												</span>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type"><a href="#types.tomcat.installation">installation</a></span>
							</div>
							<script type="application/x.jsapi#tests">
								var toString = function() {
									return this.toString();
								};

								var installed = jsh.shell.tools.tomcat.installed({ mock: { notes: $jsapi.loader.get("test/data/tomcat-release-notes-7.0.70.txt") } });
								verify(installed).version.evaluate(toString).is("7.0.70");
							</script>
						</li>
						<li class="function">
							<div class="name">install</div>
							<span>Installs Tomcat to a given directory (or to the shell).</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span></span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<div class="name">to</div>
												<span class="type">Pathname</span>
												<span>
													(optional; defaults to installing into <code>jsh</code>)
												</span>
											</li>
											<li class="value">
												<div class="name">replace</div>
												<span class="type">boolean</span>
												<span>
													Whether to replace an installation found at the given <code>to</code>.
												</span>
											</li>
											<li class="value">
												<div class="name">version</div>
												<span class="type">string</span>
												<span>
													(optional; defaults to latest version of Tomcat 7 if no <code>local</code>,
													otherwise attempts to parse filename of <code>local</code>)
												</span>
											</li>
											<li class="value">
												<div class="name">local</div>
												<span class="type"><a href="../../../rhino/file/api.html#types.file">file</a></span>
												<span>A local Tomcat distribution to install.</span>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<script type="application/x.jsapi#tests">
								var Captor = function(array,types) {
									types.forEach(function(type) {
										this[type] = function(e) {
											array.push(e);
										}
									},this);
								};

								var isType = function(name) {
									return function(e) {
										return e.type == name;
									}
								};

								var getVersionString = function() {
									if (!this.version) return null;
									return this.version.toString();
								};

								var Distribution = function(version) {
									var tmpdir = jsh.shell.TMPDIR.createTemporary({ directory: true });
									var dist = tmpdir.getRelativePath("apache-tomcat-" + version).createDirectory();
									dist.getRelativePath("a").write("a", { append: false });
									dist.getRelativePath("RELEASE-NOTES").write($jsapi.loader.get("test/data/tomcat-release-notes-7.0.70.txt").read(String).replace(/7\.0\.70/g, version), { append: false });
									var rv = jsh.shell.TMPDIR.createTemporary({ suffix: ".zip" }).pathname;
									jsh.io.archive.zip.encode({
										stream: rv.write(jsh.io.Streams.binary, { append: false }),
										entries: [
											{ path: "apache-tomcat-" + version + "/" + "RELEASE-NOTES", resource: dist.getFile("RELEASE-NOTES") },
											{ path: "apache-tomcat-" + version + "/" + "a", resource: dist.getFile("a") }
										]
									});
									return rv.file;
								}

								var mock = {
									lib: jsh.shell.TMPDIR.createTemporary({ directory: true }),
									getLatestVersion: function() {
										return "7.0.99";
									},
									findApache: function(o) {
										if (o.path == "tomcat/tomcat-7/v7.0.98/bin/apache-tomcat-7.0.98.zip") return Distribution("7.0.98");
										if (o.path == "tomcat/tomcat-7/v7.0.99/bin/apache-tomcat-7.0.99.zip") return Distribution("7.0.99");
										throw new Error("Mock: " + o.path);
									}
								};

								(function alreadyInstalled() {
									var events = [];
									mock.lib.getRelativePath("tomcat").createDirectory();
									jsh.shell.tools.tomcat.install({ mock: mock }, new Captor(events,["console","installed"]));
									verify(events)[0].type.is("console");
									verify(events)[0].detail.is("Tomcat already installed at " + mock.lib.getSubdirectory("tomcat"));
									mock.lib.getSubdirectory("tomcat").remove();
								})();

								(function install() {
									var events = [];
									jsh.shell.tools.tomcat.install({ mock: mock }, new Captor(events,["console","installed"]));
									verify(events)[0].type.is("console");
									jsh.shell.console(events[0].detail);
									verify(events)[0].evaluate(function() { return /^Unzipping (?:[a-zA-Z0-9\/\._]+) to\:(.*)$/.test(this.detail); }).is(true);
									verify(mock.lib).getSubdirectory("tomcat").getFile("a").is.type("object");
									verify(mock.lib).getSubdirectory("tomcat").getFile("b").is.type("null");
									var installed = jsh.shell.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									var version = installed.version.toString();
									verify(version).is("7.0.99");
									mock.lib.getSubdirectory("tomcat").remove();
								})();

								(function replace() {
									jsh.shell.tools.tomcat.install({ mock: mock, version: "7.0.98" });
									var installed = jsh.shell.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									verify(installed).evaluate(getVersionString).is("7.0.98");

									var noreplace = [];
									jsh.shell.tools.tomcat.install({ mock: mock }, new Captor(noreplace,["installed"]));
									installed = jsh.shell.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									verify(installed).evaluate(getVersionString).is("7.0.98");
									verify(noreplace).length.is(0);

									var replace = [];
									jsh.shell.tools.tomcat.install({ mock: mock, replace: true }, new Captor(replace,["installed"]));
									installed = jsh.shell.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									verify(installed).evaluate(getVersionString).is("7.0.99");
									verify(replace).length.is(1);

									mock.lib.getSubdirectory("tomcat").remove();
								})();
							</script>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">ncdbg</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
					</ul>
				</li>
				<li class="object">
					<div class="name">jsoup</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
					</ul>
				</li>
				<li class="object">
					<div class="name">javamail</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
					</ul>
				</li>
				<li class="object">
					<div class="name">poi</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
					</ul>
				</li>
				<li class="object">
					<div class="name">jsyaml</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>
								Installs the <code>master</code> version of <code>js-yaml</code> into the shell so that it can be
								loaded by <code>load()</code>. Any version present is overwritten.
							</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type"><a href="https://github.com/nodeca/js-yaml/blob/master/README.md">js-yaml</a> API</span>
								<span>__DESCRIPTION__</span>
							</div>
						</li>
						<li class="function">
							<div class="name">load</div>
							<span>Loads the <code>js-yaml</code> API and returns it, retrieving it online if necessary.</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type"><a href="https://github.com/nodeca/js-yaml/blob/master/README.md">js-yaml</a> API</span>
								<span>__DESCRIPTION__</span>
							</div>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">node</div>
					<span>
						(conditional; see below) APIs pertaining to the global Node.js installation for <code>jsh</code>.
					</span>
					<div>
						If Node.js is installed in this installation of <code>jsh</code>, this object will be a Node.js
						<a href="../../../rhino/tools/node/api.html">Installation</a>.
					</div>
					<div>
						If Node.js is not installed in this <code>jsh</code> installation, but can be installed, it will be an
						object with the following properties:
					</div>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>Creattes a global Node.js installation for <code>jsh</code>.</span>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">__TYPE__</span>
								<span>__DESCRIPTION__</span>
							</div>
						</li>
					</ul>
				</li>
			</ul>
		</div>
		<div>
			<h1>Other tools</h1>
			<div>
				<h2>POI</h2>
				<div>
					POI can be installed using <code>jsh/tools/install/poi.jsh.js</code>. This will add an Excel-based grid
					implementation to <code>jrunscript/io</code>.
					<script type="application/x.jsapi#tests">
						var poi = jsh.shell.jsh.lib.getSubdirectory("poi");
						if (poi) {
							verify(jsh).io.grid.excel.is.type("object");
						} else {
							verify(jsh).io.grid.evaluate.property("excel").is(void(0));
						}
					</script>
				</div>
			</div>
		</div>
	</body>
</html>
