<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the SLIME loader infrastructure.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
	<head>
		<title>jsh.tools.install</title>
		<link href="../../../loader/api/api.css" rel="stylesheet" type="text/css" />
		<script src="../../../loader/api/api.js"></script>
	</head>
	<body>
		<div><code>jsh</code> plugin for installing software.</div>
		<div>
			<h1><code><a id="exports.jsh.tools.install">jsh.tools.install</a></code></h1>
			<div jsapi:reference="getApi('api.html').getElement('exports')">
			</div>
		</div>
		<div>
			<script tyoe="application/x.jsapi#initialize">
				jsh.loader.plugins($jsapi.loader);
			</script>
			<h1><code><a id="exports.jsh.tools">jsh.tools</a></code></h1>
			<ul>
				<li class="object">
					<div class="name">rhino</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>Installs Rhino as a JavaScript engine for the currently executing shell.</span>
							<!--	Uses jrunscript API	-->
							<!--	TODO	document: does it use local copy if present?	-->
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span>
											(optional; defaults to empty object)
										</span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<!--	TODO	no tests for this property	-->
												<div class="name">local</div>
												<span class="type"><a href="../../../rhino/file/api.html#types.file">file</a></span>
												<span>The Rhino JAR file.</span>
											</li>
											<li class="value">
												<div class="name">replace</div>
												<span class="type">boolean</span>
												<span>Whether to proceed if Rhino is already part of the shell.</span>
											</li>
										</ul>
									</li>
									<li class="value">
										<span class="type">on</span>
										<span>An event listener.</span>
									</li>
								</ol>
							</div>
							<script type="application/x.jsapi#tests">
								var Captor = function() {
									var events = [];

									this.console = function(e) {
										events.push(e);
									}

									this.installed = function(e) {
										events.push(e);
									}

									this.captured = events;

									this.captured.type = function(type) {
										return events.filter(function(e) { return e.type == type; });
									}
								}

								var lib = jsh.shell.TMPDIR.createTemporary({ directory: true });

								var mock = { lib: lib };

								var readFile = function() {
									return this.read(String);
								};

								(function alreadyInstalled() {
									lib.getRelativePath("js.jar").write("already", { append: false });
									var captor = new Captor();
									jsh.tools.rhino.install({ mock: mock }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Rhino already installed at " + lib.getFile("js.jar"));
									verify(lib).getFile("js.jar").evaluate(readFile).is("already");
									verify(captor.captured.type("installed")).length.is(0);
									lib.getFile("js.jar").remove();
								})();

								(function replace() {
									lib.getRelativePath("js.jar").write("original", { append: false });
									lib.getRelativePath("download").write("downloaded", { append: false });
									mock.rhino = lib.getFile("download");
									var captor = new Captor();
									jsh.tools.rhino.install({ mock: mock, replace: true }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Installing Rhino ...");
									verify(lib).getFile("js.jar").evaluate(readFile).is("downloaded");
									verify(captor.captured.type("installed")).length.is(1);
									lib.getFile("js.jar").remove();
								})();

								(function install() {
									lib.getRelativePath("download").write("downloaded", { append: false });
									mock.rhino = lib.getFile("download");
									var captor = new Captor();
									jsh.tools.rhino.install({ mock: mock }, captor);
									verify(captor).captured[0].type.is("console");
									verify(captor).captured[0].detail.is("Installing Rhino ...");
									verify(lib).getFile("js.jar").evaluate(readFile).is("downloaded");
									verify(captor.captured.type("installed")).length.is(1);
									lib.getFile("js.jar").remove();
								})();
							</script>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">tomcat</div>
					<span>__DESCRIPTION__</span>
					<div class="type">
						<a class="type" name="types.tomcat.installation">installation</a>
						<span>A Tomcat installation.</span>
						<div class="label">has properties:</div>
						<ul>
							<li class="value">
								<div class="name">version</div>
								<div class="label">has properties:</div>
								<ul>
									<li class="function">
										<div class="name">toString</div>
										<span></span>
										<div class="returns">
											<div class="label">Returns</div>
											<span class="type">string</span>
											<span>The version string for this Tomcat; e.g., <code>"7.0.70"</code>.</span>
										</div>
									</li>
								</ul>
								<span>An object representing the installed version of Tomcat.</span>
							</li>
						</ul>
					</div>

					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">installed</div>
							<span>Returns information about a currently installed Tomcat.</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span>(optional; if omitted, an empty object is used)</span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<div class="name">home</div>
												<span class="type">directory</span>
												<span>
													(optional; if omitted, returns information about the version installed with
													<code>jsh</code>)
												</span>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type"><a href="#types.tomcat.installation">installation</a></span>
							</div>
							<script type="application/x.jsapi#tests">
								var toString = function() {
									return this.toString();
								};

								var installed = jsh.tools.tomcat.installed({ mock: { notes: $jsapi.loader.get("test/data/tomcat-release-notes-7.0.70.txt") } });
								verify(installed).version.evaluate(toString).is("7.0.70");
							</script>
						</li>
						<li class="function">
							<div class="name">install</div>
							<span>Installs Tomcat to a given directory (or to the shell).</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span></span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<div class="name">to</div>
												<span class="type">Pathname</span>
												<span>
													(optional; defaults to installing into <code>jsh</code>)
												</span>
											</li>
											<li class="value">
												<div class="name">replace</div>
												<span class="type">boolean</span>
												<span>
													Whether to replace an installation found at the given <code>to</code>.
												</span>
											</li>
											<li class="value">
												<div class="name">version</div>
												<span class="type">string</span>
												<span>
													(optional; defaults to latest version of Tomcat 7 if no <code>local</code>,
													otherwise attempts to parse filename of <code>local</code>)
												</span>
											</li>
											<li class="value">
												<div class="name">local</div>
												<span class="type"><a href="../../../rhino/file/api.html#types.file">file</a></span>
												<span>A local Tomcat distribution to install.</span>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<script type="application/x.jsapi#tests">
								var Captor = function(array,types) {
									types.forEach(function(type) {
										this[type] = function(e) {
											array.push(e);
										}
									},this);
								};

								var isType = function(name) {
									return function(e) {
										return e.type == name;
									}
								};

								var getVersionString = function() {
									if (!this.version) return null;
									return this.version.toString();
								};

								var Distribution = function(version) {
									var tmpdir = jsh.shell.TMPDIR.createTemporary({ directory: true });
									var dist = tmpdir.getRelativePath("apache-tomcat-" + version).createDirectory();
									dist.getRelativePath("a").write("a", { append: false });
									dist.getRelativePath("RELEASE-NOTES").write($jsapi.loader.get("test/data/tomcat-release-notes-7.0.70.txt").read(String).replace(/7\.0\.70/g, version), { append: false });
									var rv = jsh.shell.TMPDIR.createTemporary({ suffix: ".zip" }).pathname;
									jsh.io.archive.zip.encode({
										stream: rv.write(jsh.io.Streams.binary, { append: false }),
										entries: [
											{ path: "apache-tomcat-" + version + "/" + "RELEASE-NOTES", resource: dist.getFile("RELEASE-NOTES") },
											{ path: "apache-tomcat-" + version + "/" + "a", resource: dist.getFile("a") }
										]
									});
									return rv.file;
								}

								var mock = {
									lib: jsh.shell.TMPDIR.createTemporary({ directory: true }),
									getLatestVersion: function() {
										return "7.0.99";
									},
									findApache: function(o) {
										if (o.path == "tomcat/tomcat-7/v7.0.98/bin/apache-tomcat-7.0.98.zip") return Distribution("7.0.98");
										if (o.path == "tomcat/tomcat-7/v7.0.99/bin/apache-tomcat-7.0.99.zip") return Distribution("7.0.99");
										throw new Error("Mock: " + o.path);
									}
								};

								(function alreadyInstalled() {
									var events = [];
									mock.lib.getRelativePath("tomcat").createDirectory();
									jsh.tools.tomcat.install({ mock: mock }, new Captor(events,["console","installed"]));
									verify(events)[0].type.is("console");
									verify(events)[0].detail.is("Tomcat already installed at " + mock.lib.getSubdirectory("tomcat"));
									mock.lib.getSubdirectory("tomcat").remove();
								})();

								(function install() {
									var events = [];
									jsh.tools.tomcat.install({ mock: mock }, new Captor(events,["console","installed"]));
									verify(events)[0].type.is("console");
									verify(events)[0].evaluate(function() { return /^Unzipping to\:(.*)$/.test(this.detail); }).is(true);
									verify(mock.lib).getSubdirectory("tomcat").getFile("a").is.type("object");
									verify(mock.lib).getSubdirectory("tomcat").getFile("b").is.type("null");
									var installed = jsh.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									var version = installed.version.toString();
									verify(version).is("7.0.99");
									mock.lib.getSubdirectory("tomcat").remove();
								})();

								(function replace() {
									jsh.tools.tomcat.install({ mock: mock, version: "7.0.98" });
									var installed = jsh.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									verify(installed).evaluate(getVersionString).is("7.0.98");

									var noreplace = [];
									jsh.tools.tomcat.install({ mock: mock }, new Captor(noreplace,["installed"]));
									installed = jsh.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									verify(installed).evaluate(getVersionString).is("7.0.98");
									verify(noreplace).length.is(0);

									var replace = [];
									jsh.tools.tomcat.install({ mock: mock, replace: true }, new Captor(replace,["installed"]));
									installed = jsh.tools.tomcat.installed({ home: mock.lib.getSubdirectory("tomcat") });
									verify(installed).evaluate(getVersionString).is("7.0.99");
									verify(replace).length.is(1);

									mock.lib.getSubdirectory("tomcat").remove();
								})();
							</script>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">ncdbg</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
					</ul>
				</li>
				<li class="object">
					<div class="name">hg</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<script type="application/x.jsapi#initialize">
						scope.api = jsh.tools;
					</script>
					<script type="application/x.jsapi#tests">
						verify(1).is(1);
						verify(scope).api.hg.is.type("object");

						var distribution = scope.api.hg.distribution.osx({ os: "10.9.2" });
						verify(distribution).distribution.url.is("https://www.mercurial-scm.org/mac/binaries/Mercurial-3.4.2-py2.7-macosx10.9.zip");

						verify(scope.api.hg).evaluate(function() { return this.distribution.osx({ os: "10.3.2" }) }).threw.type(Error);

						verify(scope.api.hg).distribution.osx({ os: "10.13.1" }).distribution.url.is("https://www.mercurial-scm.org/mac/binaries/Mercurial-4.2.2-macosx10.12.pkg");
					</script>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>Updates the Mercurial install to the best version for the platform.</span>
							<script type="application/x.jsapi#tests"><![CDATA[
								var Listener = function() {
									var events = [];

									this.console = function(e) {
										events.push(e);
									};

									this.received = function() {
										return events;
									}
								};

								var runInstall = function(p) {
									var listener = new Listener();
									var rv = {};
									try {
										api.hg.install({ mock: p.mock }, listener);
									} catch(e) {
										rv.threw = e;
									}
									rv.events = listener.received();
									return rv;
								};

								(function alreadyInstalled() {
									var mock = {
										shell: {
											os: {
												name: "Mac OS X",
												version: "10.11"
											}
										},
										installed: { version: "4.0.1" }
									};
									var events = runInstall({ mock: mock }).events;
									var last = events[events.length-1];
									verify(last).type.is("console");
									verify(last).detail.is("Already installed: hg 4.0.1");
								})();

								(function upgrade() {
									var mock = {
										shell: {
											os: {
												name: "Mac OS X",
												version: "10.11"
											},
											run: function(p) {
												if (p.command == "open" && p.arguments.length == 1 && p.arguments[0].pathname.basename == "file.pkg") {
													return;
												} else {
													throw new Error();
												}
											}
										},
										install: {
											get: function(p) {
												return {
													pathname: {
														basename: "file.pkg"
													}
												};
											}
										},
										installed: { version: "3.4" }
									};
									var result = runInstall({ mock: mock });
									var events = result.events;
									var versions = events[1];
									verify(versions).type.is("console");
									verify(versions).detail.is("Found version: 3.4; upgrading to 4.0.1");
									verify(result).threw.is.type("object");
									verify(result).threw.evaluate(function() { return this instanceof TypeError; }).is(false);
									verify(result).threw.evaluate(function() { return this instanceof api.hg.install.GUI; }).is(true);
								})();

								var install = function(os,hg) {
									var mock = {
										shell: {
											os: {
												name: "Mac OS X",
												version: os
											},
											run: function(p) {
												if (p.command == "open" && p.arguments.length == 1 && p.arguments[0].pathname.basename == "file.pkg") {
													return;
												} else {
													throw new Error();
												}
											}
										},
										install: {
											get: function(p) {
												return {
													pathname: {
														basename: "file.pkg"
													}
												};
											}
										},
										installed: null
									};
									var result = runInstall({ mock: mock });
									var events = result.events;
									var versions = events[1];
									verify(versions).type.is("console");
									verify(versions).detail.is("Getting https://www.mercurial-scm.org/mac/binaries/Mercurial-" + hg + "-macosx" + os + ".pkg");
									verify(result).threw.is.type("object");
									verify(result).threw.evaluate(function() { return this instanceof TypeError; }).is(false);
									verify(result).threw.evaluate(function() { return this instanceof api.hg.install.GUI; }).is(true);
								};
								install("10.11","4.0.1");
								install("10.12","4.2.2");
							]]></script>
						</li>
					</ul>
				</li>
				<li class="object">
					<div class="name">git</div>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">install</div>
							<span>__DESCRIPTION__</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">__TYPE__</span>
								<span>__DESCRIPTION__</span>
							</div>
						</li>
					</ul>
				</li>
			</ul>
		</div>
		<div>
			<h1>Programs</h1>
			<div>
				<h2><code>rhino.jsh.js</code></h2>
			</div>
			<div>
				<h2><code>tomcat.jsh.js</code></h2>
			</div>
			<div>
				<h2><code>hg.jsh.js</code></h2>
			</div>
			<div>
				<h2><code>git.jsh.js</code></h2>
			</div>
		</div>
	</body>
</html>
