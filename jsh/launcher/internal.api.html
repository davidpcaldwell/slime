<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the jsh JavaScript/Java shell.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2012-2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>jsh Launcher</title>
	<link rel="stylesheet" type="text/css" href="../../loader/api/api.css"></link>
	<script type="text/javascript" src="../../loader/api/api.js"></script>
	<style>
		table#settings { border-collapse: collapse; }
		table#settings td { border: 1px solid black; padding: 0.2em 0.5em; }
		table#settings thead td { font-weight: bold; }
	</style>
</head>
<body>
	<div>
		<div>
			The <code>jsh</code> launcher is a <code>jrunscript</code> script that starts an engine-specific
			Java program that is capable of creating a <code>jsh</code> shell and executing the indicated script inside it.
		</div>
		<div>
			A shell installation may be <i>built</i> or <i>unbuilt</i>. An unbuilt shell is run directly from the SLIME source code,
			while a built shell is a directory structure produced via the <code>jsh</code> installer.
		</div>
		<div>
			The launcher consists of the following components:
		</div>
	</div>
	<div>
		<h1>Settings</h1>
		<table id="settings">
			<thead>
				<tr>
					<td>Name</td>
					<td>Description</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><code>jsh.debug.launcher</code></td>
					<td>
						Turns on debugging output in the <code>jsh</code> launcher script.
					</td>
				</tr>
			</tbody>
		</table>
	</div>
	<div>
		<h1><a href="../../rhino/jrunscript/api.html"><code>rhino/jrunscript/api.js</code></a></h1>
		<div>
			Creates <code>$api</code> as a property of <code>this</code> (the global object), and then invokes the bootstrap
			launcher at <code>jsh/launcher/main.js</code>.
		</div>
	</div>
	<div>
		<h1>Bootstrap launcher (<code>jsh/launcher/main.js</code>)</h1>
		<div>
			The bootstrap launcher prepares a Java command to launch the engine-specific shell for execution.
		</div>
		<div>
			<h2><code>slime.js</code></h2>
			<div>
				This script, also apparently used in the <code>jsh</code> build process, creates an <code>$api.slime</code> object
				providing SLIME-specific functionality.
				<ul>
					<li class="object">
						<div class="name">$api.slime</div>
						<span>__DESCRIPTION__</span>
						<div class="label">has properties:</div>
						<div class="type">
							<a class="type" name="types.source">source</a>
							<span>__DESCRIPTION__</span>
							<div class="label">has properties:</div>
							<ul>
								<li class="constructor">
									<div class="name">File</div>
									<span>
										(conditional; if underlying source root is a directory rather than a URL)
									</span>
									<div class="arguments">
										<div class="label">Arguments</div>
										<ol>
										</ol>
									</div>
									<div class="instances">
										<div class="label">Instances</div>
										<span class="type">__TYPE__</span>
										<span>__DESCRIPTION__</span>
									</div>
								</li>
								<li class="function">
									<div class="name">getFile</div>
									<span>
										(conditional; if underlying source root is a directory rather than a URL)
									</span>
									<div class="arguments">
										<div class="label">Arguments</div>
										<ol>
										</ol>
									</div>
									<div class="returns">
										<div class="label">Returns</div>
										<span class="type">__TYPE__</span>
										<span>__DESCRIPTION__</span>
									</div>
								</li>
								<li class="function">
									<div class="name">getSourceFilesUnder</div>
									<span>__DESCRIPTION__</span>
									<div class="arguments">
										<div class="label">Arguments</div>
										<ol>
										</ol>
									</div>
									<div class="returns">
										<div class="label">Returns</div>
										<span class="type">__TYPE__</span>
										<span>__DESCRIPTION__</span>
									</div>
								</li>
							</ul>
						</div>
						<ul>
							<li class="value">
								<div class="name">src</div>
								<span class="type"><a href="#types.source">source</a></span>
								<span>
									(conditional; if this is an unbuilt local or remote shell)
								</span>
							</li>
							<li class="object">
								<div class="name">launcher</div>
								<span>__DESCRIPTION__</span>
								<div class="label">has properties:</div>
								<ul>
									<li class="function">
										<div class="name">getClasses</div>
										<span>__DESCRIPTION__</span>
										<div class="arguments">
											<div class="label">Arguments</div>
											<ol>
											</ol>
										</div>
										<div class="returns">
											<div class="label">Returns</div>
											<span class="type">__TYPE__</span>
											<span>__DESCRIPTION__</span>
										</div>
									</li>
								</ul>
							</li>
							<li class="function">
								<div class="name">setting</div>
								<span>
									Returns a string representing the explicit value of a named setting; uses first system properties
									and then environment variables to locate the value.
								</span>
								<div class="arguments">
									<div class="label">Arguments</div>
									<ol>
										<li class="value">
											<span class="type">string</span>
											<span>The period-delimited name of a setting.</span>
										</li>
									</ol>
								</div>
								<div class="returns">
									<div class="label">Returns</div>
									<span class="type">string</span>
									<span>
										The string value of the setting, or <code>null</code> if the setting was not explicitly
										provided.
									</span>
								</div>
							</li>
							<li class="object">
								<div class="name">settings</div>
								<span>__DESCRIPTION__</span>
								<div class="label">has properties:</div>
								<ul>
									<li class="function">
										<div class="name">get</div>
										<span>Returns the effective value for a given setting.</span>
										<div class="arguments">
											<div class="label">Arguments</div>
											<ol>
											</ol>
										</div>
										<div class="returns">
											<div class="label">Returns</div>
											<span class="type">__TYPE__</span>
											<span>__DESCRIPTION__</span>
										</div>
									</li>
								</ul>
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
		<div>
			<h2><code>launcher.js</code></h2>
			<div>
				Creates an <code>$api.jsh</code> object.
				<ul>
					<li class="object">
						<div class="name">$api.jsh</div>
						<span>__DESCRIPTION__</span>
						<div class="label">has properties:</div>
						<ul>
							<li class="function">
								<div class="name">exit</div>
								<span>__DESCRIPTION__</span>
								<div class="arguments">
									<div class="label">Arguments</div>
									<ol>
									</ol>
								</div>
								<div class="returns">
									<div class="label">Returns</div>
									<span class="type">__TYPE__</span>
									<span>__DESCRIPTION__</span>
								</div>
							</li>
							<li class="object">
								<div class="name">engines</div>
								<span>__DESCRIPTION__</span>
								<div class="type">
									<a class="type" name="types.engine">engine</a>
									<span>__DESCRIPTION__</span>
									<div class="label">has properties:</div>
									<ul>
										<li class="value">
											<div class="name">main</div>
											<span class="type">string</span>
											<span>The name of the <code>jsh</code> main class for this engine.</span>
										</li>
										<li class="function">
											<div class="name">resolve</div>
											<span>__DESCRIPTION__</span>
											<div class="arguments">
												<div class="label">Arguments</div>
												<ol>
													<li class="value">
														<span class="type">object</span>
														<span>An object with a property for each engine.</span>
													</li>
												</ol>
											</div>
											<div class="returns">
												<div class="label">Returns</div>
												<span class="type">(any)</span>
												<span>The value of the property for this engine.</span>
											</div>
										</li>
									</ul>
								</div>
								<div class="label">has properties:</div>
								<ul>
									<li class="value">
										<div class="name">rhino</div>
										<span class="type"><a href="#types.engine">engine</a></span>
										<span>__DESCRIPTION__</span>
									</li>
									<li class="value">
										<div class="name">nashorn</div>
										<span class="type"><a href="#types.engine">engine</a></span>
										<span>__DESCRIPTION__</span>
									</li>
								</ul>
							</li>
						</ul>
					</li>
				</ul>
			</div>
		</div>
		<div>
			<h2>Responsibilities</h2>
			<p>
				Essentially, the bootstrap launcher creates a <code>java</code> command for running the loader, which may be run
				either as a subprocess, or as a Java invocation in a new class loader. The launcher calculates various named
				settings, which are passed to the loader as system properties. The steps involved are as follows:
			</p>
			<ul>
				<li>
					If invoked with the <code>-engines</code> argument (and that argument alone), provide a
					list of JavaScript engines that the launcher is capable of using, as a JSON array of strings.
				</li>
				<li>If running an unbuilt shell, it compiles the loader classes.</li>
				<li>
					If running an unbuilt shell, sets the <code>jsh.shell.src</code> setting to let the Java launcher know
					where to find the code.
				</li>
				<li>
					Selects the appropriate Java implementation, and container implementation, to use if the
					<code>jsh.java.home</code> setting is specified.
				</li>
				<li>
					Selects the default JavaScript engine to use for executing the loader and sets it as the <code>jsh.engine</code>
					setting on the Java command.
				</li>
				<li>
					Takes <em>leading</em> arguments that begin with <code>-</code>, switches the container implementation to a VM,
					and passes them as arguments to the loader VM.
				</li>
				<li>
					If running on Rhino, sets the <code>jsh.engine.rhino.classpath</code> setting to the location from which Rhino
					was loaded.
				</li>
				<li>
					If running on Rhino and the profiler is invoked, sends the appropriate argument to the loader VM.
				</li>
				<li>
					Deal with settings that must be sent to a VM container, like <code>jsh.jvm.options</code>, and both switch the
					container to a VM and send the arguments to that VM in an argument-appropriate way.
				</li>
				<li>
					Send other settings to the loader process as system properties.
				</li>
				<li>
					Run the <a href="../loader/internal.api.html">loader</a>, using an engine-specific <code>main()</code> method, which ends up calling
					<code>inonit.script.jsh.Main.cli()</code>, and exit with the status returned by the loader.
				</li>
			</ul>
		</div>
	</div>
	<div>
		<h1>Packaged application launcher (inonit.script.jsh.launcher.Main)</h1>
		<div>
			The Java launcher provides the entry point for running a <code>jsh</code> script when running inside a packaged
			application.
		</div>
		<!--	TODO	remaining description of this launcher may be outdated (2018 Feb 15)	-->
		<div>
			<h2>Settings used</h2>
			<table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>jsh.shell.src</td>
						<td>
							If this is an unbuilt shell, the launcher needs to know where the root directory
							of the SLIME source code is.
						</td>
					</tr>
					<tr>
						<td>jsh.engine</td>
						<td>
							If specified, will override the default mechanism for selecting a JavaScript engine
							and use the specified value.
						</td>
					</tr>
					<tr>
						<td>jsh.engine.rhino.classpath</td>
						<td>
							If specified, will override the default mechanism for locating Rhino.
						</td>
					</tr>
					<tr>
						<td>jsh.launcher.debug</td>
						<td>
							If this is present, and Rhino is used to execute the launcher script, then the
							launcher script will be executed in the Rhino debugger.
						</td>
					</tr>
				</tbody>
			</table>
			<h2>Responsibilities</h2>
			<!--	See Main.java	-->
			<ul>
				<li>
					Configure Java default logging properties if logging was not configured on the command line.
				</li>
				<li>
					Determine what kind of shell is being run, and put a <code>inonit.script.jsh.launcher.Shell</code> instance in
					the <code>jsh.launcher.shell</code> system property. This instance contains information about the locations of
					Rhino, the packaged file (if any), and the shell home (if any). The shell is determined by checking for the
					<code>main.jsh.js</code> resource in the classloader (indicating a packaged shell), and then by checking
					whether the launcher main class was loaded from <code>jsh.jar</code> (indicating a built shell). Otherwise
					an unbuilt shell is being run.
				</li>
				<li>
					Invoke the launcher script.
				</li>
			</ul>
		</div>
		<script type="application/x.jsapi#tests">
			var classpathUri = String($jsapi.environment.jsh.packaged.jar.pathname.java.adapt().toURI().toString())
			verify($jsapi).environment.jsh.packaged.data.shellClasspath.is(classpathUri);
		</script>
	</div>
	<div>
		<h1>Tests</h1>
		<div jsapi:id="hello">
			<script type="application/x.jsapi#initialize">
				scope.evaluateJson = function(result) {
					return JSON.parse(result.stdio.output);
				}
			</script>
			<script type="application/x.jsapi#tests" jsapi:id="src">
				var output = jsh.shell.jsh({
					shell: $jsapi.environment.jsh.unbuilt.src,
					script: $jsapi.environment.jsh.src.getFile("jsh/test/jsh-data.jsh.js"),
					stdio: {
						output: String
					},
					evaluate: evaluateJson
				});
				verify(output).evaluate.property("jsh.shell.jsh.src").string.is.type("string");
//				verify(outputLines)[0].is("Completed.");
//				verify(false).is(true);
			</script>
			<script type="application/x.jsapi#tests" jsapi:id="home">
				var outputLines = jsh.shell.jsh({
					shell: $jsapi.environment.jsh.built.home,
					script: $jsapi.environment.jsh.src.getFile("jsh/test/jsh.shell/properties.jsh.js"),
					stdio: {
						output: String
					},
					evaluate: function(result) {
						return result.stdio.output.split("\n");
					}
				});
				verify(outputLines)[0].is("Completed.");
			</script>
			<script type="application/x.jsapi#tests">
				// TODO: substitute jsh-data.jsh.js here and read some substantive values?
				if ($jsapi.environment.jsh.remote) {
					var remote = $jsapi.environment.jsh.remote;
					if (!remote) throw new Error("No remote shell!");
					var fileTestOutputLines = remote.jsh({
						script: $jsapi.environment.jsh.src.getFile("jsh/test/jsh.shell/properties.jsh.js"),
						stdio: {
							output: String
						},
						evaluate: function(result) {
							return result.stdio.output.split("\n");
						}
					});
					verify(fileTestOutputLines)[0].is("Completed.");
					var urlTestOutputLines = remote.jsh({
						script: remote.url + "jsh/test/jsh.shell/properties.jsh.js",
						stdio: {
							output: String
						},
						evaluate: function(result) {
							return result.stdio.output.split("\n");
						}
					});
					verify(fileTestOutputLines)[0].is("Completed.");
				}
			</script>
			<script type="application/x.jsapi#tests" jsapi:id="executable">
				if ($jsapi.environment.jsh.built.home.getFile("jsh")) {
					var output = jsh.shell.run({
						command: $jsapi.environment.jsh.built.home.getFile("jsh"),
						arguments: [$jsapi.environment.jsh.built.home.getFile("src/jsh/test/jsh-data.jsh.js")],
						stdio: {
							output: String
						},
						evaluate: function(result) {
							return JSON.parse(result.stdio.output);
						}
					});
					verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());

					(function absolute() {
						var output = jsh.shell.run({
							command: $jsapi.environment.jsh.built.home.getFile("jsh").toString(),
							arguments: [$jsapi.environment.jsh.built.home.getFile("src/jsh/test/jsh-data.jsh.js")],
							stdio: {
								output: String
							},
							evaluate: function(result) {
								return JSON.parse(result.stdio.output);
							}
						});
						verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());
					})();

					var shellCommand = function(p) {
						var lines = [];
						if (p.directory) {
							lines.push("cd " + p.directory);
						}
						if (p.PATH) {
							lines.push("export PATH=" + p.PATH);
						}
						lines.push(p.command + " " + p.arguments.join(" "));
						var file = jsh.shell.TMPDIR.createTemporary({ suffix: ".bash" });
						file.pathname.write(lines.join("\n"), { append: false });
						//jsh.shell.console(file + "\n" + file.read(String) + "\n\n");
						return jsh.shell.run({
							command: "bash",
							arguments: [file].concat(p.arguments),
							directory: file.parent,
							stdio: {
								output: String
							},
							evaluate: function(result) {
								return JSON.parse(result.stdio.output);
							}
						});
					};

					(function relative() {
						var basedir = $jsapi.environment.jsh.built.home.pathname.basename;
						var parent = $jsapi.environment.jsh.built.home.parent;
						var output = shellCommand({
							command: basedir + "/" + "jsh",
							arguments: [$jsapi.environment.jsh.built.home.getFile("src/jsh/test/jsh-data.jsh.js")],
							directory: parent,
							stdio: {
								output: String
							},
							evaluate: function(result) {
								return JSON.parse(result.stdio.output);
							}
						});
						verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());
					})();

					(function inPath() {
						var directory = $jsapi.environment.jsh.built.home;
						var PATH = jsh.file.Searchpath([directory.pathname].concat(jsh.shell.PATH.pathnames));
						var output = shellCommand({
							command: "jsh",
							PATH: PATH,
							arguments: [$jsapi.environment.jsh.built.home.getFile("src/jsh/test/jsh-data.jsh.js")],
							directory: jsh.shell.HOME,
							stdio: {
								output: String
							},
							evaluate: function(result) {
								return JSON.parse(result.stdio.output);
							}
						});
						verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());
					})();
				}
			</script>
		</div>
	</div>
</body>
</html>
