<!--
LICENSE
The contents of this file are subject to the Mozilla Public License Version 1.1 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the License at http://www.mozilla.org/MPL/

Software distributed under the License is distributed on an "AS IS" basis, WITHOUT WARRANTY OF ANY KIND, either
express or implied. See the License for the specific language governing rights and limitations under the License.

The Original Code is the rhino/host SLIME module.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2010 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<html xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>Java host objects</title>
</head>
<body>
	<div>
		<h1>Context</h1>
		<ul>
			<li class="function">
				<div class="name">warning</div>
				<span>
					(optional) A function that will be invoked when this module wishes to emit a warning. The default
					implementation pops up the debugger if one is available and writes the given message to
					<code>java.lang.System.err</code>.
				</span>
				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li><span class="type">string</span> A warning message.</li>
					</ol>
				</div>
			</li>
			<li class="value">
				<div class="name">classLoader</div>
				<span class="type">java.lang.ClassLoader</span>
				<span>
					(optional) A <code>ClassLoader</code> that should be used when this module attempts to locate classes by name.
				</span>
			</li>
		</ul>
		<script type="application/x.jsapi#context">
			new function() {
			}
		</script>
	</div>
	<div>
		<h1>Exports</h1>
		<ul>
			<li class="function">
				<div class="name">isJavaObject</div>
				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li>A JavaScript value</li>
					</ol>
				</div>
				<div class="returns">
					<div class="label">Returns</div>
					<span class="type">boolean</span> <code>true</code> if the given argument is a Java object, and <code>false</code> if it is
					<code>undefined</code>, <code>null</code>, a JavaScript primitive
					value, or a native JavaScript object.
					<!--	TODO	What if it is JavaPackage? JavaClass?	-->
				</div>
				<script type="application/x.jsapi#tests" jsapi:id="isJavaObject">
					var isJavaObject = module.isJavaObject;
					test(isJavaObject(Packages.java.lang.Runtime.getRuntime()));
					test(isJavaObject(new Packages.java.lang.Object()));
					test(isJavaObject(new Packages.java.lang.String("hello world")));
					test(isJavaObject(new Packages.java.lang.Integer(4)));
					test(isJavaObject(new Packages.java.lang.Boolean(true)));
					test(isJavaObject(Packages.java.lang.Character.UnicodeBlock.GREEK));
					test(!isJavaObject("hello world"));
					test(!isJavaObject(2));
					test(!isJavaObject(true));
					test(!isJavaObject(2.0));
					var x = {};
					test(!isJavaObject(x.myUndefinedMember));
					test(!isJavaObject(null));
					test(!isJavaObject({}));
					var javaArray = Packages.java.lang.reflect.Array.newInstance( Packages.java.lang.Object, 4 );
					test(isJavaObject(javaArray));
				</script>
			</li>
			<li class="function">
				<div class="name">toJsArray</div>
				<span>Converts a native Java array into an <code>Array</code>.</span>
				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li><span class="type">java.lang.Object[]</span> A Java array to be converted.</li>
						<li><span class="type">function</span> A function to convert the Java values into script objects.</li>
					</ol>
				</div>
				<div class="returns">
					<div class="label">Returns</div>
					<span class="type">Array</span> An <code>Array</code> containing the elements produced by the function
					argument given the elements in the Java array.
				</div>
				<script type="application/x.jsapi#tests" jsapi:id="toJsArray"><![CDATA[
					var javaArray = Packages.java.lang.reflect.Array.newInstance( Packages.java.lang.String, 3 );
					javaArray[0] = "Hello";
					javaArray[1] = "World";
					javaArray[2] = "David";

					var isWord = function(s) { return s + " is a word."; }
					var stringLength = function(s) { return s.length(); }

					var words = module.toJsArray( javaArray, isWord );
					var lengths = module.toJsArray( javaArray, stringLength );
					var scriptStrings = module.toJsArray( javaArray, function(s) { return String(s); } );

					test( words[1] == "World is a word." );
					test( lengths[1] == 5 );
					test( typeof(scriptStrings[0]) == "string" && scriptStrings[0] == "Hello" );
				]]></script>
				<!--	TODO	-->
			</li>
			<script type="application/x.jsapi#tests" jsapi:id="Properties"><![CDATA[
				var $p = new Packages.java.util.Properties();
				$p.setProperty("a.a", "a");
				$p.setProperty("a.b", "b");
				$p.setProperty("a.c", "c");
				var p = new module.Properties($p);
				var count = 0;
				try {
					for (var x in p.a) {
						count++;
					}
				} catch (e) {
					var error = e;
					debugger;
				}
				test(count == 3);
			]]></script>
			<li class="constructor">
				<div class="name">Thread</div>
				<span>__DESCRIPTION__</span>
				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li class="value">
							<span class="type">function</span>
							<span>__DESCRIPTION__</span>
						</li>
					</ol>
				</div>
				<div class="instances">
					<div class="label">Instances</div>
					<span class="type">__TYPE__</span>
					<span>__DESCRIPTION__</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">start</div>
							<span>__DESCRIPTION__</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<div class="name">__NAME__</div>
										<span>__DESCRIPTION__</span>
										<div class="label">has properties:</div>
										<ul>
											<li class="function">
												<div class="name">returned</div>
												<span>__DESCRIPTION__</span>
												<div class="arguments">
													<div class="label">Arguments</div>
													<ol>
													</ol>
												</div>
												<div class="returns">
													<div class="label">Returns</div>
													<span class="type">__TYPE__</span>
													<span>__DESCRIPTION__</span>
												</div>
											</li>
											<li class="function">
												<div class="name">threw</div>
												<span>__DESCRIPTION__</span>
												<div class="arguments">
													<div class="label">Arguments</div>
													<ol>
													</ol>
												</div>
												<div class="returns">
													<div class="label">Returns</div>
													<span class="type">__TYPE__</span>
													<span>__DESCRIPTION__</span>
												</div>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">__TYPE__</span>
								<span>__DESCRIPTION__</span>
							</div>
						</li>
						<li class="function">
							<div class="name">join</div>
							<span>__DESCRIPTION__</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">__TYPE__</span>
								<span>__DESCRIPTION__</span>
							</div>
						</li>
					</ul>
				</div>
				<div class="label">has properties:</div>
				<div>
					<ul>
						<li class="function">
							<div class="name">thisSynchronize</div>
							<span>
								Creates a function whose execution synchronizes on the <code>this</code> object of its invocation.
							</span>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="value">
										<span class="type">function</span>
										<span>A function which the returned function should execute.</span>
									</li>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">function</span>
								<span>
									A function that obtains the lock to its <code>this</code> object, executes the given function, and
									then releases the lock.
								</span>
							</div>
							<script type="application/x.jsapi#tests" jsapi:id="synchronize"><![CDATA[
								var f = function(x) {
									return 2*x;
								};

								var s = module.Thread.thisSynchronize(f);

								//	TODO	actually test synchronization

								test(s(2) == 4);
								test(s(4) == 8);

								var debug = function(s) {
	//								Packages.java.lang.System.err.println(s);
								}

								var lock = new Packages.java.lang.Object();

								var finished = 0;

								var inner = function() {
									inner.count++;
									Packages.java.lang.Thread.sleep(100);
									inner.count--;
									finished++;
									this.notifyAll();
								}
								inner.count = 0;

								var nested = module.Thread.thisSynchronize(inner);

								var outer = function() {
									outer.count++;
									nested.call(lock);
									outer.count--;
								}
								outer.count = 0;

								var getCount = module.Thread.thisSynchronize(function() {
									return inner.count;
								});

								var runInThread = function(f,callbacks) {
									var thread = new module.Thread(f);
									thread.start(callbacks);
									return thread;
								}

								var threads = [];
								for (var i=0; i<10; i++) {
									threads.push(runInThread(outer, new function() {
										this.returned = function(rv) {
											debug("outer = " + outer.count);
											test(getCount.call(lock) == 0);
										}

										this.threw = function(e) {
											debug("threw = " + e);
											throw e;
										}
									}));
								}

								threads.forEach( function(thread) {
									thread.join();
								});

								test(finished == 10);
							]]></script>
						</li>
					</ul>
				</div>	
			</li>
			<!--
				Experimental methods

				fail(): no real specification, no unit tests

				$doc.members.isJavaType = new $Doc.Function({
					summary: "Determines whether a value is a Java host object representing the given type or not.",
					asFunction: {
						description: <>Creates a function which can determines whether a value is a Java object of the given type or not</>,
						arguments: {
							list: [
								{ type: "JavaClass", comment: <>A Rhino <code>JavaClass</code> object, like <code>Packages.java.lang.Object</code></> }
							]
						},
						returns: {
							type: "function",
							comment: <>Returns a function which takes a single argument and returns <code>true</code> if the given argument is an object of the given Java type and <code>false</code> if it is not.</>
						}
					}
				});
				$doc.members.isJavaType.$unit = function(scope) {
					scope.scenario( new function() {
						this.name = "isJavaType";

						this.execute = function(scope) {
							scope.test(module.isJavaType(Packages.java.lang.Object)(new Packages.java.lang.Object()));
							scope.test(!module.isJavaType(Packages.java.lang.Integer)(new Packages.java.lang.Object()));
							scope.test(module.isJavaType(Packages.java.lang.Object)(new Packages.java.lang.Integer(8)));
							scope.test(module.isJavaType(Packages.java.lang.Runnable)(new Packages.java.lang.Thread()));
						}
					})
				}

				scope.scenario( new function() {
					this.name = "Java types";

					this.execute = function(scope) {
						scope.test( module.isJavaType(Packages.java.io.OutputStream)(new Packages.java.io.ByteArrayOutputStream()) );
						scope.test( module.isJavaType(Packages.java.io.OutputStream)(new Packages.java.io.ByteArrayOutputStream()) );
						scope.test( !module.isJavaType(Packages.java.io.InputStream)("Hello") );
					}
				} );
			-->
			<!--
				//	No unit tests!
				$doc.members.toJavaArray = new $Doc.Function({
					summary: <>Converts an ECMAScript array into a native Java array</>,
					asFunction: {
						description: <>Converts an ECMAScript array into a native Java array</>,
						arguments: {
							list: [
								{ type: <><code>Array</code></>, comment: <>An array to be converted</> },
								{
									type: <>A Java class reference</>,
									comment: <>A reference to a Java class, e.g., <code>Packages.java.lang.Object</code>, representing the type of
										the array to create</>
								}
							]
						},
						returns: {
							type: "A native Java array",
							comment: <>A Java array containing the elements in the ECMAScript array.</>
						}
					}
				});
			-->
		</ul>
	</div>
</body>
</html>