<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.


The Original Code is the SLIME servlet interface.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2014 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>Servlet resources</title>
	<link href="../../../loader/api/api.css" rel="stylesheet" type="text/css" />
	<script src="../../../loader/api/api.js"></script>
</head>
<body>
	<div>__DESCRIPTION__</div>
	<div>
		<h1>Context</h1>
		<ul>
		</ul>
		<script type="application/x.jsapi#context">
			(function() {
				return new function() {
					this.getMimeType = function(file) {
						return "text/plain";
					}
				}
			})()
		</script>
	</div>
	<div>
		<h1>Exports</h1>
		<div class="type">
			<a class="type" name="types.Resources">Resources</a>
			<span>
				An object that is capable of loading resources, as well as enumerating all resources it can load so that they
				can be written out (for example, to a webapp directory).
			</span>
			<div>
				Resources objects consist of an ordered list of <i>mappings</i> which are searched, in order, for
				a given resource.
			</div>
			<div class="label">has properties:</div>
			<ul>
				<li class="function">
					<div class="name">add</div>
					<span>Adds a <i>mapping</i> to this <code>Resources</code>.</span>
					<div class="arguments">
						<div class="label">Arguments</div>
						<ol>
							<li class="object">
								<span>An object describing the mapping.</span>
								<div class="label">has properties:</div>
								<ul>
									<li class="value">
										<div class="name">prefix</div>
										<span class="type">string</span>
										<span>
											All resources under the given directory will be mapped to corresponding
											paths under this prefix.
										</span>
									</li>
									<li class="value">
										<div class="name">directory</div>
										<span class="type"><a href="../../file/api.html#types.directory">directory</a></span>
										<span>A directory.</span>
									</li>
								</ul>
								-or-
								<div class="label">has properties:</div>
								<ul>
									<li class="value">
										<div class="name">prefix</div>
										<span class="type">string</span>
										<span>
											All resources available in the given loader will be mapped to corresponding paths
											under this prefix.
										</span>
									</li>
									<li class="value">
										<div class="name">loader</div>
										<span class="type"><a href="../../../loader/api.html">loader</a></span>
										<span>__DESCRIPTION__</span>
									</li>
								</ul>
							</li>
						</ol>
					</div>
				</li>
				<!--	TODO	map: is it public?	-->
				<!--	TODO	file: is it public?	-->
				<!--	TODO	Loader is undocumented; not sure exactly what it is for, probably to bridge compatibility	-->
				<!--
					Applications need not know about this property
					<li class="value">
						<div class="name">loader</div>
						<span class="type"><a href="../../../loader/api.html#types.Loader">Loader</a></span>
						<span>A loader that loads resources as specified by this <code>Resources</code>.</span>
					</li>
				-->
				<li class="function">
					<div class="name">build</div>
					<span>
						<!--
							TODO	link to Loader type
							TODO	define enumerability more formally, perhaps as part of Loader
						-->
						Copies the resources specified by this <code>Resources</code> to a directory. This method requires that
						all <a href="../../loader/api.html">Loader</a> objects added to the mapping be enumerable (support the
						ability to list their contents).
					</span>
					<div class="arguments">
						<div class="label">Arguments</div>
						<ol>
							<li class="value">
								<span class="type"><a href="../../file/api.html#types.directory">directory</a></span>
								<span>The directory to which the resources should be copied.</span>
							</li>
						</ol>
					</div>
				</li>
			</ul>
		</div>
		<div class="type">
			<a class="type" name="types.resource-mapping-script">resource mapping script</a>
			<span>A <a href="../../../rhino/file/api.html#types.file">file</a> which specifies a mapping between resource paths and the locations at which those resources can be found.</span>
			<div>
				A <i>resource mapping script</i> is executed with the following two properties in its scope:
				<div class="label">has properties:</div>
				<ul>
					<li class="value">
						<div class="name">$mapping</div>
						<span class="type"><a href="../../../rhino/file/api.html#types.file">file</a></span>
						<span>The mapping script itself.</span>
					</li>
					<li class="function">
						<div class="name">add</div>
						<span>Equivalent to <a href="#types.Resoures">Resources</a>.add()</span>
					</li>
					<li class="function">
						<div class="name">map</div>
						<span>Maps a given prefix to a location on the file system.</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
								<li class="value">
									<span class="type">string</span>
									<span>A prefix, which does <em>not</em> include a leading <code>/</code>.</span>
								</li>
								<li class="value">
									<span class="type"><a href="../../file/api.html#types.Pathname">Pathname</a></span>
									<span>A pathname.</span>
								</li>
							</ol>
						</div>
					</li>
				</ul>
			</div>
		</div>

		<ul>
			<li class="constructor">
				<div class="name">Resources</div>
				<span>Creates an empty <a href="#types.Resources">Resources</a>.</span>
				<div class="instances">
					<div class="label">Instances</div>
					<span class="type"><a href="#types.Resources">Resources</a></span>
				</div>
				<div class="label">has properties:</div>
				<ul>
					<li class="function">
						<div class="name">script</div>
						<span>
							A method that uses <a href="#types.resource-mapping-script">resource mapping script</a>s to create
							a <a href="#types.Resources">Resources</a>.
						</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							Each argument is interpreted as a <a href="#types.resource-mapping-script">resource mapping script</a>.
						</div>
						<div class="returns">
							<div class="label">Returns</div>
							<span class="type"><a href="#types.Resources">Resources</a></span>
						</div>
						<div class="label">has properties:</div>
						<ul>
							<li class="constructor">
								<div class="name">Directory</div>
								<span>__DESCRIPTION__</span>
								<div class="arguments">
									<div class="label">Arguments</div>
									<ol>
										<li class="value">
											<span class="type">loader</span>
											<span>__DESCRIPTION__</span>
										</li>
									</ol>
								</div>
								<div class="instances">
									<div class="label">Instances</div>
									<span class="type">__TYPE__</span>
									<span>__DESCRIPTION__</span>
								</div>
							</li>
						</ul>
					</li>
				</ul>
			</li>
		</ul>
		<script type="application/x.jsapi#initialize">
			var code = {};
			var shell = {
				js: jsh.js,
				httpd: code,
				loader: jsh.loader,
				io: jsh.io,
				file: jsh.file
			}
			if (!scope.module) {
				$jsapi.loader.run("plugin.jsh.resources.js", {
					$context: {
						getMimeType: jsh.httpd.nugget.getMimeType
					},
					jsh: shell
				});
				scope.module = shell.httpd;
			}
			jsh.shell.echo("Keys for code: " + Object.keys(code));
			scope.code = code;
		</script>
		<script type="application/x.jsapi#tests">
			var one = code.Resources.script.old(
				$module.getResourcePathname("test/resource/1.old.js").file
			);
			var indexOf = function(value) {
				return function() {
					return this.indexOf(value);
				}
			};
			verify(one,"one").is.not.equalTo(3);
			verify(one).loader.list({ path: "WEB-INF/generic/" }).length.is(1);
			verify(one).loader.list({ path: "WEB-INF/generic/" })[0].is("inonit/");
			verify(one).loader.list({ path: "WEB-INF/generic/inonit/script/servlet/" }).length.is(2);
			verify(one).loader.list({ path: "WEB-INF/generic/inonit/script/servlet/" }).evaluate(indexOf("Servlet.java")).is.not.equalTo(-1);
			verify(one).loader.list({ path: "WEB-INF/generic/inonit/script/servlet/" }).evaluate(indexOf("Nashorn.java")).is.not.equalTo(-1);
			verify(one).loader.list({ path: "WEB-INF/generic/inonit/script/servlet/" }).evaluate(indexOf("JarJarBinks.java")).is(-1);
			verify(one).loader.list({ path: "WEB-INF/" }).length.is(3);
			verify(one).loader.list({ path: "WEB-INF/" })[0].is("generic/");
			verify(one).loader.list({ path: "WEB-INF/" })[1].is("mozilla/");
			verify(one).loader.list({ path: "WEB-INF/" })[2].is("test/");
			verify(one).loader.file("WEB-INF/test/1.file.js").is.not.equalTo(null);
			verify(one).loader.resource("WEB-INF/test/1.txt").read(String).is("1");
		</script>
		<script type="application/x.jsapi#tests">
			verify(code,"code").Resources().is.not.equalTo(3);
			var one = new code.Resources();
			var top = $module.getResourcePathname(".").directory;
			one.add({ prefix: "WEB-INF/generic/", directory: top.getSubdirectory("java") });
			one.add({ prefix: "WEB-INF/mozilla/", directory: top.getSubdirectory("rhino") });
			one.add({ prefix: "WEB-INF/test/", directory: top.getSubdirectory("test") });
			verify(one,"one").is.not.equalTo(3);
//			verify(one).loader().list({ path: "WEB-INF/generic/" }).length().is(1);
//			verify(one).loader().list({ path: "WEB-INF/generic/" })[0]().path().is("inonit");
//			verify(one).loader().list({ path: "WEB-INF/generic/" })[0]().loader().isNotEqualTo(null);
			var child = new one.loader.Child("WEB-INF/generic/");
			verify(child).is.not.equalTo(null);
			if (!jsh.shell.environment.SKIP_LOADER_LIST) {
				verify(child).list({ path: "" }).is.not.equalTo(null);
				var generic = new one.loader.Child("WEB-INF/generic/");
				verify(generic,"generic").list({ path: "" }).is.not.equalTo(null);
				verify(generic,"generic").list({ path: "" }).length.is(1);
				var servlet = new one.loader.Child("WEB-INF/generic/inonit/script/servlet/");
				verify(servlet,"servlet").is.not.equalTo(null);
				var list = servlet.list();
				verify(servlet,"servlet").list().is.not.equalTo(null);
			}
//			verify(one).loader().list({ path: "WEB-INF/generic/inonit/script/servlet/" }).length().is(2);
//			verify(one).loader().list({ path: "WEB-INF/generic/inonit/script/servlet/" })[0]().is("Nashorn.java");
//			verify(one).loader().list({ path: "WEB-INF/generic/inonit/script/servlet/" })[1]().is("Servlet.java");
//			verify(one).loader().list({ path: "WEB-INF/" }).length().is(3);
//			verify(one).loader().list({ path: "WEB-INF/" })[0]().is("generic/");
//			verify(one).loader().list({ path: "WEB-INF/" })[1]().is("mozilla/");
//			verify(one).loader().list({ path: "WEB-INF/" })[2]().is("test/");
//			verify(one).loader().file("WEB-INF/test/1.file.js").isNotEqualTo(null);
//			verify(one).loader().resource("WEB-INF/test/1.txt").read(String).is("1");
		</script>
		<script type="application/x.jsapi#tests">
			var mapping = code.Resources.script($module.getResourcePathname("test/resource/1.hg.js").file);
			verify(mapping).is.not.equalTo(null);
			verify(mapping).loader.is.not.equalTo(null);
			verify(mapping).loader.evaluate.property("list").is.type("function");
			var slime = new mapping.loader.Child("WEB-INF/slime/");
			var byPath = function(path) {
				return function(o) {
					return o.path == path;
				};
			};
			verify(slime).list().evaluate(function() { return this.filter(byPath(".hg")) }).length.is(0);
			verify(slime).list().evaluate(function() { return this.filter(byPath("loader")) }).length.is(1);
			verify(slime).list().evaluate(function() { return this.filter(byPath("jsh")) }).length.is(1);
			jsh.shell.echo(slime.list().map(function(item) { return item.path; }));

			var tmpdir = jsh.shell.TMPDIR.createTemporary({ directory: true });
			mapping.build(tmpdir);
			verify(tmpdir).getSubdirectory("WEB-INF/slime/.hg").is(null);
			verify(tmpdir).getSubdirectory("WEB-INF/slime/jsh").is.not(null);
		</script>
	</div>
</body>
</html>