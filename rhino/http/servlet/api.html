<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>SLIME servlets</title>
	<!--	TODO	change these to use local copies of these files at the appropriate location	-->
	<link rel="stylesheet" type="text/css" href="../../../loader/api/api.css" />
	<script src="../../../loader/api/api.js"></script>
</head>
<body>
	<div>
	</div>
	<div>
		<h1>Scope</h1>
		<div>
			<h2><a id="scope.httpd">httpd</a></h2>
			<p>
				The <code>httpd</code> property represents APIs available to every servlet.
			</p>
			<div class="type">
				<a class="type" name="types.Handler">Handler</a>
				<span>A function that can handle requests.</span>
				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li class="value">
							<span class="type"><a href="#types.request">request</a></span>
							<span>A request.</span>
						</li>
					</ol>
				</div>
				<div class="returns">
					<div class="label">Returns</div>
					<span class="type"><a href="#types.response">response</a></span>
					<span>A response.</span>
				</div>
			</div>
			<ul>
				<li class="value">
					<div class="name">httpd.loader</div>
					<span class="type"><a href="../../../jrunscript/io/api.html#types.Loader">Loader</a></span>
					<span>
						<span>(conditional: not present if no resources specified when mapping the servlet)</span>
						Loads code (and potentially other resources) from the servlet resource loader. Note that unlike Java
						servlet resource loaders, SLIME loaders do not use a leading slash as part of the resource path.
					</span>
				</li>
				<li class="object">
					<div class="name">httpd.http</div>
					<span>Provides HTTP constructs to be used in constructing responses.</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">Response</div>
							<span>Reserved for future use.</span>
							<!--
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type">__TYPE__</span>
								<span>__DESCRIPTION__</span>
							</div>
							-->
							<div class="label">has properties:</div>
							<ul>
								<li class="function">
									<div class="name">text</div>
									<span>Convenience method for returning a <code>text/plain</code> response.</span>
									<div class="arguments">
										<div class="label">Arguments</div>
										<ol>
											<li class="value">
												<span class="type">string</span>
												<span>The text to return.</span>
											</li>
										</ol>
									</div>
									<div class="returns">
										<div class="label">Returns</div>
										<span class="type"><a href="#types.response">response</a></span>
										<span>
											A response object which returns the given response, with a <code>200 OK</code> status
											and no additional headers.
										</span>
									</div>
								</li>
							</ul>
						</li>
					</ul>
				</li>
				<li class="value">
					<div class="name">httpd.Handler</div>
					<span class="type">object</span>
					<!--	TODO	should we include by reference so that tests are run?	-->
					<span>Provides a set of <a href="#types.Handler">Handler</a> implementations. See <a href="server/api.html">detailed documentation</a>.</span>
				</li>
			</ul>
		</div>
		<div>
			<h2>$loader</h2>
			The <code>$loader</code> object is a <em>servlet-specific</em> <a href="../../../jrunscript/io/api.html#Loader">Loader</a>
			that loads resources <em>relative to the servlet's path</em>. The <code>httpd.loader</code> object loads them
			from the application path. So if a servlet is located at <code>/WEB-INF/myapp/servlet.js</code>, it can load a
			JavaScript file at <code>/WEB-INF/myapp/code.js</code> via:
			<ul>
				<li><code>httpd.loader.file("WEB-INF/myapp/code.js")</code>, or</li>
				<li><code>$loader.file("code.js")</code>.</li>
			</ul>
		</div>
		<div>
			<h2><a id="scope.$parameters">$parameters</a></h2>
			The <code>$parameters</code> object contains the set of servlet initialization parameters available to the servlet.
			These are set via the <code>web.xml</code> file when the servlet is declared. <code>$parameters</code> is a JavaScript
			object containing a property for each parameter whose name is the name of the parameter and whose value is the value
			of that parameter.
		</div>
	</div>
	<div>
		<h1><a id="servlet">Servlet Interface</a></h1>
		<div>
			The servlet interacts with its container by assigning properties to its <code>$exports</code> object, provided in the
			scope. Each servlet must, at a minimum, assign a function to <code>$exports.handle</code>:
			<!--	TODO	if it doesn't assign a handle function, then what?	-->
			<!--	TODO	indentation below is lost	-->
			<blockquote><code>
				$exports.handle = function(request) {
					return httpd.http.Response.text("Hello, World!");
				}
			</code></blockquote>
		</div>
		<div>
			SLIME servlets do not have a separate initialization procedure as Java servlets do; they may perform any initialization
			in their script.
		</div>
		<h2>$exports</h2>
		<div class="label">has properties:</div>
		<ul>
			<li class="function">
				<div class="name">handle</div>
				<span class="type"><a href="#types.Handler">Handler</a></span>
				<span>Implements the behavior of the servlet: receives a call for each request, and returns a response.</span>
				<div class="returns">
					<div class="label">Returns</div>
					<span class="type"><a href="#types.response">response</a></span>
					<span>
						The servlet must not return <code>undefined</code>; if it does, the server will return a
						<code>500 Internal Server Error</code> status.
						If the servlet returns <code>null</code>, the server will return a <code>404 Not Found</code> status.
					</span>
				</div>
			</li>
			<li class="function">
				<div class="name">destroy</div>
				<span>(optional) Called by the container when the servlet is destroyed.</span>
			</li>
		</ul>
	</div>
	<div>
		<h1><a id="deployment">Deployment</a></h1>
		<div>
			SLIME servlets may be built into ordinary Java web applications, via either the <code>jsh.httpd.tools</code> API or
			via the <code>rhino/http/servlet/tools/webapp.jsh.js</code> script.
		</div>
		<div>
			See the documentation for <a href="tools/plugin.jsh.api.html">jsh.httpd.tools</a> for how to use the API to build
			a standard Java webapp.
		</div>
		<div>
			The <code>webapp.jsh.js</code> script is a <code>jsh</code> script, and takes the following command-line arguments:
			<ul>
				<li>
					<strong><code>-to <i>pathname</i></code></strong>
					The pathname to which to build the webapp. If not present, it will be created. If present, it will be deleted
					and re-created.
				</li>
				<li>
					<strong><code>-recursive</code></strong>
					Whether to create the parent directories of the <code>-to</code> pathname if they are not present.
				</li>
				<li>
					<strong><code>-library <i>name</i>=<i>pathname</i></code></strong>
					(optional; can be specified multiple times)
					Specifies the name and location of a Java library to be added to the resulting webapp.
				</li>
				<li>
					<strong><code>-servletapi <i>pathname</i></code></strong>
					(optional if Tomcat is installed in the invoked <code>jsh</code>; in that case, the Java servlet API used by
					Tomcat will be used)
					The pathname at which the Java Servlet API can be found.
				</li>
				<li>
					<strong><code>-compile <i>pathname</i></code></strong> (optional; can be specified multiple times):
					A pathname under which Java files can be found which should be compiled and added to the webapp.
				</li>
				<li>
					<strong><code>-resources <i>pathname</i></code></strong> (can be specified multiple times):
					The pathname of a <a href="plugin.jsh.resources.api.html#types.resource-mapping-script">resource mapping script</a> that specifies resources
					to be included in the webapp.
				</li>
				<!--
				<li>
					<strong><code>-norhino</code></strong>
					Indicates that Mozilla Rhino should not be included in the web application.
				</li>
				-->
				<li>
					<!--
						TODO	this is a lot of indirection. Should we bother trying to reverse-engineer the path from the servlet
								location or just explain it better?
					-->
					<strong><code>-servlet <i>path</i></code></strong>
					The path to the SLIME servlet in the context of this web application: in other words, the relative path
					to the SLIME servlet in the resulting web application directory, based on the mapping specified by the
					<code>-resources</code> argument(s).
				</li>
				<li>
					<strong><code>-parameter <i>name=value</i></code></strong>
					Specifies a servlet parameter to use in <code>web.xml</code>.
				</li>
				<li>
					<strong><code>-java:version <i>version</i></code></strong> (optional)
					Specifies a target Java version to use when compiling the web application.
				</li>
			</ul>
		</div>
	</div>
</body>
</html>
