<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>HTTP client</title>
	<link rel="stylesheet" type="text/css" href="../../../loader/api/api.css"></link>
	<script type="text/javascript" src="../../../loader/api/api.js"></script>
</head>
<body>
	<script type="application/x.jsapi#initialize"><![CDATA[
		var fixtures = $jsapi.loader.module("test/fixtures.ts");
		fixtures(
			Packages,
			JavaAdapter,
			jsh,
			{
				environment: $jsapi.environment,
				loader: $jsapi.loader
			},
			scope
		)
	]]></script>
	<div>
		<h1>Exports</h1>
		<ul>
			<li class="constructor">
				<div class="name">Client</div>
				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li class="object">
							<div class="label">has properties:</div>
							<ul>
								<li class="function">
									<script type="application/x.jsapi#tests" jsapi:id="spi"><![CDATA[
										if (!$jsapi.environment.windowsSocketsError10106 && !context.notomcat) {
											var client = new module.Client({
												spi: function(original) {
													return function(p) {
														var buffer = new context.io.Buffer();
														//	TODO	below was buffer.writeText("Hello, Dude!"), which counterintuitively, silently
														//			failed; consider alternatives for jrunscript/io
														buffer.writeText().write("Hello, Dude!");
														buffer.close();
														return {
															status: {
																code: 200,
																reason: "OK"
															},
															headers: [
																{ name: "Content-Type", value: "text/plain" }
															],
															stream: buffer.readBinary()
														}
													}
												}
											});
											var redirected = false;
											servlet.set(function(request,response) {
												response.setContentType("text/plain");
												response.getWriter().print("Hello, World!");
											});
											var response = client.request({
												method: "GET",
												url: "http://127.0.0.1:" + context.port + "/"
												,evaluate: function(response) {
													return response;
												}
											});
											//	TODO	add jrunscript/io Resource capability
											verify(response.body.stream.character().asString()).is("Hello, Dude!");
										} else {
											test(skip("No Tomcat"));
										}
									]]></script>
								</li>
								<li class="function">
									<div class="name">proxy</div>
									<script type="application/x.jsapi#tests">
										if (!context.notomcat) {
											servlet.set(function(_request,_response) {
												_response.getWriter().print(_request.getHeader("host"));
											});
											var lastArgument;
											var client = new module.Client({
												proxy: function(request) {
													lastArgument = request;
													return {
														http: {
															host: "127.0.0.1",
															port: context.port
														}
													}
												}
											});
											var host = client.request({
												url: "http://foo.bar/baz",
												evaluate: function(response) {
													return response.body.stream.character().asString();
												}
											});
											verify(lastArgument).url.is("http://foo.bar/baz");
											verify(host).is("foo.bar");
										}
									</script>
								</li>
								<li class="value">
									<div class="name">proxy</div>
									<span class="type"><a href="#types.proxy">proxy</a></span>
									<script type="application/x.jsapi#tests">
										if (!context.notomcat) {
											var all = new module.Client({
												proxy: {
													http: {
														host: "127.0.0.1",
														port: context.port
													}
												}
											});
											var host2 = all.request({
												url: "http://foo.bar.baz/",
												evaluate: function(response) {
													return response.body.stream.character().asString();
											}
											});
											verify(host2).is("foo.bar.baz");
										}
									</script>
								</li>
							</ul>
						</li>
					</ol>
				</div>
				<script type="application/x.jsapi#initialize">
					scope.Cookie = Packages.javax.servlet.http.Cookie;
					scope.skip = function(verify,message) {
						if (typeof(verify) == "string") {
							jsh.shell.console("DEPRECATED: skip(string) in api.html");
							return {
								success: true,
								messages: {
									success: "SKIP: " + verify
								}
							}
						}
						if (!message) message = "Skipping: no Tomcat";
						verify(message).is(message);
					};
					scope.getServerRequestCookies = function(request) {
						if (request.getCookies() === null) return [];
						return jsh.java.Array.adapt(request.getCookies()).filter(function(_cookie) {
							return _cookie.getName() != "JSESSIONID";
						}).map(function(_cookie) {
							return { name: String(_cookie.getName()), value: String(_cookie.getValue()) }
						});
					};
					scope.hasDefaultCookieHandler = Boolean(Packages.java.net.CookieHandler.getDefault());
				</script>
				<div class="instances">
					<div class="label">Instances</div>
					<div class="label">has properties:</div>
					<ul>
						<li class="function">
							<div class="name">request</div>
							<span>
								Issues a request to a server and returns that server's response, after following any redirects.
							</span>
							<div class="type">
								<a class="type" name="types.request.url">url</a>
								<span>
									A string or a <code>js/web</code> <a href="../../../js/web/api.html">Url</a> object representing
									a web URL.
								</span>
							</div>
							<div class="arguments">
								<div class="label">Arguments</div>
								<ol>
									<li class="object">
										<span>
											An object representing the request, with an optional <code>parse</code> property that
											processes the response.
										</span>
										<div class="label">has properties:</div>
										<ul>
											<li class="value">
												<div class="name">method</div>
												<span class="type">string</span>
												<span>
													(optional)
													The HTTP request method to use. If omitted, a <code>GET</code> is issued.
												</span>
											</li>
											<li class="value">
												<!--	TODO	merge with same notion from client side?	-->
												<div class="name">url</div>
												<span class="type"><a href="#types.request.url">url</a></span>
												<span>The URL to which to issue the request.</span>
											</li>
											<li class="deprecated value">
												<div class="name">parameters</div>
												<span class="type"><a href="#types.parameters">parameters</a></span>
												<span>
													(optional)
													Additional parameters to send to the request as part of the URL.
												</span>
											</li>
											<li class="value">
												<div class="name">authorization</div>
												<span class="type"><a href="#types.authorization">authorization</a></span>
												<span>Credentials information to be used to authorize this request.</span>
											</li>
											<li class="value">
												<div class="name">headers</div>
												<span class="type"><a href="#types.parameters">parameters</a></span>
												<span>
													(optional)
													Additional headers to send with this request.
												</span>
											</li>
											<li class="object">
												<div class="name">body</div>
												<span class="type"><a href="#types.body">body</a></span>
												<span>
													(optional)
													The message body to use with the HTTP request. If no <code>type</code> property
													is provided, <code>application/octet-stream</code> will be used. Must specify
													its content in some way. If a <code>stream</code> property is present, it
													will be read to provide the content of the message body. Otherwise, if a
													<code>string</code> property is present, its content will be used.
												</span>
											</li>
											<li class="value">
												<div class="name">proxy</div>
												<span class="type"><a href="#types.proxy">proxy</a></span>
												<span>The proxy server to use for this request.</span>
											</li>
											<li class="object">
												<div class="name">timeout</div>
												<span>
													(optional)
												</span>
												<div class="label">has properties:</div>
												<ul>
													<li class="value">
														<div class="name">connect</div>
														<span class="type">number</span>
														<span>
															A timeout, in milliseconds, that should be used when attempting
															to connect to a remote URL.
														</span>
													</li>
													<li class="value">
														<div class="name">read</div>
														<span class="type">number</span>
														<span>
															A timeout, in milliseconds, that should be used when attempting to
															read a remote URL.
														</span>
													</li>
												</ul>
											</li>
											<li class="object">
												<div class="name">on</div>
												<span>An object containing a set of properties representing callbacks.</span>
												<div class="label">has properties:</div>
												<ul>
													<li class="function">
														<div class="name">redirect</div>
														<!--	What 'this' parameter will be used?	-->
														<span>A function that will be invoked if the request is redirected.</span>
														<div class="arguments">
															<div class="label">Arguments</div>
															<ol>
																<li class="object">
																	<span>__DESCRIPTION__</span>
																	<div class="label">has properties:</div>
																	<ul>
																		<li class="value">
																			<div class="name">request</div>
																			<span class="type">__TYPE__</span>
																			<span>__DESCRIPTION__</span>
																		</li>
																		<li class="value">
																			<div class="name">response</div>
																			<span class="type">__TYPE__</span>
																			<span>__DESCRIPTION__</span>
																		</li>
																		<li class="value">
																			<div class="name">next</div>
																			<span class="type">__TYPE__</span>
																			<span>
																				This property may be removed from the
																				object in order to stop the client from following
																				the redirect.
																			</span>
																		</li>
																	</ul>
																</li>
															</ol>
														</div>
													</li>
												</ul>
											</li>
											<li class="function">
												<div class="name">evaluate</div>
												<span class="type"><a href="#types.parser">parser</a></span>
												<span>
													(optional)
													A function that interprets the response from the server and returns it to the
													caller of <code>request()</code> automatically.
												</span>
											</li>
										</ul>
									</li>
								</ol>
							</div>
							<div class="returns">
								<div class="label">Returns</div>
								<span class="type"><a href="#types.response">response</a></span>
								-or-
								<span class="type">(any)</span>
								<span>
									Returns the response, unless a <code>parse</code> function was
									provided; in that case, the result of that function is returned.
								</span>
							</div>
							<script type="application/x.jsapi#tests" jsapi:id="Hello World"><![CDATA[
								if (!$jsapi.environment.windowsSocketsError10106 && !context.notomcat) {
									var client = new module.Client();
									servlet.set(function(request,response) {
										//	Nashorn does not allow request.getMethod() to be accessed through verify()
										var getRequestMethod = function() {
											return String(this._request.getMethod().toUpperCase());
										}
										verify({ _request: request }).evaluate(getRequestMethod).is("GET");
										response.getWriter().print("Hello, World!");
									});
									var response = client.request({
										method: "GET"
										,url: "http://127.0.0.1:" + context.port + "/"
										,evaluate: function(response) {
											return response.body.stream.character().asString();
										}
									});
									verify(response).is("Hello, World!");

									var byUrlObject = client.request({
										url: jsh.js.web.Url.parse("http://127.0.0.1:" + context.port + "/")
										,evaluate: function(response) {
											return response.body.stream.character().asString();
										}
									});
									verify(byUrlObject,"byUrlObject").is("Hello, World!");
								} else {
									skip(verify);
								}
							]]></script>
							<script type="application/x.jsapi#tests" jsapi:id="Cookie"><![CDATA[
								if (!$jsapi.environment.windowsSocketsError10106 && !context.notomcat && !hasDefaultCookieHandler) {
									var client = new module.Client();
									servlet.set(function(request,response) {
										jsh.shell.echo("Received request; verify = " + verify);
										jsh.shell.echo("request.getCookies() = " + request.getCookies());
										//	TODO	for some reason with Nashorn, the verify() version of this statement does not work
										test(request.getCookies() === null);
										//verify(request,"initial servlet request").getCookies().is(null);
										jsh.shell.echo("Cookie = " + Cookie);
										jsh.shell.echo("response.addCookie = " + response.addCookie);
										response.addCookie(new Cookie("cname", "cvalue"));
										jsh.shell.echo("addCookie returned");
										response.setContentType("text/plain");
										jsh.shell.echo("setContentType returned");
										response.getWriter().print("Hello, World!");
										jsh.shell.echo("getWriter().print returned");
										jsh.shell.echo("Reached end of set()");
									});
									var response = client.request({
										method: "GET"
										,url: "http://127.0.0.1:" + context.port + "/"
									});
									var type = response.body.type.toString();
									verify(type).is.not(null);
									verify(type.split(";"))[0].is.not(null);
									verify(response,"initial response").body.evaluate(function() { return this.type.toString().split(";")[0] }).is("text/plain");
									if (response.body.type.toString().substring(0,"text/html".length) == "text/html") {
										jsh.shell.echo("HTML response: " + response.body.stream.character().asString());
									}
									servlet.set(function(request,response) {
										var cookies = getServerRequestCookies(request);
										verify(cookies,"second servlet request cookies").length.is(1);
										verify(cookies,"cookies")[0].name.is("cname");
										verify(cookies,"cookies")[0].value.is("cvalue");
									});
									client.request({
										method: "GET"
										,url: "http://127.0.0.1:" + context.port + "/"
									});
								} else {
									skip(verify, "No Tomcat, or WebView present");
								}
							]]></script>
							<script type="application/x.jsapi#tests" jsapi:id="Redirect"><![CDATA[
								if (!$jsapi.environment.windowsSocketsError10106 && !context.notomcat && !hasDefaultCookieHandler) {
									var client = new module.Client();
									var redirected = false;
									servlet.set(function(request,response) {
										jsh.shell.echo("getting cookies " + request.getCookies());
										var cookies = getServerRequestCookies(request);
										jsh.shell.echo("cookies: " + JSON.stringify(cookies));
										if (request.getRequestURI() == "/") {
											verify(cookies).length.is(0);
											response.addCookie(new Cookie("rname", "rvalue"));
											response.sendRedirect("./redirected");
										} else if (request.getRequestURI() == "/redirected") {
											redirected = true;
											verify(cookies).length.is(1);
			//								test(Boolean(request.getCookies()) && request.getCookies().length == 1);
											response.setContentType("text/plain");
											response.getWriter().print("Redirected!");
										} else {
											debugger;
											test(false, "Wrong URL: " + request.getRequestURI());
										}
									});
									var response = client.request({
										method: "GET",
										url: "http://127.0.0.1:" + context.port + "/"
										,evaluate: function(response) {
											jsh.shell.echo("response = " + response.status.code);
											jsh.shell.echo("error = ")
											return response;
										}
									});
									verify(redirected,"redirected").is(true);
								} else {
									skip(verify, "No Tomcat, or WebView present");
								}
							]]></script>
							<script type="application/x.jsapi#tests" jsapi:id="urlWithQueryString"><![CDATA[
								if (!$jsapi.environment.windowsSocketsError10106 && !context.notomcat) {
									var client = new module.Client();
									servlet.set(function(request,response) {
										response.getWriter().print(request.getRequestURL()+"?"+request.getQueryString());
									});
									var url = "http://127.0.0.1:" + context.port + "/hello?world=earth";
									var response = client.request({
										method: "GET"
										,url: url
										,evaluate: function(response) {
											return response.body.stream.character().asString();
										}
									});
									verify(response).is(url);
								} else {
									skip(verify);
								}
							]]></script>
						</li>
					</ul>
				</div>
			</li>
		</ul>
	</div>
</body>
</html>