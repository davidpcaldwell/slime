<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the rhino/io SLIME module.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2010-2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>Rhino Input/Output</title>
	<link rel="stylesheet" type="text/css" href="../../loader/api/api.css"></link>
	<script type="text/javascript" src="../../loader/api/api.js"></script>
</head>
<body>
	<div>
		Much of the content of the <code>rhino/io</code> module has been moved to the
		<a href="../../loader/rhino/api.html">Java SLIME loader</a>, which supplies the
		<code>Reader</code>, <code>Writer</code>, <code>OutputStream</code>, <code>Resource</code>, and <code>Loader</code>
		exports.
		<!--	TODO	clean up the linking	-->
	</div>
	<div>
		<h1>Context</h1>
		<div class="label">has properties:</div>
		<ul>
			<li class="value">
				<div class="name">$rhino</div>
				<span class="type">__TYPE__</span>
				<span>__DESCRIPTION__</span>
			</li>
			<li class="object">
				<div class="name">api</div>
				<span>__DESCRIPTION__</span>
				<div class="label">has properties:</div>
				<ul>
					<li class="value">
						<div class="name">js</div>
						<span>A js/object-compatible module.</span>
					</li>
					<li class="value">
						<div class="name">java</div>
						<span>A rhino/host-compatible module.</span>
					</li>
				</ul>
			</li>
			<li class="value">
				<div class="name">nojavamail</div>
				<span class="type">boolean</span>
				<span>__DESCRIPTION__</span>
			</li>
		</ul>
	</div>
	<script type="application/x.jsapi#initialize">
		var context = new function() {
			var java = $jsapi.loader.module("../../rhino/host/", {
				$rhino: jsh.unit.$jsh
			});
			if (!java) throw new Error("Not found: rhino/host/");

			this.$java = jsh.unit.$jsh;

			this.api = {
				js:  $jsapi.loader.module("../../js/object/", { globals: true }),
				java: java
			};
		};
		scope.context = context;
		scope.module = $jsapi.loader.module("module.js", context);
	</script>
	<div>
		<h1>Exports</h1>
		<div class="type">
			<a class="type" id="types.InputStream">InputStream</a>
			<span class="type">supports <a href="../../loader/rhino/io.api.html">InputStream</a></span>
			<div class="label">has properties:</div>
			<ul>
				<li class="function">
					<div class="name">asProperties</div>
					<span>__DESCRIPTION__</span>
					<div class="arguments">
						<div class="label">Arguments</div>
						<ol>
						</ol>
					</div>
					<div class="returns">
						<div class="label">Returns</div>
						<span class="type">__TYPE__</span>
						<span>__DESCRIPTION__</span>
					</div>
				</li>
				<li class="constructor">
					<div class="name">Resource</div>
					<span>__DESCRIPTION__</span>
					<div class="arguments">
						<div class="label">Arguments</div>
						<ol>
						</ol>
					</div>
					<div class="instances">
						<div class="label">Instances</div>
						<span class="type">__TYPE__</span>
						<span>__DESCRIPTION__</span>
					</div>
				</li>
			</ul>
		</div>

		<ul>
			<li class="object" jsapi:reference="getApi('../../loader/rhino/io.api.html').getElement('exports/Streams')">
			</li>
			<li class="constructor">
				<div class="name">Buffer</div>
				<span>
					Extends the Java SLIME loader <a href="../../loader/rhino/io.api.html">Buffer</a> constructor to produce
					<code>Buffer</code> objects that use <code>InputStream</code> objects from this module.
				</span>
			</li>
			<li class="constructor" jsapi:reference="getApi('../../loader/rhino/io.api.html').getElement('exports/Resource')">
			</li>
			<li class="constructor">
				<div class="name">Loader</div>
				<span>
					Invokes the Java SLIME loader <a href="../../loader/rhino/api.html#exports.Loader">Loader</a> constructor.
				</span>
				<div jsapi:reference="getApi('../../loader/rhino/api.html').getElement('Loader/type/tests')">
				</div>
				<script type="application/x.jsapi#tests">
					if (false) {
						var loader = new module.Loader({
							resources: {
								get: function(path) {
									var file = $jsapi.loader.getRelativePath(path).file;
									if (!file) return null;
									var type = (function() {
										if (/\.jsh\.js$/.test(path)) {
											return new module.mime.Type("application", "x.jsh");
										} else if (/\.js$/.test(path)) {
											return new module.mime.Type("application", "javascript");
										} else if (/\.html$/.test(path)) {
											return new module.mime.Type("text", "html");
										} else {
											return new module.mime.Type("application", "octet-stream");
										}
									})();
									return {
										type: type,
										read: {
											binary: function() {
												return file.read(jsh.io.Streams.binary);
											}
										}
									};
								}
							}
						});
						var api = loader.get("api.html");
						test(api.type.toString() == "text/html");

						var loaderModule = loader.module("test/Loader.js");
						test(loaderModule.file.foo == "bar");
						test(loaderModule.resource("Loader.js") != null);
						test(loaderModule.resource("test/Loader.js") == null);
						test(loaderModule.grandchildResource("file.js") != null);
						test(loaderModule.grandchildResource("Loader/file.js") == null);
						test(loaderModule.grandchildResource("test/Loader/file.js") == null);
					}
				</script>
				<script type="application/x.jsapi#tests">
					var sources = new function() {
						var code = {

						};

						this.get = function(path) {
							return null;
						};

						this.Loader = function(prefix) {
							this.list = function() {
								return [];
							}
						}
					}
					var loader = new module.Loader(sources);
					verify(loader).evaluate(function() { return this.run; }).is.not.equalTo(null);
					var child = new loader.Child("prefix/");
					verify(child).evaluate(function() { return this.run; }).is.not.equalTo(null);
				</script>
			</li>
			<li class="object">
				<div class="name">java</div>
				<div class="label">has properties:</div>
				<ul>
					<li class="function">
						<div class="name">adapt</div>
						<span>Converts a Java object to a corresponding type from this package.</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
								<li class="value">
									<span class="type">JavaClass java.io.InputStream</span>,
									<span class="type">JavaClass java.io.Reader</span>,
									<span class="type">JavaClass java.io.OutputStream</span>,
									or
									<span class="type">JavaClass java.io.Writer</span>
									<span>A Java object to convert.</span>
								</li>
							</ol>
						</div>
						<div class="returns">
							<div class="label">Returns</div>
							<span class="type"><a href="#types.binput">byte input stream</a></span>,
							if the argument was a Java <code>java.io.InputStream</code>,
							<span class="type"><a href="#types.boutput">byte output stream</a></span>, if the
							argument was a Java <code>java.io.OutputStream</code>.
							<span class="type"><a href="#types.cinput">character input stream</a></span>, if the
							argument was a Java <code>java.io.Reader</code>.
							<span class="type"><a href="#types.coutput">character output stream</a></span>, if the
							argument was a Java <code>java.io.Writer</code>.
						</div>
						<script type="application/x.jsapi#tests">
							var $out = new Packages.java.io.ByteArrayOutputStream();
							var out = module.java.adapt($out);
							test(out != null);
						</script>
					</li>
				</ul>
			</li>
			<li class="value">
				<div class="name">mime</div>
				<span class="type">object</span>
				<span>See <a href="mime.api.html">detailed documentation</a>.</span>
			</li>
			<li class="object">
				<div class="name">archive</div>
				<span>
					An <dfn>archive</dfn> format is a format that can encode a series of resources with paths (like a directory
					structure) as a single stream, and decode that stream into a series of resources with paths.
				</span>
				<div class="label">has properties:</div>
				<ul>
					<li class="object">
						<script type="application/x.jsapi#initialize">
							scope.readFile = function() {
								return this.read(String);
							};
						</script>
						<div class="name">zip</div>
						<span>__DESCRIPTION__</span>
						<div class="label">has properties:</div>
						<ul>
							<li class="function">
								<div class="name">encode</div>
								<span>__DESCRIPTION__</span>
								<div class="arguments">
									<div class="label">Arguments</div>
									<ol>
									</ol>
								</div>
								<div class="returns">
									<div class="label">Returns</div>
									<span class="type">__TYPE__</span>
									<span>__DESCRIPTION__</span>
								</div>
								<script type="application/x.jsapi#tests">
									var expanded = jsh.shell.TMPDIR.createTemporary({ directory: true });
									expanded.getRelativePath("a").write("aa", { append: false });
									expanded.getRelativePath("b/c").write("cc", { append: false, recursive: true });
									var zip = jsh.shell.TMPDIR.createTemporary({ suffix: ".zip" }).pathname;
									zip.file.remove();
									var unzip = jsh.shell.TMPDIR.createTemporary({ directory: true });
									module.archive.zip.encode({
										stream: zip.write(jsh.io.Streams.binary),
										entries: [
											{ path: "a", resource: expanded.getFile("a") },
											{ path: "b/c", resource: expanded.getFile("b/c") }
										]
									});
									module.archive.zip.decode({
										stream: zip.file.read(jsh.io.Streams.binary),
										output: {
											directory: function(p) {
												unzip.getRelativePath(p.path).createDirectory();
											},
											file: function(p) {
												return unzip.getRelativePath(p.path).write(jsh.io.Streams.binary, { append: false });
											}
										}
									});
									verify(unzip).getFile("a").evaluate(readFile).is("aa");
									verify(unzip).getFile("b/c").evaluate(readFile).is("cc");
								</script>
							</li>
							<li class="function">
								<div class="name">decode</div>
								<span>__DESCRIPTION__</span>
								<div class="arguments">
									<div class="label">Arguments</div>
									<ol>
									</ol>
								</div>
								<div class="returns">
									<div class="label">Returns</div>
									<span class="type">__TYPE__</span>
									<span>__DESCRIPTION__</span>
								</div>
								<script type="application/x.jsapi#tests">
									var expanded = jsh.shell.TMPDIR.createTemporary({ directory: true });
									expanded.getRelativePath("a").write("a", { append: false });
									expanded.getRelativePath("b/c").write("c", { append: false, recursive: true });
									var zipped = jsh.shell.TMPDIR.createTemporary({ suffix: ".zip" }).pathname;
									zipped.file.remove();
									var to = jsh.shell.TMPDIR.createTemporary({ directory: true });
									var path = jsh.file.Searchpath([jsh.shell.java.home.getRelativePath("bin"),jsh.shell.java.home.parent.getRelativePath("bin")]);
									jsh.shell.run({
										command: path.getCommand("jar"),
										arguments: ["cf", zipped, "a", "b"],
										directory: expanded
									});
									module.archive.zip.decode(
										{
											stream: zipped.file.read(jsh.io.Streams.binary),
											output: {
												directory: function(p) {
													to.getRelativePath(p.path).createDirectory();
												},
												file: function(p) {
													return to.getRelativePath(p.path).write(jsh.io.Streams.binary, { append: false });
												}
											}
										}
									);
									verify(to).getFile("a").is.type("object");
									verify(to).getFile("aa").is.type("null");
								</script>
							</li>
						</ul>
					</li>
				</ul>
			</li>
		</ul>
		<!--	TODO	below tests are intertwined with this module despite mostly pertaining to Java SLIME loader; refactor	-->
		<script type="application/x.jsapi#tests">
			var string = "Hello\nWorld";
			var buffer = new module.Buffer();
			buffer.writeBinary().character().write(string);
			buffer.close();
			var resource = buffer.readBinary().cache();
			var lines = [];
			resource.read.lines(function(item) {
				lines.push(item);
			}, { ending: "\n" });
			test(lines[0] == "Hello");
			test(lines[1] == "World");
		</script>
		<script type="application/x.jsapi#tests" jsapi:id="Buffer">
			var buffer = new module.Buffer();
			var writer = buffer.writeText();
			writer.write("Buffer");
			buffer.close();
			var resource = buffer.readBinary().cache();
			test(resource.read(String) == "Buffer");
			test(resource.read(String) == "Buffer");
		</script>
		<script type="application/x.jsapi#initialize">
			var p = new Packages.java.util.Properties();
			buffer = new scope.module.Buffer();
			p.put("yes", "i do");
			p.put("laptop", "inonit");
			p.put("laptop.manufacturer", "dell");
			p.store(buffer.writeBinary().java.adapt(), "No comment!");
			buffer.close();
			scope.buffer = buffer;
		</script>
		<script type="application/x.jsapi#tests" jsapi:id="Properties">
			var props = buffer.readBinary().asProperties();
			test( props.yes == "i do" );
			test( props.laptop == "inonit" );
			test( props.laptop.manufacturer == "dell" );
		</script>
		<!--	TODO	document the below ability	-->
		<script type="application/x.jsapi#tests" jsapi:id="java.util.Properties">
			var buffer = new module.Buffer();

			var p = new Packages.java.util.Properties();
			p.put("yes", "i do");
			p.put("laptop", "inonit");
			p.put("laptop.manufacturer", "dell");
			p.store(buffer.writeBinary().java.adapt(), "No comment!");
			buffer.close();

			var resource = new (buffer.readBinary()).Resource(new context.$java.mime.Type("text","plain"));

			var props = resource.read(Packages.java.util.Properties);
			test( props.get("yes") == "i do" );
			test( props.get("laptop") == "inonit" );
			test( props.get("laptop.manufacturer") == "dell" );
		</script>
	</div>
</body>
</html>