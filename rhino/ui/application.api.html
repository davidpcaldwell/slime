<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the SLIME loader infrastructure.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>__TITLE__</title>
	<!--	TODO	change these to use local copies of these files at the appropriate location	-->
	<!--
		These files are specified using http: rather than https: because githack.com will redirect them to https:, but http: will
		work when using an HTTP proxy to serve local copies of the files without needing to run https: locally
	-->
	<link href="http://bb.githack.com/davidpcaldwell/slime/raw/tip/loader/api/api.css" rel="stylesheet" type="text/css" />
	<script src="http://bb.githack.com/davidpcaldwell/slime/raw/tip/loader/api/api.js"></script>
	<script>
		//	TODO	CORS
		document.domain = document.domain;
	</script>
</head>
<body>
	<div>__DESCRIPTION__</div>
	<div>
		<h1>Context</h1>
		<ul>
		</ul>
	</div>
	<div>
		<h1>Exports</h1>
		<ul>
			<li class="function" jsapi:id="top">
				<div class="name">
					<a id="exports.javafx.Webview.application"><!-- TODO remove when deprecated function removed; search for usages --></a>
					<a id="exports.browser"><!-- TODO remove when deprecated function removed; search for usages --></a>
					<a id="exports.application">application</a></div>
				<span>__DESCRIPTION__</span>
				<div class="type">
					<a class="type" name="types.application.servlet">servlet</a>
					<span>A <a href="../http/servlet/api.html#servlet">servlet</a> <!-- TODO check link --> to run.</span>
					<div>
						<span class="type"><a href="../file/api.html#types.file">file</a></span>
						<span>A file containing the servlet implementation code.</span>
					</div>
					- OR -
					<div class="label">has properties:</div>
					<ul>
						<li class="value">
							<div class="name">resource</div>
							<span class="type">string</span>
							<span>A resource path at which the servlet implementation code can be found.</span>
						</li>
					</ul>
					- OR -
					<div class="label">has properties:</div>
					<ul>
						<li class="value">
							<div class="name">$loader</div>
							<span class="type">__TYPE__</span>
							<span>__DESCRIPTION__</span>
						</li>
						<li class="value">
							<div class="name">path</div>
							<span class="type">__TYPE__</span>
							<span>__DESCRIPTION__</span>
						</li>
					</ul>
				</div>

				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li class="object">
							<span>An argument describing the application.</span>
							<div class="label">has properties:</div>
							<ul>
								<!--	TODO	other forms of servlet	-->
								<li class="object">
									<div class="name">server</div>
									<span>
										(optional; if omitted, a Tomcat server will be created using
										<code>port</code>, <code>resources</code>, <code>servlet</code> and <code>parameters</code>
										properties)
									</span>
									<div class="label">has properties:</div>
									<ul>
										<li class="value">
											<div class="name">port</div>
											<span class="type">number</span>
											<span>__DESCRIPTION__</span>
										</li>
										<li class="function">
											<div class="name">start</div>
											<span>__DESCRIPTION__</span>
											<div class="arguments">
												<div class="label">Arguments</div>
												<ol>
												</ol>
											</div>
											<div class="returns">
												<div class="label">Returns</div>
												<span class="type">__TYPE__</span>
												<span>__DESCRIPTION__</span>
											</div>
										</li>
										<li class="function">
											<div class="name">stop</div>
											<span>__DESCRIPTION__</span>
											<div class="arguments">
												<div class="label">Arguments</div>
												<ol>
												</ol>
											</div>
											<div class="returns">
												<div class="label">Returns</div>
												<span class="type">__TYPE__</span>
												<span>__DESCRIPTION__</span>
											</div>
										</li>
									</ul>
								</li>
								<li class="value">
									<div class="name">port</div>
									See <a href="../../rhino/http/servlet/plugin.jsh.api.html#$exports.Tomcat">Tomcat</a>.
								</li>
								<li class="value">
									<div class="name">resources</div>
									<span class="type">Loader</span>
									<span>The resources available to the server resource loader.<!--	TODO	hyperlink?	--></span>
								</li>
								<li class="value">
									<div class="name">servlet</div>
									<span class="type"><a href="#types.application.servlet">servlet</a></span>
									<span>A <a href="../http/servlet/api.html">servlet</a> <!-- TODO check link --> to run.</span>
								</li>
								<li class="value">
									<div class="name">parameters</div>
									<span class="type">object</span>
									<span>
										An object to supply to the servlet as its <code>$parameters</code> object.
									</span>
								</li>
								<li class="object">
									<div class="name">on</div>
									<span>(optional)</span>
									<div class="label">has properties:</div>
									<ul>
										<li class="function">
											<div class="name">close</div>
											<span>
												A callback function invoked when the application is closed. The application is
												closed when the browser within which it is running closes.
											</span>
										</li>
									</ul>
								</li>
								<li class="object">
									<div class="name">browser</div>
									<span>An object providing information about the browser to run.</span>
									<div class="label">has properties:</div>
									<ul>
										<li class="value">
											<div class="name">host</div>
											<span class="type">string</span>
											<span>
												A host name to use when running the application. The name will be used as the
												authority section of the client-side URL; the value <code>host</code> will produce
												a URL like <code>http://host/<i>page</i></code>. The browser will also be provided
												with proxy settings routing all requests for this host name to the local port on
												which the server is running, unless the <code>proxy</code> property is also
												specified.
											</span>
										</li>
										<li class="function">
											<div class="name">proxy</div>
											<span>A function that can create appropriate browser proxy settings.</span>
											<div class="arguments">
												<div class="label">Arguments</div>
												<ol>
													<li class="object">
														<span>An object describing the application environment.</span>
														<div class="label">has properties:</div>
														<ul>
															<li class="value">
																<div class="name">port</div>
																<span class="type">number</span>
																<span>The port number on which the server is running.</span>
															</li>
														</ul>
													</li>
												</ol>
											</div>
											<div class="returns">
												<div class="label">Returns</div>
												<span class="type">object</span>
												<span>An argument for <a href="../../rhino/shell/browser/api.html"><code>jsh.shell.browser.ProxyConfiguration</code></a></span>
											</div>
										</li>
										<li>
											One of:
											<div class="deprecated">
												For JavaFX browser
												<ul>
													<li class="value">
														<div class="name">zoom</div>
														<span class="type">__TYPE__</span>
														<span>__DESCRIPTION__</span>
													</li>
													<li class="value">
														<div class="name">console</div>
														<span class="type">__TYPE__</span>
														<span>__DESCRIPTION__</span>
													</li>
												</ul>
											</div>
											- OR -
											<div>
												For Google Chrome
												<ul>
													<li class="object">
														<div class="name">chrome</div>
														<span>__DESCRIPTION__</span>
														<div class="label">has properties:</div>
														<ul>
															<li class="value">
																<div class="name">location</div>
																<span class="type">Pathname</span>
																<span>See <a href="../../rhino/shell/browser/api.html">jsh.shell.browser.chrome.Instance</a></span>
															</li>
															<li class="value">
																<div class="name">directory</div>
																<span class="type">directory</span>
																<span>See <a href="../../rhino/shell/browser/api.html">jsh.shell.browser.chrome.Instance</a></span>
															</li>
															<li class="value">
																<div class="name">browser</div>
																<span class="type">boolean</span>
																<span>
																	(optional; <code>false</code> if omitted)
																	If <code>true</code> renders the user interface as a regular web
																	browser (with tabs, address bar, and so forth). Otherwise, runs
																	the browser in "app mode."
																</span>
															</li>
														</ul>
													</li>
												</ul>
											</div>
											<!--	TODO	create is undocumented	-->
											<!--	TODO	run is undocumented	-->
										</li>
									</ul>
								</li>
								<li class="value">
									<div class="name">path</div>
									<span class="type">string</span>
									<span>The relative path of the page to open.</span>
								</li>
							</ul>
						</li>
					</ol>
				</div>
				<div class="returns">
					<div class="label">Returns</div>
					<span class="type">object</span>
					<span>
						An object describing the application.
					</span>
					<div class="label">has properties:</div>
					<ul>
						<li class="value">
							<div class="name">port</div>
							<span class="type">number</span>
							<span>The port number on which the application is running.</span>
						</li>
						<li class="value">
							<div class="name">server</div>
							<span class="type">__TYPE__</span>
							<span>__DESCRIPTION__</span>
						</li>
						<li class="value">
							<div class="name">browser</div>
							<span class="type">__TYPE__</span>
							<span>__DESCRIPTION__</span>
						</li>
					</ul>
				</div>
				<script type="application/x.jsapi#initialize">
					scope.api = $jsapi.loader.module("application.js");
				</script>
				<script type="application/x.jsapi#tests"><![CDATA[
					verify("hello").is("hello");

					var singleRequestApplication = function(decorator) {
						var firstRequest;
						var slock = new jsh.java.Thread.Monitor();

						var argument = new function() {
							this.servlet = {
								load: function(scope) {
									scope.$exports.handle = function(request) {
										new slock.Waiter({
											until: function() {
												return true;
											},
											then: function() {
												if (!firstRequest) firstRequest = request;
											}
										})();
									}
								}
							};

							this.on = {
								close: function() {
									jsh.shell.console("Closed browser.");
								}
							};

							this.browser = {
								chrome: {}
							};
						};

						if (decorator) decorator.call(argument);

						var application = api.Application(argument);

						new slock.Waiter({
							until: function() {
								return firstRequest;
							},
							then: function() {
								application.browser.close();
								application.server.stop();
							}
						})();

						return {
							application: application,
							request: firstRequest
						}
					};

					var getHeader = function(name) {
						return function() {
							for (var i=0; i<this.headers.length; i++) {
								if (this.headers[i].name.toLowerCase() == name) {
									return this.headers[i].value;
								}
							}
							return null;
						}
					};

					var first = singleRequestApplication();
					verify(first).request.method.is("GET");
					verify(first).request.path.is("");
					verify(first).request.evaluate(getHeader("host")).is("127.0.0.1:" + first.application.server.port);

					var second = singleRequestApplication(function() {
						this.browser.host = "x";
					});
					verify(second).request.method.is("GET");
					verify(second).request.path.is("");
					verify(second).request.evaluate(getHeader("host")).is("x");

					var invoked = false;
					var third = singleRequestApplication(function() {
						this.browser.proxy = function(server) {
							invoked = true;
							return { port: server.port };
						}
					});
					verify(invoked).is(true);
				]]></script>
			</li>
		</ul>
	</div>
</body>
</html>