<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

The Original Code is the rhino/shell SLIME module.

The Initial Developer of the Original Code is David P. Caldwell <david@davidpcaldwell.com>.
Portions created by the Initial Developer are Copyright (C) 2010-2013 the Initial Developer. All Rights Reserved.

Contributor(s):
END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3c.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>Rhino-based interaction with shell</title>
	<link rel="stylesheet" type="text/css" href="../../loader/api/api.css"></link>
	<script type="text/javascript" src="../../loader/api/api.js"></script>
</head>
<body>
	<div>
		<h1>Context</h1>
		<script type="application/x.jsapi#context">
			new function() {
				this.api = {
					java: $jsapi.module("../../rhino/host/")
				}
			}
		</script>
		<ul>
			<li class="object">
				<div class="name">api</div>
				<div class="label">has properties:</div>
				<ul>
					<li class="value">
						<div class="name">java</div>
						<span>The <a href="../host/api.html">rhino/host</a> module.</span>
					</li>
				</ul>
			</li>
			<li class="value">
				<div class="name">_environment</div>
				<span class="type">Packages.java.util.Map</span>
				<span>
					(optional)
					A native Java object consisting of a <code>Map&lt;String,String></code> representing the environment variables
					to use for this shell. If not provided, the environment provided by <code>Packages.java.lang.System.getenv()</code>
					will be used.
				</span>
			</li>
		</ul>
	</div>
	<div>
		<h1>Exports</h1>
		<ul>
			<li class="function">
				<div class="name">run</div>
				<div>Launches a subprocess using the operating system.</div>
				<div class="arguments">
					<div class="label">Arguments</div>
					<div class="type">
						<a class="type" name="types.token">token</a>
						<span>
							A value that can be used as a command token. If the value is a string, it will be used as-is. If it is an object, it will be coerced
							to string using the String global function. Otherwise, a TypeError will be thrown.
						</span>
					</div>
					<ol>
						<li class="object">
							<div class="label">has properties:</div>
							<ul>
								<li class="value">
									<div class="name">command</div>
									<span class="type"><a href="#types.token">token</a></span>
									<span>The command to pass to the underlying operating system.</span>
								</li>
								<li class="value">
									<div class="name">arguments</div>
									<span class="type">Array of <a href="#types.token">token</a></span>
									<span>The command arguments to pass to the underlying operating system.</span>
								</li>
								<li class="value" jsapi:id="run.stdin">
									<div class="name">stdin</div>
									<span class="type"><a href="../io/api.html#types.binput">byte input stream</a></span>
									<span>A stream which will be attached to the subprocess as its standard input stream.</span>
								</li>
								<li class="value" jsapi:id="run.stdout">
									<div class="name">stdout</div>
									<span class="type"><a href="../io/api.html#types.boutput">byte output stream</a></span>
									<span>A stream which will be attached to the subprocess as its standard output stream.</span>
								</li>
								<li class="value" jsapi:id="run.stderr">
									<div class="name">stderr</div>
									<span class="type"><a href="../io/api.html#types.boutput">byte output stream</a></span>
									<span>A stream which will be attached to the subprocess as its standard error stream.</span>
								</li>
								<li class="value" jsapi:id="run.environment">
									<div class="name">environment</div>
									<span class="type">object</span>
									<span>
										(optional)
										A set of names and values that will be passed to the subprocess as its environment.
										<!--
											TODO	how are non-string property values handled?
										-->
										If <code>null</code> or <code>undefined</code>, the environment passed to this module in its context is used.
									</span>
								</li>
								<li class="value" jsapi:id="run.workingDirectory">
									<div class="name">workingDirectory</div>
									<span class="type"><a href="../file/api.html#types.directory">directory</a></span>
									<span>
										(optional)
										The working directory to use for the subprocess. If not specified, the working directory
										of the parent process will be used.
									</span>
									<!--
										TODO	if this property is null, we should error, assuming the caller made a mistake
										passing a non-existent directory.
									-->
								</li>
								<li class="function" jsapi:id="run.evaluate">
									<div class="name"><a name="run.evaluate">evaluate</a></div>
									<div>
										A function that will be invoked when the subprocess terminates, will be provided with
										information about the result, and specifies the return value of <code>run</code>.
									</div>
									<div>
										If this property is omitted, a default will be used that throws an exception if the
										exit status of the subprocess is not zero or the subprocess cannot be launched, and returns
										its argument.
									</div>
									<div class="arguments">
										<div class="label">Arguments</div>
										<ol>
											<li class="object">
												<div class="label">has properties:</div>
												<ul>
													<li class="value">
														<div class="name">status</div>
														<span class="type">number</span>
														<span>The exit status of the subprocess, if it was launched successfully.</span>
													</li>
													<li class="value">
														<div class="name">error</div>
														<span class="type">JavaClass java.lang.Throwable</span>
														<span>The <code>java.lang.Throwable</code> that was thrown by the Java
														virtual machine when attempting to execute the subprocess, if it was not
														successfully launched.</span>
													</li>
													<li class="value">
														<div class="name">command</div>
														<span>The program that was run.</span>
													</li>
													<li class="value">
														<div class="name">arguments</div>
														<span class="type">Array</span>
														<span>The arguments that were passed to the program.</span>
													</li>
													<li class="value">
														<div class="name">environment</div>
														<span class="type">object</span>
														<span>
															(optional)
															The environment that was passed to the program, if any.
														</span>
													</li>
													<li class="value">
														<div class="name">workingDirectory</div>
														<span>
															(optional)
															The working directory that was specified for running the
															program, if any.
														</span>
													</li>
												</ul>
											</li>
										</ol>
									</div>
									<div class="returns">
										<div class="label">Returns</div>
										<span class="type">(any)</span>
										<span>An arbitrary value to return as the return value of <code>run</code>.</span>
									</div>
								</li>
							</ul>
						</li>
					</ol>
				</div>
				<div class="returns">
					<div class="label">Returns</div>
					<span class="type">(any)</span>
					<span>
						The value returned by the function given as the <code>evaluate</code> property of the argument, or
						by the default implementation of <code>evaluate</code>.
					</span>
				</div>
			</li>
			<li class="value" jsapi:id="environment">
				<div class="name">environment</div>
				<span class="type">object</span>
				<span>
					An object describing the operating system process environment under which this script was executed. Each
					variable defined in the environment is represented as a property in this object, with its name being the name
					of the property and its value being the value of that property. This object uses JavaScript semantics, and
					thus this object has case-sensitive names. In the event that the underlying operating system has
					environment variables that are <em>not</em> case-sensitive, all properties of this object will have
					UPPERCASE names.
				</span>
				<script type="application/x.jsapi#tests">
					scenario( new function() {
						this.name = "System environment";

						this.execute = function(scope) {
							var environment = module.environment;

							scope.test( typeof(environment.PATH) != "undefined" );
							scope.test( typeof(environment.ZZFF) == "undefined" );
						}
					} );
				</script>
			</li>
			<li class="value" jsapi:id="properties">
				<div class="name">properties</div>
				<span>
					<b>(experimental)</b>
					An object that attempts to allow the use of JavaScript semantics to access Java system properties. For example,
					the <code>java.home</code> system property is referenced as <code>properties.java.home</code>. This value can be
					examined using <code>String(properties.java.home)</code> to obtain its value as a <code>string</code>.
				</span>
			</li>
		</ul>
	</div>
	<script type="application/x.jsapi#tests">
	scenario( new function() {
		this.name = "System properties";

		var properties = module.properties;

		this.initialize = function() {
			properties.foo = "bar";
			properties.foo.bar = "baz";

			properties.composite = {
				david: "caldwell",
				katie: "alex",
				home: "/home/inonit",
			}
		}

		this.execute = function(scope) {
			scope.test(properties.foo == "bar");
			scope.test(properties.foo.bar == "baz");

			scope.test( String(properties.java) == "null" );
			scope.test( String(properties.java.version) != "null" );
			scope.test( typeof(properties.java.version) == "object" );

			scope.test( String(properties.composite.david) == "caldwell" );
			scope.test( String(properties.composite.david).substring(1,4) == "ald" );

			scope.test( String(properties.blah) == "undefined" );

			var explore = function() {
				var list = function(prefix,p) {
					for (var x in p) {
						if (p[x]) {
							Packages.java.lang.System.err.println(prefix+x + "=" + p[x]);
						}
						list(prefix+x+".",p[x]);
					}
				}

				Packages.java.lang.System.err.println("BEFORE:");
				list("",properties);

				Packages.java.lang.System.err.println("AFTER:");
				delete properties.foo;
				list("",properties);

				Packages.java.lang.System.err.println("JAVA:");
				list("",properties.java);
			}
			//	explore();
		}
	} );
	</script>
</body>
</html>