<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
	<head>
		<title>SLIME Promises</title>
		<link href="../../loader/api/api.css" rel="stylesheet" type="text/css" />
		<script src="../../loader/api/api.js"></script>
		<script>
			//	TODO	CORS
			document.domain = document.domain;
		</script>
	</head>
	<body>
		<script type="application/x.jsapi#initialize">
			var unit = $jsapi.loader.file("../../loader/api/unit.js", {
				api: {
					Promise: window.Promise
				},
				log: function() {
					window.console.log.apply(window.console,arguments);
				}
			});
			
			scope.unit = unit;
			
			var browser = $jsapi.loader.module("../../loader/browser/test/module.js", {
				api: {
					unit: unit,
					Promise: window.Promise
				}
			});
			
			scope.browser = browser;
			
			scope.api = $jsapi.loader.file("module.js", {
				asynchrony: function() {
					return window.XMLHttpRequest.asynchrony;
				},
				Promise: window.Promise
			});
		</script>
		<script type="application/x.jsapi#tests">
			verify(api).evaluate.property("Promise").is.type("function");
			verify(window).evaluate(function() { return this.XMLHttpRequest.asynchrony; }).is.type("object");
			verify(window).evaluate(function() { return this.XMLHttpRequest.asynchrony.started; }).is.type("function");
			verify(window).evaluate(function() { return this.XMLHttpRequest.asynchrony.finished; }).is.type("function");
			
			//	TODO	get this to true
			var PROMISES_IN_TESTS_ALLOWED = false;

			var first = new browser.Scenario();
			
			first.test(new function() {
				var result;
				
				this.before = function(verify) {
					verify("before").is("before");
				};
				
				this.run = function() {
					if (PROMISES_IN_TESTS_ALLOWED) {
						//	TODO	even executing this code causes the .after method to execute after the suite represented
						//			by the enclosing <script> block has finished.
						debugger;
						new api.Promise(function(resolve,reject) {
							resolve(42);
						}).then(function(n) {
							result = n;
						});
					}					
				}
				
				this.after = function(verify) {
					verify("after").is("after");
					if (PROMISES_IN_TESTS_ALLOWED) {
						verify(result).is(42);
					}
				}
			});
			
			var suite = new unit.Suite({
				parts: {
					first: first,
					inline: {
						execute: function(scope,verify) {
							verify(1).is(1);
						}
					}
				}
			});

			browser.suite(suite);
			browser.promise({
				event: function(e) {
					console.log("promise event", e);
					verify.scope.fire(e.type,e.detail);
				},
				end: function(v) {
					console.log("promise end", v);
				}
			}).then(function(result) {
			});
		</script>
		<script type="application/javascript">
		</script>
		<div>__DESCRIPTION__</div>
		<div>
			<h1>Context</h1>
			<div class="type">
				<a class="type" name="types.asynchrony">asynchrony</a>
				<span>
					A type that allows this module to hook into an asynchronous processing monitor. For example, the SLIME
					browser loader allows HTTP testing with asynchronous calls; that testing framework requires that asynchronous
					code notify it of the start and end of asynchronous processes.
				</span>
				<div class="label">has properties:</div>
				<ul>
					<li class="function">
						<div class="name">started</div>
						<span>__DESCRIPTION__</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
								<li class="value">
									<span class="type">__TYPE__</span>
									<span>__DESCRIPTION__</span>
								</li>
							</ol>
						</div>
					</li>
					<li class="function">
						<div class="name">finished</div>
						<span>__DESCRIPTION__</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
								<li class="value">
									<span class="type">__TYPE__</span>
									<span>__DESCRIPTION__</span>
								</li>
							</ol>
						</div>
					</li>
				</ul>
			</div>

			<ul>
				<li class="value">
					<div class="name">Promise</div>
					<span class="type">function</span>
					<span>A constructor that can create an A+-compliant Promise.</span>
				</li>
				<li class="function">
					<div class="name">asynchrony</div>
					<div class="returns">
						<div class="label">Returns</div>
						<span class="type"><a href="#types.asynchrony">asynchrony</a></span>
					</div>
				</li>
			</ul>
		</div>
		<div>
			<h1>Exports</h1>
			<ul>
			</ul>
		</div>
	</body>
</html>