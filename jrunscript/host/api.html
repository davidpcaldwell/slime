<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>Java host objects</title>
	<link rel="stylesheet" type="text/css" href="../../loader/api/api.css"></link>
	<script type="text/javascript" src="../../loader/api/api.js"></script>
</head>
<body>
	<script type="application/x.jsapi#initialize"><![CDATA[
		scope.module = $jsapi.environment.module;
		if (!scope.module) {
			//	Compatibility with old test structure
			scope.module = $jsapi.loader.module("module.js", { $slime: jsh.unit.$slime });
		}
		//	'isRhino' seems to be used in the invoked files
		scope.isRhino = typeof(Packages.org.mozilla.javascript.Context) == "function"
			&& (Packages.org.mozilla.javascript.Context.getCurrentContext() != null);
		//	'api' seems to be used in the invoked files
		scope.api = { java: scope.module };
	]]></script>
	<div>
		<h1>Context</h1>
		<ul>
			<li class="value">
				<div class="name">globals</div>
				<!--	<span class="type"></span>	-->
				<span>If <code>true</code>, this module modifies global JavaScript objects.</span>
			</li>
		</ul>
	</div>
	<div>
		<h1>Exports</h1>
		<ul>
			<li class="object">
				<div class="name">Thread</div>
				<div class="label">has properties:</div>
				<ul>
					<li class="function">
						<div class="name">run</div>
						<span>Runs a function in a separate thread, but blocks the calling thread until the function completes or times out.</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
								<li class="object">
									<span>__DESCRIPTION__</span>
									<div class="label">has properties:</div>
									<ul>
										<li class="function">
											<div class="name">call</div>
											<span>__DESCRIPTION__</span>
										</li>
										<li class="value">
											<div class="name">timeout</div>
											<span class="type">number</span>
											<span>
												(optional)
												A timeout, in milliseconds.
											</span>
										</li>
									</ul>
								</li>
							</ol>
						</div>
						<div class="returns">
							<div class="label">Returns</div>
							<span>The value returned by the underlying function specified by <code>call</code>.</span>
						</div>
					</li>
					<li class="constructor">
						<div class="name">Monitor</div>
						<span>Represents a Java monitor that can be used for synchronization.</span>
						<div class="instances">
							<div class="label">Instances</div>
							<div class="label">has properties:</div>
							<ul>
								<li class="constructor">
									<div class="name">Waiter</div>
									<span>
										Creates a function that waits on its parent monitor until a condition is true, and then executes an underlying
										function.
									</span>
									<div class="arguments">
										<div class="label">Arguments</div>
										<ol>
											<li class="object">
												<span>An object specifying the condition and function.</span>
												<div class="label">has properties:</div>
												<ul>
													<li class="function">
														<div class="name">until</div>
														<span>
															(optional; default returns <code>true</code>)
															A function that specifies whether the condition has been satisfied. The function will receive
															the <code>this</code> and arguments passed to the function by the caller.
														</span>
														<div class="returns">
															<div class="label">Returns</div>
															<span class="type">boolean</span>
															<span><code>true</code> indicating the condition has been satisfied; <code>false</code> indicating it has not.</span>
														</div>
													</li>
													<li class="function">
														<div class="name">then</div>
														<span>
															(optional; default does nothing)
															A function to execute when the condition has been satisfied. The function will receive the
															<code>this</code> and arguments passed to the function by the caller, and can return any value
															intended to be returned to the caller.
														</span>
													</li>
												</ul>
											</li>
										</ol>
									</div>
									<div class="instances">
										<div class="label">Instances</div>
										<span class="type">function</span>
										<span>
											A function that can be invoked that will invoke <code>until</code> repeatedly and wait on the monitor if it
											returns <code>false</code>; when <code>until</code> returns <code>true</code>, <code>then</code> will be invoked
											and the return value from <code>then</code> returned.
										</span>
									</div>
								</li>
							</ul>
						</div>
						<script type="application/x.jsapi#tests" jsapi:id="Monitor"><![CDATA[
							if (module.Thread) {
								var lock = new module.Thread.Monitor();

								var count = 0;

								var waiter = function() {
									return new lock.Waiter({
										//	TODO	make optional in API with this default implementation
										until: function() {
											return true;
										},
										then: function() {
											test(count == 0);
											count++;
											test(count == 1);
											Packages.java.lang.Thread.sleep(Packages.java.lang.Math.random() * 100);
											count--;
											test(count == 0);
	//											jsh.shell.echo("Success.");
										}
									});
								}

								var waiters = [];
								for (var i=0; i<10; i++) {
									waiters.push(waiter());
								}

								var joiners = [];
								waiters.forEach(function(element) {
									//	jsh.shell.echo("Starting ...");
									var t = module.Thread.start({
										call: element,
										on: {
											result: function(o) {
												//	jsh.shell.echo("Finished.");
												test(true);
											},
											error: function(t) {
												//	jsh.shell.echo("Threw.");
												throw t;
											}
										}
									});
									joiners.push(t);
								});

								joiners.forEach(function(t) {
									t.join();
								});
							}
						]]></script>
					</li>
					<li class="function">
						<div class="name">thisSynchronize</div>
						<span>
							Creates a function whose execution synchronizes on the <code>this</code> object of its invocation.
						</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
								<li class="value">
									<span class="type">function</span>
									<span>A function which the returned function should execute.</span>
								</li>
							</ol>
						</div>
						<div class="returns">
							<div class="label">Returns</div>
							<span class="type">function</span>
							<span>
								A function that obtains the lock to its <code>this</code> object, executes the given function, and
								then releases the lock.
							</span>
						</div>
						<script type="application/x.jsapi#tests" jsapi:id="thisSynchronize"><![CDATA[
							if (module.Thread) {
								var f = function(x) {
									return 2*x;
								};

								var s = module.Thread.thisSynchronize(f);

								//	TODO	actually test synchronization

								test(s(2) == 4);
								test(s(4) == 8);

								var debug = function(s) {
		//								Packages.java.lang.System.err.println(s);
								}

								var lock = new Packages.java.lang.Object();

								var finished = 0;

								var inner = function() {
									inner.count++;
									Packages.java.lang.Thread.sleep(100);
									inner.count--;
									finished++;
									this.notifyAll();
								}
								inner.count = 0;

								var nested = module.Thread.thisSynchronize(inner);

								var outer = function() {
									outer.count++;
									nested.call(lock);
									outer.count--;
								}
								outer.count = 0;

								var getCount = module.Thread.thisSynchronize(function() {
									return inner.count;
								});

								var threads = [];
								for (var i=0; i<10; i++) {
									threads.push(module.Thread.start({
										call: outer,
										on: new function() {
											this.returned = function(rv) {
												debug("outer = " + outer.count);
												test(getCount.call(lock) == 0);
											}

											this.threw = function(e) {
												debug("threw = " + e);
												throw e;
											}
										}
									}));
								}

								threads.forEach( function(thread) {
									thread.join();
								});

								test(finished == 10);
							}
						]]></script>
					</li>
					<li class="constructor" jsapi:id="Task">
						<div class="name">Task</div>
						<span>__DESCRIPTION__</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
							</ol>
						</div>
						<div class="instances">
							<div class="label">Instances</div>
							<span class="type">__TYPE__</span>
							<span>__DESCRIPTION__</span>
						</div>
						<script type="application/x.jsapi#tests">
							var monitor = new module.Thread.Monitor();
							var task = new module.Thread.Task({
								call: function() {
									return 2*2;
								}
							});
							var events = [];
							var finished;
							task(function(error,returned) {
								monitor.Waiter({
									until: function() {
										return true;
									},
									then: function() {
										events.push(function() {
											finished = returned;
										})
									}
								})();
							});
							while(!finished) {
								monitor.Waiter({
									until: function() {
										return events.length;
									},
									then: function() {
										events.shift()();
									}
								})();
							}
							verify(finished).is(4);
						</script>
						<script type="application/x.jsapi#initialize">
							var module = scope.module;
							var $$api;
							$jsapi.loader.eval("../../loader/$api.js", {
								$slime: {
									getRuntimeScript: function(path) {
										return {
											name: path,
											js: $jsapi.loader.string("../../loader/" + path)
										}
									}
								},
								//	TODO	dubious; relies on $engine/$platform compatibility
								$engine: $platform,
								$export: function(value) {
									$$api = value;
								}
							});
							scope.$$api = $$api;

							var monitor = new module.Thread.Monitor();

							scope.monitor = monitor;

							var Multithreaded = function(step) {
								var Event = function(f) {
									return function(error,returned) {
										monitor.Waiter({
											until: function() {
												return true;
											},
											then: function() {
												f();
											}
										})();
									}
								};

								return {
									toString: function() {
										return step.toString();
									},
									ready: function() {
										return step.ready();
									},
									task: new module.Thread.Task({
										call: Event(step.call)
									})
								};
							}

							scope.A = function(shared) {
								return new Multithreaded({
									ready: function() {
										return true;
									},
									call: function() {
										shared.a = true;
									}
								});
							};
							scope.B = function(shared) {
								return new Multithreaded({
									ready: function() {
										return shared.a;
									},
									call: function() {
										shared.b = true;
									}
								});
							};
							scope.C = function(shared) {
								return new Multithreaded({
									toString: function() {
										return "C";
									},
									ready: function() {
										return false;
									},
									call: function() {
										throw new Error();
									}
								});
							};
						</script>
						<script type="application/x.jsapi#tests">
							Packages.java.lang.System.err.println("Second test.");
							var Steps = function() {
								var shared = { a: false, b: false };

								this.shared = shared;
								this.c = new C(shared);

								this.steps = [new A(shared), new B(shared), this.c];

								var unready = [];

								this.unready = unready;

								this.on = {
									unready: function(e) {
										unready.push(e.detail);
									}
								}
							};

							var steps = new Steps();

							var task = $$api.threads.steps.Task(steps);

							var finished = false;

							task(monitor.Waiter({
								until: function() {
									return true;
								},
								then: function() {
									finished = true;
								}
							}));

							monitor.Waiter({
								until: function() {
									return finished;
								},
								then: function() {
								}
							})();

							verify(steps).shared.a.is(true);
							verify(steps).shared.b.is(true);
							verify(steps).unready.length.is(1);
							//	TODO	verify(unready[0]).ready.is(steps.c.ready) does not work because ready property of the
							//			verify object does not have is() method. Probably addressable in unit test framework.
							verify(steps).unready[0].is(steps.c);

							var ssteps = new Steps();
							verify(ssteps).shared.a.is(false);

							var stask = $$api.threads.steps.Task(ssteps);

							stask();

							verify(ssteps).shared.a.is(true);
							verify(ssteps).shared.b.is(true);
							verify(ssteps).unready.length.is(1);
							if (ssteps.unready.length) {
								verify(ssteps).unready[0].is(ssteps.c);
							}
						</script>
					</li>
					<li class="function">
						<div class="name">map</div>
						<span>__DESCRIPTION__</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
							</ol>
						</div>
						<div class="returns">
							<div class="label">Returns</div>
							<span class="type">__TYPE__</span>
							<span>__DESCRIPTION__</span>
						</div>
						<script type="application/x.jsapi#tests">
							var array = [1,2,3];
							var doubled = module.Thread.map(array,function(element) {
								return element * 2;
							},null,{
								limit: 2,
								callback: function(result) {
									if (result.threw) {
										jsh.shell.console(result.index + "/" + result.threw.type + ": " + result.threw.message);
										jsh.shell.console(result.stack);
									} else {
										jsh.shell.console(result.index + "/" + result.returned);
									}
								}
							});
							verify(doubled)[0].is(2);
							verify(doubled)[1].is(4);
							verify(doubled)[2].is(6);
						</script>
					</li>
					<li class="function">
						<div class="name">forkJoin</div>
						<span>__DESCRIPTION__</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
							</ol>
						</div>
						<div class="returns">
							<div class="label">Returns</div>
							<span class="type">__TYPE__</span>
							<span>__DESCRIPTION__</span>
						</div>
						<script type="application/x.jsapi#tests">
							var fork = [
								(function() { return 1; }),
								(function() { return 3; }),
								(function() { return 2; })
							];
							var result = module.Thread.forkJoin(fork);
							verify(result).length.is(3);
							verify(result)[0].is(1);
							verify(result)[1].is(3);
							verify(result)[2].is(2);
						</script>
					</li>
				</ul>
				<script type="application/x.jsapi#tests">
					if (module.Thread) {
						var sleeper = function(length) {
							return function() {
								Packages.java.lang.Thread.sleep(length);
							}
						}

						var f = function() {
							Packages.java.lang.Thread.sleep(100);
							return 1;
						};

						var Callbacks = function() {
							var result;

							this.result = function(v) {
								result = v;
							};

							this.error = function(t) {
								throw t;
							};

							this.timeout = function() {
								result = "Timed out.";
							}

							this.evaluate = function() {
								return result;
							};

							this.getResult = function() {
								return result;
							}
						};

						var c1 = new Callbacks();
						var t1 = module.Thread.start({
							call: f,
							timeout: 150,
							on: c1
						});
						t1.join();
						test(c1.evaluate() == 1);

						//	This test is highly suspect; it essentially hopes that the CPU scheduling happens as expected. Its
						//	chances of passage could be improved by using thread priorities for timeouts, which is probably a good
						//	idea anyway. But perhaps it needs to be re-designed.
						var c2 = new Callbacks();
						var t2 = module.Thread.start({
							call: sleeper(250),
							timeout: 50,
							on: c2
						});
						t2.join();
						verify(c2).getResult().is("Timed out.");

						var r3 = module.Thread.run({
							call: f,
							timeout: 150
						});
						test(r3 == 1);
						try {
							var r4 = module.Thread.run({
								call: sleeper(250),
								timeout: 50
							});
							test(false);
						} catch (e) {
							test(e == module.Thread.run.TIMED_OUT);
						}
					}
				</script>
			</li>
			<!--
				Experimental methods

				fail(): no real specification, no unit tests

				$doc.members.isJavaType = new $Doc.Function({
					summary: "Determines whether a value is a Java host object representing the given type or not.",
					asFunction: {
						description: <>Creates a function which can determines whether a value is a Java object of the given type or not</>,
						arguments: {
							list: [
								{ type: "JavaClass", comment: <>A Rhino <code>JavaClass</code> object, like <code>Packages.java.lang.Object</code></> }
							]
						},
						returns: {
							type: "function",
							comment: <>Returns a function which takes a single argument and returns <code>true</code> if the given argument is an object of the given Java type and <code>false</code> if it is not.</>
						}
					}
				});
			-->
			<!--
				//	No unit tests!
				$doc.members.toJavaArray = new $Doc.Function({
					summary: <>Converts an ECMAScript array into a Java array</>,
					asFunction: {
						description: <>Converts an ECMAScript array into a Java array</>,
						arguments: {
							list: [
								{ type: <><code>Array</code></>, comment: <>An array to be converted</> },
								{
									type: <>A Java class reference</>,
									comment: <>A reference to a Java class, e.g., <code>Packages.java.lang.Object</code>, representing the type of
										the array to create</>
								}
							]
						},
						returns: {
							type: "A Java array",
							comment: <>A Java array containing the elements in the ECMAScript array.</>
						}
					}
				});
			-->
		</ul>
	</div>
</body>
</html>
