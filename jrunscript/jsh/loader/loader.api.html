<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>jsh loader</title>
	<link rel="stylesheet" type="text/css" href="../../loader/api/api.css" />
	<script type="text/javascript" src="../../loader/api/api.js"></script>
</head>
<body>
	<div>
		<h1>Exports</h1>
		<script type="application/x.jsapi#initialize">
			scope.loadTestModule = function(path,context) {
				return $jsapi.loader.module("../../loader/" + path, context);
			}
		</script>
		<ul>
			<li class="object">
				<div class="name">java</div>
				<span>The Java code available to the script.</span>
				<div class="label">has properties:</div>
				<ul>
					<li class="function">
						<div class="name">add</div>
						<!--	TODO	should accept a file or directory as well, and probably should ignore null	-->
						<!--
								TODO	write tests: need to be able to compile Java classes and add them to the classpath. They
										probably must be jsh/test tests. Also we need to test whether the Packages variable still
										behaves "incorrectly," i.e., caches failed lookups, preventing new classes from being found
										once they've been sought.
						-->
						<span>Adds a directory or JAR file to the Java classpath of this script.</span>
						<div class="arguments">
							<div class="label">Arguments</div>
							<ol>
								<li class="value">
									<span class="type"><a href="../../rhino/file/api.html#types.Pathname">Pathname</a></span>
									<span>
										A <code>jsh.file.Pathname</code> pointing to a directory or a JAR file containing Java
										classes.
									</span>
								</li>
							</ol>
						</div>
						<!-- TODO: cannot target this test from command line for some reason -->
						<div jsapi:id="java.add">
							<script type="application/x.jsapi#initialize">
								scope.compileAddClasses = $api.fp.impure.Input.memoized(function() {
									var classes = jsh.shell.TMPDIR.createTemporary({ directory: true });
									jsh.shell.console("Compiling AddClasses ...");
									jsh.java.tools.javac({
										destination: classes.pathname,
										sourcepath: jsh.file.Searchpath([$jsapi.environment.jsh.unbuilt.src.getRelativePath("jrunscript/jsh/loader/test/addClasses/java")]),
										arguments: [$jsapi.environment.jsh.unbuilt.src.getRelativePath("jrunscript/jsh/loader/test/addClasses/java/test/AddClasses.java")]
									});
									return classes;
								});
							</script>
							<script type="application/x.jsapi#tests" jsapi:id="addClasses">
								var result = jsh.shell.jsh({
									shell: $jsapi.environment.jsh.built.home,
									script: $jsapi.environment.jsh.unbuilt.src.getFile("jrunscript/jsh/loader/test/addClasses/addClasses.jsh.js"),
									arguments: ["-scenario"]
								});
								verify(result).status.is(0);
							</script>
							<script type="application/x.jsapi#tests" jsapi:id="jsh.loader.java">
								var result = jsh.shell.jsh({
									shell: $jsapi.environment.jsh.built.home,
									script: $jsapi.environment.jsh.unbuilt.src.getFile("jrunscript/jsh/loader/test/addClasses/addClasses.jsh.js"),
									arguments: ["-classes",compileAddClasses()]
								});
								verify(result).status.is(0);
							</script>
							<script type="application/x.jsapi#tests" jsapi:id="packaged">
								// TODO: is Rhino a part of
								var result = jsh.shell.jsh({
									shell: $jsapi.environment.jsh.built.home,
									script: $jsapi.environment.jsh.src.getFile("jrunscript/jsh/loader/test/packaged/suite.jsh.js"),
									arguments: ["-classes",compileAddClasses()]
								});
								verify(result).status.is(0);
							</script>
						</div>
					</li>
				</ul>
			</li>
			<li class="function">
				<div class="name">plugins</div>
				<span>Loads <code>jsh</code> <a href="plugin.api.html">plugins</a> from a specified source.</span>
				<div class="arguments">
					<div class="label">Arguments</div>
					<ol>
						<li class="value">
							<span class="type"><a href="../../rhino/file/api.html#types.Pathname">Pathname</a></span>
							-or-
							<span class="type"><a href="../../rhino/file/api.html#types.Directory">directory</a></span>
							-or-
							<span class="type"><a href="../../loader/api.html#types.Loader">Loader</a></span>
							<div>
								A source, interpreted
								as follows:
								<ul>
									<li>
										If the pathname does not represent a directory or file which exists, do nothing.
									</li>
									<li>
										If a directory, or a pathname which is a directory, is specified,
										<ul>
											<li>
												and the directory has a <code>plugin.jsh.js</code> file, load the
												plugin from the directory.
											</li>
											<li>
												<!--	TODO	figure out what the method really should do; what it does do is
																counterintuitive.
												-->
												otherwise, the behavior is undefined.
											</li>
										</ul>
									</li>
									<li>
										If the pathname is an ordinary file,
										<ul>
											<li>
												and ends in <code>.slime</code>, load the plugin in SLIME format from the
												file.
											</li>
											<li>
												and ends in <code>.jar</code>, load the Java-only plugin.
											</li>
											<li>
												otherwise, do nothing.
											</li>
										</ul>
									</li>
									<li>
										If it is a <code>Loader</code>, plugins are loaded from that Loader.
									</li>
								</ul>
							</div>
						</li>
					</ol>
				</div>
				<script type="application/x.jsapi#tests">
					var global = (function() { return this; })();
					verify(global).evaluate.property("issue249").is(void(0));
					var directory = $jsapi.loader.getRelativePath("test/plugin").directory;
					verify(directory).directory.is(true);
					verify(directory).pathname.is.type("object");
					jsh.loader.plugins(directory);
					verify(global).evaluate.property("issue249").is.type("object");
					delete global.issue249;
				</script>
			</li>
		</ul>
	</div>
</body>
</html>
