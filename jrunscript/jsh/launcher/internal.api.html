<!--
LICENSE
This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not
distributed with this file, You can obtain one at http://mozilla.org/MPL/2.0/.

END LICENSE
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:jsapi="http://www.inonit.com/jsapi">
<head>
	<title>jsh Launcher</title>
	<link rel="stylesheet" type="text/css" href="../../loader/api/api.css" />
	<script type="text/javascript" src="../../loader/api/api.js"></script>
	<style>
		table#settings { border-collapse: collapse; }
		table#settings td { border: 1px solid black; padding: 0.2em 0.5em; }
		table#settings thead td { font-weight: bold; }
	</style>
</head>
<body>
	<div>
		<h1>Tests</h1>
		<div jsapi:id="hello">
			<script type="application/x.jsapi#initialize">
				scope.evaluateJson = function(result) {
					return JSON.parse(result.stdio.output);
				}
			</script>
			<script type="application/x.jsapi#tests" jsapi:id="src">
				var output = jsh.shell.jsh({
					shell: $jsapi.environment.jsh.unbuilt.src,
					script: $jsapi.environment.jsh.src.getFile("jrunscript/jsh/test/jsh-data.jsh.js"),
					stdio: {
						output: String
					},
					evaluate: evaluateJson
				});
				verify(output).evaluate.property("jsh.shell.jsh.src").string.is.type("string");
//				verify(outputLines)[0].is("Completed.");
//				verify(false).is(true);
			</script>
			<script type="application/x.jsapi#tests" jsapi:id="home">
				var outputLines = jsh.shell.jsh({
					shell: $jsapi.environment.jsh.built.home,
					script: $jsapi.environment.jsh.src.getFile("jrunscript/jsh/test/jsh.shell/properties.jsh.js"),
					stdio: {
						output: String
					},
					evaluate: function(result) {
						return result.stdio.output.split("\n");
					}
				});
				verify(outputLines)[0].is("Completed.");
			</script>
			<script type="application/x.jsapi#tests"><![CDATA[
				// TODO: substitute jsh-data.jsh.js here and read some substantive values?
				var BITBUCKET = false;
				if (BITBUCKET && $jsapi.environment.jsh.remote) {
					var remote = $jsapi.environment.jsh.remote;
					if (!remote) throw new Error("No remote shell!");
					var fileTestOutputLines = remote.jsh({
						script: $jsapi.environment.jsh.src.getFile("jrunscript/jsh/test/jsh.shell/properties.jsh.js"),
						stdio: {
							output: String
						},
						evaluate: function(result) {
							return result.stdio.output.split("\n");
						}
					});
					verify(fileTestOutputLines)[0].is("Completed.");
					var urlTestOutputLines = remote.jsh({
						script: remote.url + "jrunscript/jsh/test/jsh.shell/properties.jsh.js",
						stdio: {
							output: String
						},
						evaluate: function(result) {
							return result.stdio.output.split("\n");
						}
					});
					verify(fileTestOutputLines)[0].is("Completed.");
				}
			]]></script>
			<script type="application/x.jsapi#tests" jsapi:id="executable">
				if ($jsapi.environment.jsh.built.home.getFile("jsh")) {
					var evaluate = function(name) {
						return function(result) {
							if (result.status != 0) {
								throw new Error("Status: " + result.status + " output=[" + result.stdio.output + "]");
							}
							if (!result.stdio.output) {
								jsh.shell.console("built = " + $jsapi.environment.jsh.built.home);
								throw new Error(name + " status 0 but empty string emitted");
							} else {
								return JSON.parse(result.stdio.output);
							}
						}
					};

					var output = jsh.shell.run({
						command: $jsapi.environment.jsh.built.home.getFile("jsh"),
						arguments: [$jsapi.environment.jsh.built.home.getFile("src/jrunscript/jsh/test/jsh-data.jsh.js")],
						stdio: {
							output: String
						},
						evaluate: evaluate("built file")
					});
					verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());

					(function absolute() {
						var output = jsh.shell.run({
							command: $jsapi.environment.jsh.built.home.getFile("jsh").toString(),
							arguments: [$jsapi.environment.jsh.built.home.getFile("src/jrunscript/jsh/test/jsh-data.jsh.js")],
							stdio: {
								output: String
							},
							evaluate: evaluate("built string")
						});
						verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());
					})();

					var shellCommand = function(p) {
						var lines = [];
						if (p.directory) {
							lines.push("cd " + p.directory);
						}
						if (p.PATH) {
							lines.push("export PATH=" + p.PATH);
						}
						lines.push(p.command + " " + p.arguments.join(" "));
						var file = jsh.shell.TMPDIR.createTemporary({ suffix: ".bash" });
						file.pathname.write(lines.join("\n"), { append: false });
						//jsh.shell.console(file + "\n" + file.read(String) + "\n\n");
						return jsh.shell.run({
							command: "bash",
							arguments: [file].concat(p.arguments),
							directory: file.parent,
							stdio: {
								output: String
							},
							evaluate: p.evaluate
						});
					};

					(function relative() {
						var basedir = $jsapi.environment.jsh.built.home.pathname.basename;
						var parent = $jsapi.environment.jsh.built.home.parent;

						var output = shellCommand({
							command: basedir + "/" + "jsh",
							arguments: [$jsapi.environment.jsh.built.home.getFile("src/jrunscript/jsh/test/jsh-data.jsh.js")],
							directory: parent,
							stdio: {
								output: String
							},
							PATH: jsh.shell.PATH,
							evaluate: evaluate("relative")
						});
						verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());
					})();

					(function inPath() {
						var directory = $jsapi.environment.jsh.built.home;
						var PATH = jsh.file.Searchpath([directory.pathname].concat(jsh.shell.PATH.pathnames));
						var output = shellCommand({
							command: "jsh",
							PATH: PATH,
							arguments: [$jsapi.environment.jsh.built.home.getFile("src/jrunscript/jsh/test/jsh-data.jsh.js")],
							directory: jsh.shell.HOME,
							stdio: {
								output: String
							},
							evaluate: evaluate("inPath")
						});
						verify(output)["jsh.shell.jsh.home"].string.is($jsapi.environment.jsh.built.home.toString());
					})();
				}
			</script>
		</div>
	</div>
</body>
</html>
